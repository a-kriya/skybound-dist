var lc=Object.defineProperty;var fc=(i,e,t)=>e in i?lc(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var Y=(i,e,t)=>fc(i,typeof e!="symbol"?e+"":e,t);import{L as uc,F as hc,C as _o,S as dc,G as pc,B as ai,a as xt,b as Is,M as lr,P as Nn,c as mc,d as fr,e as _s,f as Ne,V as X,T as gc,N as ur,g as Os,D as Xt,h as rs,i as Oo,Q as yc,j as ut,I as wc,E as Qt,k as xc,l as Qe,m as en,n as $t,o as Fe,A as bc,p as Ec,q as hr,r as Ac,s as Mo,t as St,u as Tc,v as Sc,R as vc,w as dr,x as Pc,O as Ic,y as pr,z as _c,H as Oc,W as Mc,J as Cc,K as Rc,U as Dc,X as Bc}from"./three-DGSJdzRU.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&n(a)}).observe(document,{childList:!0,subtree:!0});function t(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(s){if(s.ep)return;s.ep=!0;const o=t(s);fetch(s.href,o)}})();var An=function(){var i=0,e=document.createElement("div");e.style.cssText="position:fixed;top:0;left:0;cursor:pointer;opacity:0.9;z-index:10000",e.addEventListener("click",function(m){m.preventDefault(),n(++i%e.children.length)},!1);function t(m){return e.appendChild(m.dom),m}function n(m){for(var f=0;f<e.children.length;f++)e.children[f].style.display=f===m?"block":"none";i=m}var s=(performance||Date).now(),o=s,a=0,l=t(new An.Panel("FPS","#0ff","#002")),d=t(new An.Panel("MS","#0f0","#020"));if(self.performance&&self.performance.memory)var p=t(new An.Panel("MB","#f08","#201"));return n(0),{REVISION:16,dom:e,addPanel:t,showPanel:n,begin:function(){s=(performance||Date).now()},end:function(){a++;var m=(performance||Date).now();if(d.update(m-s,200),m>=o+1e3&&(l.update(a*1e3/(m-o),100),o=m,a=0,p)){var f=performance.memory;p.update(f.usedJSHeapSize/1048576,f.jsHeapSizeLimit/1048576)}return m},update:function(){s=this.end()},domElement:e,setMode:n}};An.Panel=function(i,e,t){var n=1/0,s=0,o=Math.round,a=o(window.devicePixelRatio||1),l=80*a,d=48*a,p=3*a,m=2*a,f=3*a,h=15*a,g=74*a,E=30*a,A=document.createElement("canvas");A.width=l,A.height=d,A.style.cssText="width:80px;height:48px";var b=A.getContext("2d");return b.font="bold "+9*a+"px Helvetica,Arial,sans-serif",b.textBaseline="top",b.fillStyle=t,b.fillRect(0,0,l,d),b.fillStyle=e,b.fillText(i,p,m),b.fillRect(f,h,g,E),b.fillStyle=t,b.globalAlpha=.9,b.fillRect(f,h,g,E),{dom:A,update:function(S,P){n=Math.min(n,S),s=Math.max(s,S),b.fillStyle=t,b.globalAlpha=1,b.fillRect(0,0,l,h),b.fillStyle=e,b.fillText(o(S)+" "+i+" ("+o(n)+"-"+o(s)+")",p,m),b.drawImage(A,f+a,h,g-a,E,f,h,g-a,E),b.fillRect(f+g-a,h,a,E),b.fillStyle=t,b.globalAlpha=.9,b.fillRect(f+g-a,h,a,o((1-S/P)*E))}}};const $c=/^[og]\s*(.+)?/,Lc=/^mtllib /,Nc=/^usemtl /,kc=/^usemap /,mr=/\s+/,gr=new X,Ms=new X,yr=new X,wr=new X,je=new X,kn=new _o;function Fc(){const i={objects:[],object:{},vertices:[],normals:[],colors:[],uvs:[],materials:{},materialLibraries:[],startObject:function(e,t){if(this.object&&this.object.fromDeclaration===!1){this.object.name=e,this.object.fromDeclaration=t!==!1;return}const n=this.object&&typeof this.object.currentMaterial=="function"?this.object.currentMaterial():void 0;if(this.object&&typeof this.object._finalize=="function"&&this.object._finalize(!0),this.object={name:e||"",fromDeclaration:t!==!1,geometry:{vertices:[],normals:[],colors:[],uvs:[],hasUVIndices:!1},materials:[],smooth:!0,startMaterial:function(s,o){const a=this._finalize(!1);a&&(a.inherited||a.groupCount<=0)&&this.materials.splice(a.index,1);const l={index:this.materials.length,name:s||"",mtllib:Array.isArray(o)&&o.length>0?o[o.length-1]:"",smooth:a!==void 0?a.smooth:this.smooth,groupStart:a!==void 0?a.groupEnd:0,groupEnd:-1,groupCount:-1,inherited:!1,clone:function(d){const p={index:typeof d=="number"?d:this.index,name:this.name,mtllib:this.mtllib,smooth:this.smooth,groupStart:0,groupEnd:-1,groupCount:-1,inherited:!1};return p.clone=this.clone.bind(p),p}};return this.materials.push(l),l},currentMaterial:function(){if(this.materials.length>0)return this.materials[this.materials.length-1]},_finalize:function(s){const o=this.currentMaterial();if(o&&o.groupEnd===-1&&(o.groupEnd=this.geometry.vertices.length/3,o.groupCount=o.groupEnd-o.groupStart,o.inherited=!1),s&&this.materials.length>1)for(let a=this.materials.length-1;a>=0;a--)this.materials[a].groupCount<=0&&this.materials.splice(a,1);return s&&this.materials.length===0&&this.materials.push({name:"",smooth:this.smooth}),o}},n&&n.name&&typeof n.clone=="function"){const s=n.clone(0);s.inherited=!0,this.object.materials.push(s)}this.objects.push(this.object)},finalize:function(){this.object&&typeof this.object._finalize=="function"&&this.object._finalize(!0)},parseVertexIndex:function(e,t){const n=parseInt(e,10);return(n>=0?n-1:n+t/3)*3},parseNormalIndex:function(e,t){const n=parseInt(e,10);return(n>=0?n-1:n+t/3)*3},parseUVIndex:function(e,t){const n=parseInt(e,10);return(n>=0?n-1:n+t/2)*2},addVertex:function(e,t,n){const s=this.vertices,o=this.object.geometry.vertices;o.push(s[e+0],s[e+1],s[e+2]),o.push(s[t+0],s[t+1],s[t+2]),o.push(s[n+0],s[n+1],s[n+2])},addVertexPoint:function(e){const t=this.vertices;this.object.geometry.vertices.push(t[e+0],t[e+1],t[e+2])},addVertexLine:function(e){const t=this.vertices;this.object.geometry.vertices.push(t[e+0],t[e+1],t[e+2])},addNormal:function(e,t,n){const s=this.normals,o=this.object.geometry.normals;o.push(s[e+0],s[e+1],s[e+2]),o.push(s[t+0],s[t+1],s[t+2]),o.push(s[n+0],s[n+1],s[n+2])},addFaceNormal:function(e,t,n){const s=this.vertices,o=this.object.geometry.normals;gr.fromArray(s,e),Ms.fromArray(s,t),yr.fromArray(s,n),je.subVectors(yr,Ms),wr.subVectors(gr,Ms),je.cross(wr),je.normalize(),o.push(je.x,je.y,je.z),o.push(je.x,je.y,je.z),o.push(je.x,je.y,je.z)},addColor:function(e,t,n){const s=this.colors,o=this.object.geometry.colors;s[e]!==void 0&&o.push(s[e+0],s[e+1],s[e+2]),s[t]!==void 0&&o.push(s[t+0],s[t+1],s[t+2]),s[n]!==void 0&&o.push(s[n+0],s[n+1],s[n+2])},addUV:function(e,t,n){const s=this.uvs,o=this.object.geometry.uvs;o.push(s[e+0],s[e+1]),o.push(s[t+0],s[t+1]),o.push(s[n+0],s[n+1])},addDefaultUV:function(){const e=this.object.geometry.uvs;e.push(0,0),e.push(0,0),e.push(0,0)},addUVLine:function(e){const t=this.uvs;this.object.geometry.uvs.push(t[e+0],t[e+1])},addFace:function(e,t,n,s,o,a,l,d,p){const m=this.vertices.length;let f=this.parseVertexIndex(e,m),h=this.parseVertexIndex(t,m),g=this.parseVertexIndex(n,m);if(this.addVertex(f,h,g),this.addColor(f,h,g),l!==void 0&&l!==""){const E=this.normals.length;f=this.parseNormalIndex(l,E),h=this.parseNormalIndex(d,E),g=this.parseNormalIndex(p,E),this.addNormal(f,h,g)}else this.addFaceNormal(f,h,g);if(s!==void 0&&s!==""){const E=this.uvs.length;f=this.parseUVIndex(s,E),h=this.parseUVIndex(o,E),g=this.parseUVIndex(a,E),this.addUV(f,h,g),this.object.geometry.hasUVIndices=!0}else this.addDefaultUV()},addPointGeometry:function(e){this.object.geometry.type="Points";const t=this.vertices.length;for(let n=0,s=e.length;n<s;n++){const o=this.parseVertexIndex(e[n],t);this.addVertexPoint(o),this.addColor(o)}},addLineGeometry:function(e,t){this.object.geometry.type="Line";const n=this.vertices.length,s=this.uvs.length;for(let o=0,a=e.length;o<a;o++)this.addVertexLine(this.parseVertexIndex(e[o],n));for(let o=0,a=t.length;o<a;o++)this.addUVLine(this.parseUVIndex(t[o],s))}};return i.startObject("",!1),i}class jc extends uc{constructor(e){super(e),this.materials=null}load(e,t,n,s){const o=this,a=new hc(this.manager);a.setPath(this.path),a.setRequestHeader(this.requestHeader),a.setWithCredentials(this.withCredentials),a.load(e,function(l){try{t(o.parse(l))}catch(d){s?s(d):console.error(d),o.manager.itemError(e)}},n,s)}setMaterials(e){return this.materials=e,this}parse(e){const t=new Fc;e.indexOf(`\r
`)!==-1&&(e=e.replace(/\r\n/g,`
`)),e.indexOf(`\\
`)!==-1&&(e=e.replace(/\\\n/g,""));const n=e.split(`
`);let s=[];for(let l=0,d=n.length;l<d;l++){const p=n[l].trimStart();if(p.length===0)continue;const m=p.charAt(0);if(m!=="#")if(m==="v"){const f=p.split(mr);switch(f[0]){case"v":t.vertices.push(parseFloat(f[1]),parseFloat(f[2]),parseFloat(f[3])),f.length>=7?(kn.setRGB(parseFloat(f[4]),parseFloat(f[5]),parseFloat(f[6]),dc),t.colors.push(kn.r,kn.g,kn.b)):t.colors.push(void 0,void 0,void 0);break;case"vn":t.normals.push(parseFloat(f[1]),parseFloat(f[2]),parseFloat(f[3]));break;case"vt":t.uvs.push(parseFloat(f[1]),parseFloat(f[2]));break}}else if(m==="f"){const h=p.slice(1).trim().split(mr),g=[];for(let A=0,b=h.length;A<b;A++){const S=h[A];if(S.length>0){const P=S.split("/");g.push(P)}}const E=g[0];for(let A=1,b=g.length-1;A<b;A++){const S=g[A],P=g[A+1];t.addFace(E[0],S[0],P[0],E[1],S[1],P[1],E[2],S[2],P[2])}}else if(m==="l"){const f=p.substring(1).trim().split(" ");let h=[];const g=[];if(p.indexOf("/")===-1)h=f;else for(let E=0,A=f.length;E<A;E++){const b=f[E].split("/");b[0]!==""&&h.push(b[0]),b[1]!==""&&g.push(b[1])}t.addLineGeometry(h,g)}else if(m==="p"){const h=p.slice(1).trim().split(" ");t.addPointGeometry(h)}else if((s=$c.exec(p))!==null){const f=(" "+s[0].slice(1).trim()).slice(1);t.startObject(f)}else if(Nc.test(p))t.object.startMaterial(p.substring(7).trim(),t.materialLibraries);else if(Lc.test(p))t.materialLibraries.push(p.substring(7).trim());else if(kc.test(p))console.warn('THREE.OBJLoader: Rendering identifier "usemap" not supported. Textures must be defined in MTL files.');else if(m==="s"){if(s=p.split(" "),s.length>1){const h=s[1].trim().toLowerCase();t.object.smooth=h!=="0"&&h!=="off"}else t.object.smooth=!0;const f=t.object.currentMaterial();f&&(f.smooth=t.object.smooth)}else{if(p==="\0")continue;console.warn('THREE.OBJLoader: Unexpected line: "'+p+'"')}}t.finalize();const o=new pc;if(o.materialLibraries=[].concat(t.materialLibraries),!(t.objects.length===1&&t.objects[0].geometry.vertices.length===0)===!0)for(let l=0,d=t.objects.length;l<d;l++){const p=t.objects[l],m=p.geometry,f=p.materials,h=m.type==="Line",g=m.type==="Points";let E=!1;if(m.vertices.length===0)continue;const A=new ai;A.setAttribute("position",new xt(m.vertices,3)),m.normals.length>0&&A.setAttribute("normal",new xt(m.normals,3)),m.colors.length>0&&(E=!0,A.setAttribute("color",new xt(m.colors,3))),m.hasUVIndices===!0&&A.setAttribute("uv",new xt(m.uvs,2));const b=[];for(let P=0,M=f.length;P<M;P++){const C=f[P],B=C.name+"_"+C.smooth+"_"+E;let $=t.materials[B];if(this.materials!==null){if($=this.materials.create(C.name),h&&$&&!($ instanceof Is)){const N=new Is;lr.prototype.copy.call(N,$),N.color.copy($.color),$=N}else if(g&&$&&!($ instanceof Nn)){const N=new Nn({size:10,sizeAttenuation:!1});lr.prototype.copy.call(N,$),N.color.copy($.color),N.map=$.map,$=N}}$===void 0&&(h?$=new Is:g?$=new Nn({size:1,sizeAttenuation:!1}):$=new mc,$.name=C.name,$.flatShading=!C.smooth,$.vertexColors=E,t.materials[B]=$),b.push($)}let S;if(b.length>1){for(let P=0,M=f.length;P<M;P++){const C=f[P];A.addGroup(C.groupStart,C.groupCount,P)}h?S=new fr(A,b):g?S=new _s(A,b):S=new Ne(A,b)}else h?S=new fr(A,b[0]):g?S=new _s(A,b[0]):S=new Ne(A,b[0]);S.name=p.name,o.add(S)}else if(t.vertices.length>0){const l=new Nn({size:1,sizeAttenuation:!1}),d=new ai;d.setAttribute("position",new xt(t.vertices,3)),t.colors.length>0&&t.colors[0]!==void 0&&(d.setAttribute("color",new xt(t.colors,3)),l.vertexColors=!0);const p=new _s(d,l);o.add(p)}return o}}const xr=1e3,br=25,ls=1e4,Ye=100,Vc=10,Uc=2.5,Er=1e-4,Ar=1e-4,Tr=1e-4,Cs=.99,zc=1e-4,Hc=8900331,qc=7566195,Wc=6316128,Gc=3904470,Co=14534787,Ro=4749082,Do=7773009,Bo=16777215,Sr=12892835,vr=8297810,Pr=16777184,Jc={lim0:{value:0,color:Co},lim1:{value:10,color:Ro},lim2:{value:100,color:Do},lim3:{value:175,color:Bo}},Ir=5,Kc=100,Yc=200;class Xc{constructor(){Y(this,"objLoader");Y(this,"threeTone");Y(this,"planeMaterial");Y(this,"terrainMaterial");Y(this,"waterMaterial");Y(this,"weaponMaterial");Y(this,"standMaterial");Y(this,"planeMesh");Y(this,"archipelagoBaseGeometry",null);Y(this,"groupTree",[]);Y(this,"groupPalm",[]);Y(this,"weaponModel");this.objLoader=new jc,this.threeTone=new gc().load("/textures/fiveTone.jpg"),this.threeTone.minFilter=ur,this.threeTone.magFilter=ur,this.planeMaterial=new Os({color:Wc,side:Xt}),this.terrainMaterial=new rs({vertexColors:!0,side:Xt,gradientMap:this.threeTone}),this.waterMaterial=new Os({color:Gc,side:Xt,transparent:!0,opacity:.8}),this.weaponMaterial=new Os({color:Pr,emissive:Pr}),this.standMaterial=new rs({color:12566463,gradientMap:this.threeTone}),this.weaponModel=new Ne(new Oo(.1,.1,2),this.weaponMaterial)}createPropMaterial(e){return new rs({color:e,side:Xt,gradientMap:this.threeTone})}load(e,t,n){return new Promise((s,o)=>{this.objLoader.load(e,a=>{a.traverse(l=>{l instanceof Ne&&(l.material=t,l.geometry.computeVertexNormals(!0),l.castShadow=!0)}),a.scale.set(n,n,n),s(a)},a=>{`${e}`,a.loaded/a.total*100},a=>{console.error(`Error loading model from ${e}:`,a),o(new Error(`Failed to load OBJ model from ${e}`))})})}loadGeometry(e){return new Promise((t,n)=>{let s;this.objLoader.load(e,o=>{o.traverse(a=>{a instanceof Ne&&(a.geometry.computeVertexNormals(!0),s=a.geometry)}),s?t({path:e,geometry:s}):(console.error(`No geometry found in loaded mesh from ${e}`),n(new Error(`No geometry found in ${e}`)))},o=>{`${e}`,o.loaded/o.total*100},o=>{console.error(`Error loading geometry from ${e}:`,o),n(new Error(`Failed to load geometry from ${e}`))})})}async gLoad(e){const t=[],n=e.map(async o=>{try{const{geometry:a}=await this.loadGeometry(o.path),l=this.createPropMaterial(o.color);return new Ne(a,l)}catch(a){return console.error(`Failed to load geometry for gLoad: ${o.path}`,a),null}});return(await Promise.all(n)).forEach(o=>{o&&t.push(o)}),t}async loadAllAssets(){try{const e=await this.load("/models/vehicle/airplane.obj",this.planeMaterial,.1);this.planeMesh=e;const t=await this.loadGeometry("/models/maps/archipelago.obj");this.archipelagoBaseGeometry=t.geometry;const n=[this.gLoad([{path:"/models/tree/tree_trunk.obj",color:Sr},{path:"/models/tree/tree_leaves.obj",color:vr}]),this.gLoad([{path:"/models/palm_tree/trunk.obj",color:Sr},{path:"/models/palm_tree/leaves.obj",color:vr}])],[s,o]=await Promise.all(n);this.groupTree=s,this.groupPalm=o}catch(e){throw console.error("Error loading assets in AssetManager:",e),e}}}function he(...i){if(i.length===1){const e=i[0];if(Array.isArray(e))return new X(...e);if(e instanceof X)return e}return i.length===3?new X(i[0],i[1],i[2]):new X}function tn(i,e){const t=i instanceof X?i:new X(...i),n=e instanceof X?e:new X(...e),s=t.clone().add(n);return[s.x,s.y,s.z]}function Rs(i){return[i.x,i.y,i.z]}function Zc(i){let e=i.toString(16);for(;e.length<6;)e=`0${e}`;const t=(n,s)=>parseInt(e.substring(n,s),16)/255;return[t(0,2),t(2,4),t(4,6)]}function Qc(i,e,t){const n=new yc;return n.setFromEuler(e),new ut().compose(i,n,t)}function el(i,e){const t=new wc(i.geometry,i.material,e.length);t.castShadow=!0,t.receiveShadow=!0;for(let n=0;n<e.length;n++)t.setMatrixAt(n,e[n]);return t}function Ai(i){var e;(e=i.geometry)==null||e.dispose(),i.material&&(Array.isArray(i.material)?i.material.forEach(t=>t.dispose()):i.material.dispose())}class tl{constructor(e,t){Y(this,"camera");Y(this,"baseLocalPos",he(0,10,20));Y(this,"baseLocalRot",new Qt(0,0,0));Y(this,"save",he(0,10,20));Y(this,"factor",500);this.camera=new xc(75,e/t,.1,1e4),this.camera.position.copy(this.baseLocalPos),this.camera.rotation.copy(this.baseLocalRot)}getThreeCamera(){return this.camera}handleResize(e,t){this.camera.aspect=e/t,this.camera.updateProjectionMatrix()}updateSavePosition(){this.save=this.camera.position.clone()}getBaseLocalPosition(){return this.baseLocalPos}setPosition(e){this.camera.position.copy(e)}setRotation(e){this.camera.rotation.copy(e)}update(e,t){const n=he(-e.rotVel.yaw*this.factor,e.rotVel.pitch*this.factor,-e.vel.local.z/10*this.factor);if(this.camera.position.set(...tn(this.baseLocalPos,n)),this.camera.rotation.copy(this.baseLocalRot),t){const s=e.getPosition();t.target.position.copy(s),t.position.set(s.x+1,s.y+1,s.z+1)}}updateStatic(e){this.camera.position.set(...tn(this.save,he(-e.x/4e3,e.y/4e3,0)))}}class nl{constructor(){Y(this,"_inputState");this._inputState={keys:{},mouse:{x:0,y:0}}}_updateKey(e,t){this._inputState.keys[e]=t}_updateMousePosition(e,t){this._inputState.mouse.x=e,this._inputState.mouse.y=t}keyPressed(e){return this._inputState.keys.hasOwnProperty(e)?this._inputState.keys[e]:!1}handlePlaneKeys(e){if(!e)return;let t=e.rotVel;this.keyPressed("ArrowUp")&&(t.pitch+=Ar),this.keyPressed("ArrowDown")&&(t.pitch-=Ar),this.keyPressed("ArrowLeft")&&(t.yaw+=Er),this.keyPressed("ArrowRight")&&(t.yaw-=Er),this.keyPressed("a")&&(t.roll+=Tr),this.keyPressed("d")&&(t.roll-=Tr),e.rotVel=t,this.keyPressed("w")?e.thrust=zc:this.keyPressed("s")?e.thrust=-1e-4:e.thrust=0}setupGlobalInputListeners(){const e=n=>{this._updateKey(n.key,n.type==="keydown")};document.removeEventListener("keydown",e),document.removeEventListener("keyup",e),document.addEventListener("keydown",e),document.addEventListener("keyup",e);const t=n=>{this._updateMousePosition(n.clientX,n.clientY)};document.removeEventListener("mousemove",t),document.addEventListener("mousemove",t)}getInputState(){return this._inputState}}var sl=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Ti(i){if(Object.prototype.hasOwnProperty.call(i,"__esModule"))return i;var e=i.default;if(typeof e=="function"){var t=function n(){return this instanceof n?Reflect.construct(e,arguments,this.constructor):e.apply(this,arguments)};t.prototype=e.prototype}else t={};return Object.defineProperty(t,"__esModule",{value:!0}),Object.keys(i).forEach(function(n){var s=Object.getOwnPropertyDescriptor(i,n);Object.defineProperty(t,n,s.get?s:{enumerable:!0,get:function(){return i[n]}})}),t}var Ds={},_r={},Or;function il(){return Or||(Or=1,ArrayBuffer.isView||(ArrayBuffer.isView=i=>i!==null&&typeof i=="object"&&i.buffer instanceof ArrayBuffer),typeof FormData>"u"&&(sl.FormData=class{}),typeof globalThis>"u"&&typeof window<"u"&&(window.globalThis=window)),_r}var Fn={},ci=function(i,e){return ci=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(t[s]=n[s])},ci(i,e)};function $o(i,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");ci(i,e);function t(){this.constructor=i}i.prototype=e===null?Object.create(e):(t.prototype=e.prototype,new t)}var fs=function(){return fs=Object.assign||function(e){for(var t,n=1,s=arguments.length;n<s;n++){t=arguments[n];for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o])}return e},fs.apply(this,arguments)};function Lo(i,e){var t={};for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&e.indexOf(n)<0&&(t[n]=i[n]);if(i!=null&&typeof Object.getOwnPropertySymbols=="function")for(var s=0,n=Object.getOwnPropertySymbols(i);s<n.length;s++)e.indexOf(n[s])<0&&Object.prototype.propertyIsEnumerable.call(i,n[s])&&(t[n[s]]=i[n[s]]);return t}function No(i,e,t,n){var s=arguments.length,o=s<3?e:n===null?n=Object.getOwnPropertyDescriptor(e,t):n,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(i,e,t,n);else for(var l=i.length-1;l>=0;l--)(a=i[l])&&(o=(s<3?a(o):s>3?a(e,t,o):a(e,t))||o);return s>3&&o&&Object.defineProperty(e,t,o),o}function ko(i,e){return function(t,n){e(t,n,i)}}function Fo(i,e,t,n,s,o){function a(S){if(S!==void 0&&typeof S!="function")throw new TypeError("Function expected");return S}for(var l=n.kind,d=l==="getter"?"get":l==="setter"?"set":"value",p=!e&&i?n.static?i:i.prototype:null,m=e||(p?Object.getOwnPropertyDescriptor(p,n.name):{}),f,h=!1,g=t.length-1;g>=0;g--){var E={};for(var A in n)E[A]=A==="access"?{}:n[A];for(var A in n.access)E.access[A]=n.access[A];E.addInitializer=function(S){if(h)throw new TypeError("Cannot add initializers after decoration has completed");o.push(a(S||null))};var b=(0,t[g])(l==="accessor"?{get:m.get,set:m.set}:m[d],E);if(l==="accessor"){if(b===void 0)continue;if(b===null||typeof b!="object")throw new TypeError("Object expected");(f=a(b.get))&&(m.get=f),(f=a(b.set))&&(m.set=f),(f=a(b.init))&&s.unshift(f)}else(f=a(b))&&(l==="field"?s.unshift(f):m[d]=f)}p&&Object.defineProperty(p,n.name,m),h=!0}function jo(i,e,t){for(var n=arguments.length>2,s=0;s<e.length;s++)t=n?e[s].call(i,t):e[s].call(i);return n?t:void 0}function Vo(i){return typeof i=="symbol"?i:"".concat(i)}function Uo(i,e,t){return typeof e=="symbol"&&(e=e.description?"[".concat(e.description,"]"):""),Object.defineProperty(i,"name",{configurable:!0,value:t?"".concat(t," ",e):e})}function zo(i,e){if(typeof Reflect=="object"&&typeof Reflect.metadata=="function")return Reflect.metadata(i,e)}function Ho(i,e,t,n){function s(o){return o instanceof t?o:new t(function(a){a(o)})}return new(t||(t=Promise))(function(o,a){function l(m){try{p(n.next(m))}catch(f){a(f)}}function d(m){try{p(n.throw(m))}catch(f){a(f)}}function p(m){m.done?o(m.value):s(m.value).then(l,d)}p((n=n.apply(i,e||[])).next())})}function qo(i,e){var t={label:0,sent:function(){if(o[0]&1)throw o[1];return o[1]},trys:[],ops:[]},n,s,o,a=Object.create((typeof Iterator=="function"?Iterator:Object).prototype);return a.next=l(0),a.throw=l(1),a.return=l(2),typeof Symbol=="function"&&(a[Symbol.iterator]=function(){return this}),a;function l(p){return function(m){return d([p,m])}}function d(p){if(n)throw new TypeError("Generator is already executing.");for(;a&&(a=0,p[0]&&(t=0)),t;)try{if(n=1,s&&(o=p[0]&2?s.return:p[0]?s.throw||((o=s.return)&&o.call(s),0):s.next)&&!(o=o.call(s,p[1])).done)return o;switch(s=0,o&&(p=[p[0]&2,o.value]),p[0]){case 0:case 1:o=p;break;case 4:return t.label++,{value:p[1],done:!1};case 5:t.label++,s=p[1],p=[0];continue;case 7:p=t.ops.pop(),t.trys.pop();continue;default:if(o=t.trys,!(o=o.length>0&&o[o.length-1])&&(p[0]===6||p[0]===2)){t=0;continue}if(p[0]===3&&(!o||p[1]>o[0]&&p[1]<o[3])){t.label=p[1];break}if(p[0]===6&&t.label<o[1]){t.label=o[1],o=p;break}if(o&&t.label<o[2]){t.label=o[2],t.ops.push(p);break}o[2]&&t.ops.pop(),t.trys.pop();continue}p=e.call(i,t)}catch(m){p=[6,m],s=0}finally{n=o=0}if(p[0]&5)throw p[1];return{value:p[0]?p[1]:void 0,done:!0}}}var ms=Object.create?function(i,e,t,n){n===void 0&&(n=t);var s=Object.getOwnPropertyDescriptor(e,t);(!s||("get"in s?!e.__esModule:s.writable||s.configurable))&&(s={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(i,n,s)}:function(i,e,t,n){n===void 0&&(n=t),i[n]=e[t]};function Wo(i,e){for(var t in i)t!=="default"&&!Object.prototype.hasOwnProperty.call(e,t)&&ms(e,i,t)}function us(i){var e=typeof Symbol=="function"&&Symbol.iterator,t=e&&i[e],n=0;if(t)return t.call(i);if(i&&typeof i.length=="number")return{next:function(){return i&&n>=i.length&&(i=void 0),{value:i&&i[n++],done:!i}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function Si(i,e){var t=typeof Symbol=="function"&&i[Symbol.iterator];if(!t)return i;var n=t.call(i),s,o=[],a;try{for(;(e===void 0||e-- >0)&&!(s=n.next()).done;)o.push(s.value)}catch(l){a={error:l}}finally{try{s&&!s.done&&(t=n.return)&&t.call(n)}finally{if(a)throw a.error}}return o}function Go(){for(var i=[],e=0;e<arguments.length;e++)i=i.concat(Si(arguments[e]));return i}function Jo(){for(var i=0,e=0,t=arguments.length;e<t;e++)i+=arguments[e].length;for(var n=Array(i),s=0,e=0;e<t;e++)for(var o=arguments[e],a=0,l=o.length;a<l;a++,s++)n[s]=o[a];return n}function Ko(i,e,t){if(t||arguments.length===2)for(var n=0,s=e.length,o;n<s;n++)(o||!(n in e))&&(o||(o=Array.prototype.slice.call(e,0,n)),o[n]=e[n]);return i.concat(o||Array.prototype.slice.call(e))}function nn(i){return this instanceof nn?(this.v=i,this):new nn(i)}function Yo(i,e,t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var n=t.apply(i,e||[]),s,o=[];return s=Object.create((typeof AsyncIterator=="function"?AsyncIterator:Object).prototype),l("next"),l("throw"),l("return",a),s[Symbol.asyncIterator]=function(){return this},s;function a(g){return function(E){return Promise.resolve(E).then(g,f)}}function l(g,E){n[g]&&(s[g]=function(A){return new Promise(function(b,S){o.push([g,A,b,S])>1||d(g,A)})},E&&(s[g]=E(s[g])))}function d(g,E){try{p(n[g](E))}catch(A){h(o[0][3],A)}}function p(g){g.value instanceof nn?Promise.resolve(g.value.v).then(m,f):h(o[0][2],g)}function m(g){d("next",g)}function f(g){d("throw",g)}function h(g,E){g(E),o.shift(),o.length&&d(o[0][0],o[0][1])}}function Xo(i){var e,t;return e={},n("next"),n("throw",function(s){throw s}),n("return"),e[Symbol.iterator]=function(){return this},e;function n(s,o){e[s]=i[s]?function(a){return(t=!t)?{value:nn(i[s](a)),done:!1}:o?o(a):a}:o}}function Zo(i){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var e=i[Symbol.asyncIterator],t;return e?e.call(i):(i=typeof us=="function"?us(i):i[Symbol.iterator](),t={},n("next"),n("throw"),n("return"),t[Symbol.asyncIterator]=function(){return this},t);function n(o){t[o]=i[o]&&function(a){return new Promise(function(l,d){a=i[o](a),s(l,d,a.done,a.value)})}}function s(o,a,l,d){Promise.resolve(d).then(function(p){o({value:p,done:l})},a)}}function Qo(i,e){return Object.defineProperty?Object.defineProperty(i,"raw",{value:e}):i.raw=e,i}var rl=Object.create?function(i,e){Object.defineProperty(i,"default",{enumerable:!0,value:e})}:function(i,e){i.default=e},li=function(i){return li=Object.getOwnPropertyNames||function(e){var t=[];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[t.length]=n);return t},li(i)};function ea(i){if(i&&i.__esModule)return i;var e={};if(i!=null)for(var t=li(i),n=0;n<t.length;n++)t[n]!=="default"&&ms(e,i,t[n]);return rl(e,i),e}function ta(i){return i&&i.__esModule?i:{default:i}}function na(i,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?i!==e||!n:!e.has(i))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(i):n?n.value:e.get(i)}function sa(i,e,t,n,s){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?i!==e||!s:!e.has(i))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?s.call(i,t):s?s.value=t:e.set(i,t),t}function ia(i,e){if(e===null||typeof e!="object"&&typeof e!="function")throw new TypeError("Cannot use 'in' operator on non-object");return typeof i=="function"?e===i:i.has(e)}function ra(i,e,t){if(e!=null){if(typeof e!="object"&&typeof e!="function")throw new TypeError("Object expected.");var n,s;if(t){if(!Symbol.asyncDispose)throw new TypeError("Symbol.asyncDispose is not defined.");n=e[Symbol.asyncDispose]}if(n===void 0){if(!Symbol.dispose)throw new TypeError("Symbol.dispose is not defined.");n=e[Symbol.dispose],t&&(s=n)}if(typeof n!="function")throw new TypeError("Object not disposable.");s&&(n=function(){try{s.call(this)}catch(o){return Promise.reject(o)}}),i.stack.push({value:e,dispose:n,async:t})}else t&&i.stack.push({async:!0});return e}var ol=typeof SuppressedError=="function"?SuppressedError:function(i,e,t){var n=new Error(t);return n.name="SuppressedError",n.error=i,n.suppressed=e,n};function oa(i){function e(o){i.error=i.hasError?new ol(o,i.error,"An error was suppressed during disposal."):o,i.hasError=!0}var t,n=0;function s(){for(;t=i.stack.pop();)try{if(!t.async&&n===1)return n=0,i.stack.push(t),Promise.resolve().then(s);if(t.dispose){var o=t.dispose.call(t.value);if(t.async)return n|=2,Promise.resolve(o).then(s,function(a){return e(a),s()})}else n|=1}catch(a){e(a)}if(n===1)return i.hasError?Promise.reject(i.error):Promise.resolve();if(i.hasError)throw i.error}return s()}function aa(i,e){return typeof i=="string"&&/^\.\.?\//.test(i)?i.replace(/\.(tsx)$|((?:\.d)?)((?:\.[^./]+?)?)\.([cm]?)ts$/i,function(t,n,s,o,a){return n?e?".jsx":".js":s&&(!o||!a)?t:s+o+"."+a.toLowerCase()+"js"}):i}const al={__extends:$o,__assign:fs,__rest:Lo,__decorate:No,__param:ko,__esDecorate:Fo,__runInitializers:jo,__propKey:Vo,__setFunctionName:Uo,__metadata:zo,__awaiter:Ho,__generator:qo,__createBinding:ms,__exportStar:Wo,__values:us,__read:Si,__spread:Go,__spreadArrays:Jo,__spreadArray:Ko,__await:nn,__asyncGenerator:Yo,__asyncDelegator:Xo,__asyncValues:Zo,__makeTemplateObject:Qo,__importStar:ea,__importDefault:ta,__classPrivateFieldGet:na,__classPrivateFieldSet:sa,__classPrivateFieldIn:ia,__addDisposableResource:ra,__disposeResources:oa,__rewriteRelativeImportExtension:aa},cl=Object.freeze(Object.defineProperty({__proto__:null,__addDisposableResource:ra,get __assign(){return fs},__asyncDelegator:Xo,__asyncGenerator:Yo,__asyncValues:Zo,__await:nn,__awaiter:Ho,__classPrivateFieldGet:na,__classPrivateFieldIn:ia,__classPrivateFieldSet:sa,__createBinding:ms,__decorate:No,__disposeResources:oa,__esDecorate:Fo,__exportStar:Wo,__extends:$o,__generator:qo,__importDefault:ta,__importStar:ea,__makeTemplateObject:Qo,__metadata:zo,__param:ko,__propKey:Vo,__read:Si,__rest:Lo,__rewriteRelativeImportExtension:aa,__runInitializers:jo,__setFunctionName:Uo,__spread:Go,__spreadArray:Ko,__spreadArrays:Jo,__values:us,default:al},Symbol.toStringTag,{value:"Module"})),gs=Ti(cl);var Bs={},Mr;function ys(){return Mr||(Mr=1,function(i){i.CloseCode=void 0,function(t){t[t.CONSENTED=4e3]="CONSENTED",t[t.DEVMODE_RESTART=4010]="DEVMODE_RESTART"}(i.CloseCode||(i.CloseCode={}));class e extends Error{constructor(n,s){super(s),this.name="ServerError",this.code=n}}i.ServerError=e}(Bs)),Bs}var $s={},Ls={},Ns={},bn={exports:{}},ll=bn.exports,Cr;function vi(){return Cr||(Cr=1,function(i,e){(function(t,n){n(e)})(ll,function(t){t.OPERATION=void 0,function(w){w[w.ADD=128]="ADD",w[w.REPLACE=0]="REPLACE",w[w.DELETE=64]="DELETE",w[w.DELETE_AND_MOVE=96]="DELETE_AND_MOVE",w[w.MOVE_AND_ADD=160]="MOVE_AND_ADD",w[w.DELETE_AND_ADD=192]="DELETE_AND_ADD",w[w.CLEAR=10]="CLEAR",w[w.REVERSE=15]="REVERSE",w[w.MOVE=32]="MOVE",w[w.DELETE_BY_REFID=33]="DELETE_BY_REFID",w[w.ADD_BY_REFID=129]="ADD_BY_REFID"}(t.OPERATION||(t.OPERATION={})),Symbol.metadata??(Symbol.metadata=Symbol.for("Symbol.metadata"));const o=Symbol("$track"),a=Symbol("$encoder"),l=Symbol("$decoder"),d=Symbol("$filter"),p=Symbol("$getByIndex"),m=Symbol("$deleteByIndex"),f=Symbol("$changes"),h=Symbol("$childType"),g=Symbol("$onEncodeEnd"),E=Symbol("$onDecodeEnd"),A=Symbol("$descriptors"),b="$__numFields",S="$__refTypeFieldIndexes",P="$__viewFieldIndexes",M="$__fieldIndexesByViewTag";let C;try{C=new TextEncoder}catch{}const B=new ArrayBuffer(8),$=new Int32Array(B),N=new Float32Array(B),W=new Float64Array(B),z=new BigInt64Array(B),ee=typeof Buffer<"u"&&Buffer.byteLength?Buffer.byteLength:function(w,r){for(var c=0,u=0,y=0,x=w.length;y<x;y++)c=w.charCodeAt(y),c<128?u+=1:c<2048?u+=2:c<55296||c>=57344?u+=3:(y++,u+=4);return u};function F(w,r,c){for(var u=0,y=0,x=r.length;y<x;y++)u=r.charCodeAt(y),u<128?w[c.offset++]=u:u<2048?(w[c.offset]=192|u>>6,w[c.offset+1]=128|u&63,c.offset+=2):u<55296||u>=57344?(w[c.offset]=224|u>>12,w[c.offset+1]=128|u>>6&63,w[c.offset+2]=128|u&63,c.offset+=3):(y++,u=65536+((u&1023)<<10|r.charCodeAt(y)&1023),w[c.offset]=240|u>>18,w[c.offset+1]=128|u>>12&63,w[c.offset+2]=128|u>>6&63,w[c.offset+3]=128|u&63,c.offset+=4)}function T(w,r,c){w[c.offset++]=r&255}function L(w,r,c){w[c.offset++]=r&255}function j(w,r,c){w[c.offset++]=r&255,w[c.offset++]=r>>8&255}function k(w,r,c){w[c.offset++]=r&255,w[c.offset++]=r>>8&255}function U(w,r,c){w[c.offset++]=r&255,w[c.offset++]=r>>8&255,w[c.offset++]=r>>16&255,w[c.offset++]=r>>24&255}function te(w,r,c){const u=r>>24,y=r>>16,x=r>>8,v=r;w[c.offset++]=v&255,w[c.offset++]=x&255,w[c.offset++]=y&255,w[c.offset++]=u&255}function oe(w,r,c){const u=Math.floor(r/Math.pow(2,32)),y=r>>>0;te(w,y,c),te(w,u,c)}function re(w,r,c){const u=r/Math.pow(2,32)>>0,y=r>>>0;te(w,y,c),te(w,u,c)}function ae(w,r,c){z[0]=BigInt.asIntN(64,r),U(w,$[0],c),U(w,$[1],c)}function ce(w,r,c){z[0]=BigInt.asIntN(64,r),U(w,$[0],c),U(w,$[1],c)}function Ae(w,r,c){N[0]=r,U(w,$[0],c)}function We(w,r,c){W[0]=r,U(w,$[0],c),U(w,$[1],c)}function It(w,r,c){w[c.offset++]=r?1:0}function Na(w,r,c){r||(r="");let u=ee(r,"utf8"),y=0;if(u<32)w[c.offset++]=u|160,y=1;else if(u<256)w[c.offset++]=217,w[c.offset++]=u%255,y=2;else if(u<65536)w[c.offset++]=218,k(w,u,c),y=3;else if(u<4294967296)w[c.offset++]=219,te(w,u,c),y=5;else throw new Error("String too long");return F(w,r,c),y+u}function Ts(w,r,c){if(isNaN(r))return Ts(w,0,c);if(isFinite(r)){if(r!==(r|0))return Math.abs(r)<=34028235e31&&(N[0]=r,Math.abs(Math.abs(N[0])-Math.abs(r))<1e-4)?(w[c.offset++]=202,Ae(w,r,c),5):(w[c.offset++]=203,We(w,r,c),9)}else return Ts(w,r>0?Number.MAX_SAFE_INTEGER:-Number.MAX_SAFE_INTEGER,c);return r>=0?r<128?(w[c.offset++]=r&255,1):r<256?(w[c.offset++]=204,w[c.offset++]=r&255,2):r<65536?(w[c.offset++]=205,k(w,r,c),3):r<4294967296?(w[c.offset++]=206,te(w,r,c),5):(w[c.offset++]=207,re(w,r,c),9):r>=-32?(w[c.offset++]=224|r+32,1):r>=-128?(w[c.offset++]=208,T(w,r,c),2):r>=-32768?(w[c.offset++]=209,j(w,r,c),3):r>=-2147483648?(w[c.offset++]=210,U(w,r,c),5):(w[c.offset++]=211,oe(w,r,c),9)}const Be={int8:T,uint8:L,int16:j,uint16:k,int32:U,uint32:te,int64:oe,uint64:re,bigint64:ae,biguint64:ce,float32:Ae,float64:We,boolean:It,string:Na,number:Ts,utf8Write:F,utf8Length:ee},rn=new ArrayBuffer(8),_t=new Int32Array(rn),ka=new Float32Array(rn),Fa=new Float64Array(rn),ja=new BigUint64Array(rn),Va=new BigInt64Array(rn);function Di(w,r,c){for(var u="",y=0,x=r.offset,v=r.offset+c;x<v;x++){var O=w[x];if((O&128)===0){u+=String.fromCharCode(O);continue}if((O&224)===192){u+=String.fromCharCode((O&31)<<6|w[++x]&63);continue}if((O&240)===224){u+=String.fromCharCode((O&15)<<12|(w[++x]&63)<<6|(w[++x]&63)<<0);continue}if((O&248)===240){y=(O&7)<<18|(w[++x]&63)<<12|(w[++x]&63)<<6|(w[++x]&63)<<0,y>=65536?(y-=65536,u+=String.fromCharCode((y>>>10)+55296,(y&1023)+56320)):u+=String.fromCharCode(y);continue}console.error("Invalid byte "+O.toString(16))}return r.offset+=c,u}function Bi(w,r){return on(w,r)<<24>>24}function on(w,r){return w[r.offset++]}function $i(w,r){return On(w,r)<<16>>16}function On(w,r){return w[r.offset++]|w[r.offset++]<<8}function Ge(w,r){return w[r.offset++]|w[r.offset++]<<8|w[r.offset++]<<16|w[r.offset++]<<24}function Lt(w,r){return Ge(w,r)>>>0}function Li(w,r){return _t[0]=Ge(w,r),ka[0]}function Ni(w,r){return _t[0]=Ge(w,r),_t[1]=Ge(w,r),Fa[0]}function ki(w,r){const c=Lt(w,r);return Ge(w,r)*Math.pow(2,32)+c}function Fi(w,r){const c=Lt(w,r);return Lt(w,r)*Math.pow(2,32)+c}function Ua(w,r){return _t[0]=Ge(w,r),_t[1]=Ge(w,r),Va[0]}function za(w,r){return _t[0]=Ge(w,r),_t[1]=Ge(w,r),ja[0]}function Ha(w,r){return on(w,r)>0}function qa(w,r){const c=w[r.offset++];let u;return c<192?u=c&31:c===217?u=on(w,r):c===218?u=On(w,r):c===219&&(u=Lt(w,r)),Di(w,r,u)}function Wa(w,r){const c=w[r.offset++];if(c<128)return c;if(c===202)return Li(w,r);if(c===203)return Ni(w,r);if(c===204)return on(w,r);if(c===205)return On(w,r);if(c===206)return Lt(w,r);if(c===207)return Fi(w,r);if(c===208)return Bi(w,r);if(c===209)return $i(w,r);if(c===210)return Ge(w,r);if(c===211)return ki(w,r);if(c>223)return(255-c+1)*-1}function Ga(w,r){const c=w[r.offset];return c<192&&c>160||c===217||c===218||c===219}const $e={utf8Read:Di,int8:Bi,uint8:on,int16:$i,uint16:On,int32:Ge,uint32:Lt,float32:Li,float64:Ni,int64:ki,uint64:Fi,bigint64:Ua,biguint64:za,boolean:Ha,string:qa,number:Wa,stringCheck:Ga},ji={},Ja=new Map;function nt(w,r){r.constructor&&(Ja.set(r.constructor,w),ji[w]=r),r.encode&&(Be[w]=r.encode),r.decode&&($e[w]=r.decode)}function an(w){return ji[w]}function Ka(w){for(const r in w)nt(r,w[r]);return r=>Je(r)}const rt=class rt{static register(r){const c=Object.getPrototypeOf(r);if(c!==be){let u=rt.inheritedTypes.get(c);u||(u=new Set,rt.inheritedTypes.set(c,u)),u.add(r)}}static cache(r){let c=rt.cachedContexts.get(r);return c||(c=new rt(r),rt.cachedContexts.set(r,c)),c}constructor(r){this.types={},this.schemas=new Map,this.hasFilters=!1,this.parentFiltered={},r&&this.discoverTypes(r)}has(r){return this.schemas.has(r)}get(r){return this.types[r]}add(r,c=this.schemas.size){return this.schemas.has(r)?!1:(this.types[c]=r,r[Symbol.metadata]===void 0&&Te.initialize(r),this.schemas.set(r,c),!0)}getTypeId(r){return this.schemas.get(r)}discoverTypes(r,c,u,y){var O,R;if(y&&this.registerFilteredByParent(r,c,u),!this.add(r))return;(O=rt.inheritedTypes.get(r))==null||O.forEach(V=>{this.discoverTypes(V,c,u,y)});let x=r;for(;(x=Object.getPrototypeOf(x))&&x!==be&&x!==Function.prototype;)this.discoverTypes(x);const v=r[R=Symbol.metadata]??(r[R]={});v[P]&&(this.hasFilters=!0);for(const V in v){const H=V,K=v[H].type,q=v[H].tag!==void 0;if(typeof K!="string")if(Array.isArray(K)){const ie=K[0];if(ie==="string")continue;this.discoverTypes(ie,r,H,y||q)}else if(typeof K=="function")this.discoverTypes(K,r,H,y||q);else{const ie=Object.values(K)[0];if(typeof ie=="string")continue;this.discoverTypes(ie,r,H,y||q)}}}registerFilteredByParent(r,c,u){let x=`${this.schemas.get(r)??this.schemas.size}`;c&&(x+=`-${this.schemas.get(c)}`),x+=`-${u}`,this.parentFiltered[x]=!0}debug(){let r="";for(const c in this.parentFiltered){const u=c.split("-").map(Number),y=u.pop();r+=`
		`,r+=`${c}: ${u.reverse().map((x,v)=>{const O=this.types[x],R=O[Symbol.metadata];let V=O.name;return v===0&&(V+=`[${R[y].name}]`),`${V}`}).join(" -> ")}`}return`TypeContext ->
	Schema types: ${this.schemas.size}
	hasFilters: ${this.hasFilters}
	parentFiltered:${r}`}};rt.inheritedTypes=new Map,rt.cachedContexts=new Map;let st=rt;function Vi(w){return Array.isArray(w)?{array:w[0]}:typeof w.type<"u"?w.type:w}const Te={addField(w,r,c,u,y){if(r>64)throw new Error(`Can't define field '${c}'.
Schema instances may only have up to 64 fields.`);w[r]=Object.assign(w[r]||{},{type:Vi(u),index:r,name:c}),Object.defineProperty(w,A,{value:w[A]||{},enumerable:!1,configurable:!0}),y?(w[A][c]=y,w[A][`_${c}`]={value:void 0,writable:!0,enumerable:!1,configurable:!0}):w[A][c]={value:void 0,writable:!0,enumerable:!0,configurable:!0},Object.defineProperty(w,b,{value:r,enumerable:!1,configurable:!0}),Object.defineProperty(w,c,{value:r,enumerable:!1,configurable:!0}),typeof w[r].type!="string"&&(w[S]===void 0&&Object.defineProperty(w,S,{value:[],enumerable:!1,configurable:!0}),w[S].push(r))},setTag(w,r,c){const u=w[r],y=w[u];y.tag=c,w[P]||(Object.defineProperty(w,P,{value:[],enumerable:!1,configurable:!0}),Object.defineProperty(w,M,{value:{},enumerable:!1,configurable:!0})),w[P].push(u),w[M][c]||(w[M][c]=[]),w[M][c].push(u)},setFields(w,r){const c=w.prototype.constructor;st.register(c);const u=Object.getPrototypeOf(c),y=u&&u[Symbol.metadata],x=Te.initialize(c);c[o]||(c[o]=be[o]),c[a]||(c[a]=be[a]),c[l]||(c[l]=be[l]),c.prototype.toJSON||(c.prototype.toJSON=be.prototype.toJSON);let v=x[b]??(y&&y[b])??-1;v++;for(const O in r){const R=r[O],V=Array.isArray(R)?an("array"):typeof Object.keys(R)[0]=="string"&&an(Object.keys(R)[0]),H=V?Object.values(R)[0]:Vi(R);Te.addField(x,v,O,R,Qi(`_${O}`,v,H,V)),v++}return w},isDeprecated(w,r){return w[r].deprecated===!0},init(w){const r={};w[Symbol.metadata]=r,Object.defineProperty(r,b,{value:0,enumerable:!1,configurable:!0})},initialize(w){const r=Object.getPrototypeOf(w),c=r[Symbol.metadata];let u=w[Symbol.metadata]??Object.create(null);return r!==be&&u===c&&(u=Object.create(null),c&&(Object.setPrototypeOf(u,c),Object.defineProperty(u,b,{value:c[b],enumerable:!1,configurable:!0,writable:!0}),c[P]!==void 0&&(Object.defineProperty(u,P,{value:[...c[P]],enumerable:!1,configurable:!0,writable:!0}),Object.defineProperty(u,M,{value:{...c[M]},enumerable:!1,configurable:!0,writable:!0})),c[S]!==void 0&&Object.defineProperty(u,S,{value:[...c[S]],enumerable:!1,configurable:!0,writable:!0}),Object.defineProperty(u,A,{value:{...c[A]},enumerable:!1,configurable:!0,writable:!0}))),w[Symbol.metadata]=u,u},isValidInstance(w){return w.constructor[Symbol.metadata]&&Object.prototype.hasOwnProperty.call(w.constructor[Symbol.metadata],b)},getFields(w){const r=w[Symbol.metadata],c={};for(let u=0;u<=r[b];u++)c[r[u].name]=r[u].type;return c},hasViewTagAtIndex(w,r){var c;return(c=w==null?void 0:w[P])==null?void 0:c.includes(r)}};function Mn(){return{indexes:{},operations:[]}}function Le(w,r){const c=w.indexes[r];c===void 0?w.indexes[r]=w.operations.push(r)-1:w.operations[c]=r}function Ui(w,r){var u;let c=w.indexes[r];c===void 0&&(c=Object.values(w.indexes).at(-1),r=(u=Object.entries(w.indexes).find(([y,x])=>x===c))==null?void 0:u[0]),w.operations[c]=void 0,delete w.indexes[r]}function Me(w,r,c,u=r[c].queueRootIndex){if(w)w[c][u]!==r&&(r[c].queueRootIndex=w[c].push(r)-1);else return}class Nt{constructor(r){this.isFiltered=!1,this.indexedOperations={},this.changes={indexes:{},operations:[]},this.allChanges={indexes:{},operations:[]},this.isNew=!0,this.ref=r;const c=r.constructor[Symbol.metadata];c!=null&&c[P]&&(this.allFilteredChanges={indexes:{},operations:[]},this.filteredChanges={indexes:{},operations:[]})}setRoot(r){var u;this.root=r,this.checkIsFiltered(this.parent,this.parentIndex);const c=this.ref.constructor[Symbol.metadata];c?(u=c[S])==null||u.forEach(y=>{const x=c[y],v=this.ref[x.name];v==null||v[f].setRoot(r)}):this.ref[h]&&typeof this.ref[h]!="string"&&this.ref.forEach((y,x)=>{y[f].setRoot(r)})}setParent(r,c,u){var x;if(this.parent=r,this.parentIndex=u,!c)return;c!==this.root?(this.root=c,this.checkIsFiltered(r,u)):c.add(this);const y=this.ref.constructor[Symbol.metadata];y?(x=y[S])==null||x.forEach(v=>{const O=y[v],R=this.ref[O.name];R==null||R[f].setParent(this.ref,c,v)}):this.ref[h]&&typeof this.ref[h]!="string"&&this.ref.forEach((v,O)=>{v[f].setParent(this.ref,c,this.indexes[O]??O)})}forEachChild(r){var u;const c=this.ref.constructor[Symbol.metadata];c?(u=c[S])==null||u.forEach(y=>{const x=c[y],v=this.ref[x.name];v&&r(v[f],y)}):this.ref[h]&&typeof this.ref[h]!="string"&&this.ref.forEach((y,x)=>{r(y[f],this.indexes[x]??x)})}operation(r){this.filteredChanges!==void 0?(this.filteredChanges.operations.push(-r),Me(this.root,this,"filteredChanges")):(this.changes.operations.push(-r),Me(this.root,this,"changes"))}change(r,c=t.OPERATION.ADD){var O;const u=this.ref.constructor[Symbol.metadata],y=this.isFiltered||((O=u==null?void 0:u[r])==null?void 0:O.tag)!==void 0,x=y?this.filteredChanges:this.changes,v=this.indexedOperations[r];if(!v||v===t.OPERATION.DELETE){const R=v&&v===t.OPERATION.DELETE?t.OPERATION.DELETE_AND_ADD:c;this.indexedOperations[r]=R}Le(x,r),y?(Le(this.allFilteredChanges,r),this.root&&(Me(this.root,this,"filteredChanges"),Me(this.root,this,"allFilteredChanges"))):(Le(this.allChanges,r),Me(this.root,this,"changes"))}shiftChangeIndexes(r){const c=this.isFiltered?this.filteredChanges:this.changes,u={},y={};for(const x in this.indexedOperations)u[Number(x)+r]=this.indexedOperations[x],y[Number(x)+r]=c.indexes[x];this.indexedOperations=u,c.indexes=y,c.operations=c.operations.map(x=>x+r)}shiftAllChangeIndexes(r,c=0){this.filteredChanges!==void 0?(this._shiftAllChangeIndexes(r,c,this.allFilteredChanges),this._shiftAllChangeIndexes(r,c,this.allChanges)):this._shiftAllChangeIndexes(r,c,this.allChanges)}_shiftAllChangeIndexes(r,c=0,u){const y={};let x=0;for(const v in u.indexes)y[x++]=u.indexes[v];u.indexes=y;for(let v=0;v<u.operations.length;v++){const O=u.operations[v];O>c&&(u.operations[v]=O+r)}}indexedOperation(r,c,u=r){this.indexedOperations[r]=c,this.filteredChanges!==void 0?(Le(this.allFilteredChanges,u),Le(this.filteredChanges,r),Me(this.root,this,"filteredChanges")):(Le(this.allChanges,u),Le(this.changes,r),Me(this.root,this,"changes"))}getType(r){return Te.isValidInstance(this.ref)?this.ref.constructor[Symbol.metadata][r].type:this.ref[h]}getChange(r){return this.indexedOperations[r]}getValue(r,c=!1){return this.ref[p](r,c)}delete(r,c,u=r){var v;if(r===void 0){try{throw new Error(`@colyseus/schema ${this.ref.constructor.name}: trying to delete non-existing index '${r}'`)}catch(O){console.warn(O)}return}const y=this.filteredChanges!==void 0?this.filteredChanges:this.changes;this.indexedOperations[r]=c??t.OPERATION.DELETE,Le(y,r),Ui(this.allChanges,u);const x=this.getValue(r);return x&&x[f]&&((v=this.root)==null||v.remove(x[f])),this.filteredChanges!==void 0?(Ui(this.allFilteredChanges,u),Me(this.root,this,"filteredChanges")):Me(this.root,this,"changes"),x}endEncode(r){var c,u;this.indexedOperations={},this[r].indexes={},this[r].operations.length=0,this[r].queueRootIndex=void 0,(u=(c=this.ref)[g])==null||u.call(c),this.isNew=!1}discard(r=!1){var c,u;(u=(c=this.ref)[g])==null||u.call(c),this.indexedOperations={},this.changes.indexes={},this.changes.operations.length=0,this.changes.queueRootIndex=void 0,this.filteredChanges!==void 0&&(this.filteredChanges.indexes={},this.filteredChanges.operations.length=0,this.filteredChanges.queueRootIndex=void 0),r&&(this.allChanges.indexes={},this.allChanges.operations.length=0,this.allFilteredChanges!==void 0&&(this.allFilteredChanges.indexes={},this.allFilteredChanges.operations.length=0),this.forEachChild((y,x)=>{var v;return(v=this.root)==null?void 0:v.remove(y)}))}discardAll(){const r=Object.keys(this.indexedOperations);for(let c=0,u=r.length;c<u;c++){const y=this.getValue(Number(r[c]));y&&y[f]&&y[f].discardAll()}this.discard()}ensureRefId(){this.refId===void 0&&(this.refId=this.root.getNextUniqueId())}get changed(){return Object.entries(this.indexedOperations).length>0}checkIsFiltered(r,c){const u=this.root.add(this);this.root.types.hasFilters&&(this._checkFilteredByParent(r,c),this.filteredChanges!==void 0&&(Me(this.root,this,"filteredChanges"),u&&this.root.allFilteredChanges.push(this))),this.isFiltered||(Me(this.root,this,"changes"),u&&this.root.allChanges.push(this))}_checkFilteredByParent(r,c){if(!r)return;const u=Te.isValidInstance(this.ref)?this.ref.constructor:this.ref[h];let y,x=!Te.isValidInstance(r);x?(y=r[f],r=y.parent,c=y.parentIndex):y=r[f];const v=r.constructor;let O=`${this.root.types.getTypeId(u)}`;v&&(O+=`-${this.root.types.schemas.get(v)}`),O+=`-${c}`;const R=Te.hasViewTagAtIndex(v==null?void 0:v[Symbol.metadata],c);this.isFiltered=r[f].isFiltered||this.root.types.parentFiltered[O]||R,this.isFiltered&&(this.isVisibilitySharedWithParent=y.isFiltered&&typeof u!="string"&&!R&&x,this.filteredChanges||(this.filteredChanges=Mn(),this.allFilteredChanges=Mn()),this.changes.operations.length>0&&(this.changes.operations.forEach(V=>Le(this.filteredChanges,V)),this.allChanges.operations.forEach(V=>Le(this.allFilteredChanges,V)),this.changes=Mn(),this.allChanges=Mn()))}}function Ss(w,r,c,u,y,x){var v;typeof c=="string"?(v=Be[c])==null||v.call(Be,r,u,x):c[Symbol.metadata]!==void 0?(Be.number(r,u[f].refId,x),(y&t.OPERATION.ADD)===t.OPERATION.ADD&&w.tryEncodeTypeId(r,c,u.constructor,x)):Be.number(r,u[f].refId,x)}const zi=function(w,r,c,u,y,x,v,O,R){if(r[x.offset++]=(u|y)&255,y===t.OPERATION.DELETE)return;const V=c.ref,H=R[u];Ss(w,r,R[u].type,V[H.name],y,x)},Cn=function(w,r,c,u,y,x){if(r[x.offset++]=y&255,y===t.OPERATION.CLEAR||(Be.number(r,u,x),y===t.OPERATION.DELETE))return;const v=c.ref;if((y&t.OPERATION.ADD)===t.OPERATION.ADD&&typeof v.set=="function"){const V=c.ref.$indexes.get(u);Be.string(r,V,x)}const O=v[h],R=v[p](u);Ss(w,r,O,R,y,x)},Hi=function(w,r,c,u,y,x,v,O){const R=c.ref,V=O&&c.isFiltered&&typeof c.getType(u)!="string";let H;if(V?(H=R.tmpItems[u][f].refId,y===t.OPERATION.DELETE?y=t.OPERATION.DELETE_BY_REFID:y===t.OPERATION.ADD&&(y=t.OPERATION.ADD_BY_REFID)):H=u,r[x.offset++]=y&255,y===t.OPERATION.CLEAR||y===t.OPERATION.REVERSE||(Be.number(r,H,x),y===t.OPERATION.DELETE||y===t.OPERATION.DELETE_BY_REFID))return;const K=c.getType(u),q=c.getValue(u,v);Ss(w,r,K,q,y,x)},qi=-1;function vs(w,r,c,u,y,x,v,O){const R=w.root,V=c[p](u);let H;if((r&t.OPERATION.DELETE)===t.OPERATION.DELETE){const K=R.refIds.get(V);K!==void 0&&R.removeRef(K),r!==t.OPERATION.DELETE_AND_ADD&&c[m](u),H=void 0}if(r!==t.OPERATION.DELETE)if(be.is(y)){const K=$e.number(x,v);if(H=R.refs.get(K),(r&t.OPERATION.ADD)===t.OPERATION.ADD){const q=w.getInstanceType(x,v,y);H||(H=w.createInstanceOfType(q)),R.addRef(K,H,H!==V||r===t.OPERATION.DELETE_AND_ADD&&H===V)}}else if(typeof y=="string")H=$e[y](x,v);else{const K=an(Object.keys(y)[0]),q=$e.number(x,v),ie=R.refs.has(q)?V||R.refs.get(q):new K.constructor;if(H=ie.clone(!0),H[h]=Object.values(y)[0],V){let ne=R.refIds.get(V);if(ne!==void 0&&q!==ne){const Z=V.entries();let G;for(;(G=Z.next())&&!G.done;){const[se,ue]=G.value;typeof ue=="object"&&(ne=R.refIds.get(ue),R.removeRef(ne)),O.push({ref:V,refId:ne,op:t.OPERATION.DELETE,field:se,value:void 0,previousValue:ue})}}}R.addRef(q,H,ie!==V||r===t.OPERATION.DELETE_AND_ADD&&ie===V)}return{value:H,previousValue:V}}const Wi=function(w,r,c,u,y){const x=r[c.offset++],v=u.constructor[Symbol.metadata],O=x>>6<<6,R=x%(O||255),V=v[R];if(V===void 0)return console.warn("@colyseus/schema: field not defined at",{index:R,ref:u.constructor.name,metadata:v}),qi;const{value:H,previousValue:K}=vs(w,O,u,R,V.type,r,c,y);H!=null&&(u[V.name]=H),K!==H&&y.push({ref:u,refId:w.currentRefId,op:O,field:V.name,value:H,previousValue:K})},Rn=function(w,r,c,u,y){const x=r[c.offset++];if(x===t.OPERATION.CLEAR){w.removeChildRefs(u,y),u.clear();return}const v=$e.number(r,c),O=u[h];let R;(x&t.OPERATION.ADD)===t.OPERATION.ADD?typeof u.set=="function"?(R=$e.string(r,c),u.setIndex(v,R)):R=v:R=u.getIndex(v);const{value:V,previousValue:H}=vs(w,x,u,v,O,r,c,y);if(V!=null){if(typeof u.set=="function")u.$items.set(R,V);else if(typeof u.$setAt=="function")u.$setAt(v,V,x);else if(typeof u.add=="function"){const K=u.add(V);typeof K=="number"&&u.setIndex(K,K)}}H!==V&&y.push({ref:u,refId:w.currentRefId,op:x,field:"",dynamicIndex:R,value:V,previousValue:H})},Ya=function(w,r,c,u,y){let x=r[c.offset++],v;if(x===t.OPERATION.CLEAR){w.removeChildRefs(u,y),u.clear();return}else if(x===t.OPERATION.REVERSE){u.reverse();return}else if(x===t.OPERATION.DELETE_BY_REFID){const K=$e.number(r,c),q=w.root.refs.get(K);v=u.findIndex(ie=>ie===q),u[m](v),y.push({ref:u,refId:w.currentRefId,op:t.OPERATION.DELETE,field:"",dynamicIndex:v,value:void 0,previousValue:q});return}else if(x===t.OPERATION.ADD_BY_REFID){const K=$e.number(r,c),q=w.root.refs.get(K);q&&(v=u.findIndex(ie=>ie===q)),(v===-1||v===void 0)&&(v=u.length)}else v=$e.number(r,c);const O=u[h];let R=v;const{value:V,previousValue:H}=vs(w,x,u,v,O,r,c,y);V!=null&&V!==H&&u.$setAt(v,V,x),H!==V&&y.push({ref:u,refId:w.currentRefId,op:x,field:"",dynamicIndex:R,value:V,previousValue:H})};class Gi extends Error{}function Xa(w,r,c,u){let y,x=!1;switch(r){case"number":case"int8":case"uint8":case"int16":case"uint16":case"int32":case"uint32":case"int64":case"uint64":case"float32":case"float64":y="number",isNaN(w)&&`${c.constructor.name}${u}`;break;case"bigint64":case"biguint64":y="bigint";break;case"string":y="string",x=!0;break;case"boolean":return;default:return}if(typeof w!==y&&(!x||x&&w!==null)){let v=`'${JSON.stringify(w)}'${w&&w.constructor&&` (${w.constructor.name})`||""}`;throw new Gi(`a '${y}' was expected, but ${v} was provided in ${c.constructor.name}#${u}`)}}function Dn(w,r,c,u){if(!(w instanceof r))throw new Gi(`a '${r.name}' was expected, but '${w&&w.constructor.name}' was provided in ${c.constructor.name}#${u}`)}var Ji,Ki;const Za=(w,r)=>{const c=w.toString(),u=r.toString();return c<u?-1:c>u?1:0},Ke=class Ke{static[(Ji=a,Ki=l,d)](r,c,u){var y;return!u||typeof r[h]=="string"||u.isChangeTreeVisible((y=r.tmpItems[c])==null?void 0:y[f])}static is(r){return Array.isArray(r)||r.array!==void 0}static from(r){return new Ke(...Array.from(r))}constructor(...r){this.items=[],this.tmpItems=[],this.deletedIndexes={},this.isMovingItems=!1,Object.defineProperty(this,h,{value:void 0,enumerable:!1,writable:!0,configurable:!0});const c=new Proxy(this,{get:(u,y)=>typeof y!="symbol"&&!isNaN(y)?this.items[y]:Reflect.get(u,y),set:(u,y,x)=>{var v;if(typeof y!="symbol"&&!isNaN(y)){if(x==null)u.$deleteAt(y);else{if(x[f]){Dn(x,u[h],u,y);const O=u.items[y];u.isMovingItems?(O!==void 0?x[f].isNew?u[f].indexedOperation(Number(y),t.OPERATION.MOVE_AND_ADD):(u[f].getChange(Number(y))&t.OPERATION.DELETE)===t.OPERATION.DELETE?u[f].indexedOperation(Number(y),t.OPERATION.DELETE_AND_MOVE):u[f].indexedOperation(Number(y),t.OPERATION.MOVE):x[f].isNew&&u[f].indexedOperation(Number(y),t.OPERATION.ADD),x[f].setParent(this,u[f].root,y)):u.$changeAt(Number(y),x),O!==void 0&&((v=O[f].root)==null||v.remove(O[f]))}else u.$changeAt(Number(y),x);u.items[y]=x,u.tmpItems[y]=x}return!0}else return Reflect.set(u,y,x)},deleteProperty:(u,y)=>(typeof y=="number"?u.$deleteAt(y):delete u[y],!0),has:(u,y)=>typeof y!="symbol"&&!isNaN(Number(y))?Reflect.has(this.items,y):Reflect.has(u,y)});return this[f]=new Nt(c),this[f].indexes={},r.length>0&&this.push(...r),c}set length(r){r===0?this.clear():r<this.items.length?this.splice(r,this.length-r):console.warn("ArraySchema: can't set .length to a higher value than its length.")}get length(){return this.items.length}push(...r){var y;let c=this.tmpItems.length;const u=this[f];for(let x=0,v=r.length;x<r.length;x++,c++){const O=r[x];if(O==null)return;typeof O=="object"&&this[h]&&Dn(O,this[h],this,x),u.indexedOperation(c,t.OPERATION.ADD,this.items.length),this.items.push(O),this.tmpItems.push(O),(y=O[f])==null||y.setParent(this,u.root,c)}return c}pop(){let r=-1;for(let c=this.tmpItems.length-1;c>=0;c--)if(this.deletedIndexes[c]!==!0){r=c;break}if(!(r<0))return this[f].delete(r,void 0,this.items.length-1),this.deletedIndexes[r]=!0,this.items.pop()}at(r){return r<0&&(r+=this.length),this.items[r]}$changeAt(r,c){var x;if(c==null){console.error("ArraySchema items cannot be null nor undefined; Use `deleteAt(index)` instead.");return}if(this.items[r]===c)return;const u=this.items[r]!==void 0?typeof c=="object"?t.OPERATION.DELETE_AND_ADD:t.OPERATION.REPLACE:t.OPERATION.ADD,y=this[f];y.change(r,u),(x=c[f])==null||x.setParent(this,y.root,r)}$deleteAt(r,c){this[f].delete(r,c)}$setAt(r,c,u){r===0&&u===t.OPERATION.ADD&&this.items[r]!==void 0?this.items.unshift(c):u===t.OPERATION.DELETE_AND_MOVE?(this.items.splice(r,1),this.items[r]=c):this.items[r]=c}clear(){if(this.items.length===0)return;const r=this[f];r.forEachChild((c,u)=>{c.discard(!0);const y=c.root;y!==void 0&&(y.removeChangeFromChangeSet("changes",c),y.removeChangeFromChangeSet("allChanges",c),y.removeChangeFromChangeSet("allFilteredChanges",c))}),r.discard(!0),r.operation(t.OPERATION.CLEAR),this.items.length=0,this.tmpItems.length=0}concat(...r){return new Ke(...this.items.concat(...r))}join(r){return this.items.join(r)}reverse(){return this[f].operation(t.OPERATION.REVERSE),this.items.reverse(),this.tmpItems.reverse(),this}shift(){if(this.items.length===0)return;const r=this[f],c=this.tmpItems.findIndex(y=>y===this.items[0]),u=this.items.findIndex(y=>y===this.items[0]);return r.delete(c,t.OPERATION.DELETE,u),r.shiftAllChangeIndexes(-1,u),this.items.shift()}slice(r,c){const u=new Ke;return u.push(...this.items.slice(r,c)),u}sort(r=Za){this.isMovingItems=!0;const c=this[f];return this.items.sort(r).forEach((y,x)=>c.change(x,t.OPERATION.REPLACE)),this.tmpItems.sort(r),this.isMovingItems=!1,this}splice(r,c,...u){var V;const y=this[f],x=this.items.length,v=this.tmpItems.length,O=u.length,R=[];for(let H=0;H<v;H++)this.deletedIndexes[H]!==!0&&R.push(H);if(x>r){c===void 0&&(c=x-r);for(let H=r;H<r+c;H++){const K=R[H];y.delete(K,t.OPERATION.DELETE),this.deletedIndexes[K]=!0}}else c=0;if(O>0){if(O>c)throw console.error("Inserting more elements than deleting during ArraySchema#splice()"),new Error("ArraySchema#splice(): insertCount must be equal or lower than deleteCount.");for(let H=0;H<O;H++){const K=(R[r]??x)+H;y.indexedOperation(K,this.deletedIndexes[K]?t.OPERATION.DELETE_AND_ADD:t.OPERATION.ADD),(V=u[H][f])==null||V.setParent(this,y.root,K)}}return c>O&&y.shiftAllChangeIndexes(-(c-O),R[r+O]),y.filteredChanges!==void 0?Me(y.root,y,"filteredChanges"):Me(y.root,y,"changes"),this.items.splice(r,c,...u)}unshift(...r){const c=this[f];return c.shiftChangeIndexes(r.length),c.isFiltered?Le(c.filteredChanges,this.items.length):Le(c.allChanges,this.items.length),r.forEach((u,y)=>{c.change(y,t.OPERATION.ADD)}),this.tmpItems.unshift(...r),this.items.unshift(...r)}indexOf(r,c){return this.items.indexOf(r,c)}lastIndexOf(r,c=this.length-1){return this.items.lastIndexOf(r,c)}every(r,c){return this.items.every(r,c)}some(r,c){return this.items.some(r,c)}forEach(r,c){return this.items.forEach(r,c)}map(r,c){return this.items.map(r,c)}filter(r,c){return this.items.filter(r,c)}reduce(r,c){return this.items.reduce(r,c)}reduceRight(r,c){return this.items.reduceRight(r,c)}find(r,c){return this.items.find(r,c)}findIndex(r,c){return this.items.findIndex(r,c)}fill(r,c,u){throw new Error("ArraySchema#fill() not implemented")}copyWithin(r,c,u){throw new Error("ArraySchema#copyWithin() not implemented")}toString(){return this.items.toString()}toLocaleString(){return this.items.toLocaleString()}[Symbol.iterator](){return this.items[Symbol.iterator]()}static get[Symbol.species](){return Ke}entries(){return this.items.entries()}keys(){return this.items.keys()}values(){return this.items.values()}includes(r,c){return this.items.includes(r,c)}flatMap(r,c){throw new Error("ArraySchema#flatMap() is not supported.")}flat(r){throw new Error("ArraySchema#flat() is not supported.")}findLast(){return this.items.findLast.apply(this.items,arguments)}findLastIndex(...r){return this.items.findLastIndex.apply(this.items,arguments)}with(r,c){const u=this.items.slice();return r<0&&(r+=this.length),u[r]=c,new Ke(...u)}toReversed(){return this.items.slice().reverse()}toSorted(r){return this.items.slice().sort(r)}toSpliced(r,c,...u){return this.items.toSpliced.apply(copy,arguments)}shuffle(){return this.move(r=>{let c=this.items.length;for(;c!=0;){let u=Math.floor(Math.random()*c);c--,[this[c],this[u]]=[this[u],this[c]]}})}move(r){return this.isMovingItems=!0,r(this),this.isMovingItems=!1,this}[p](r,c=!1){return c?this.items[r]:this.deletedIndexes[r]?this.items[r]:this.tmpItems[r]||this.items[r]}[m](r){this.items[r]=void 0,this.tmpItems[r]=void 0}[g](){this.tmpItems=this.items.slice(),this.deletedIndexes={}}[E](){this.items=this.items.filter(r=>r!==void 0),this.tmpItems=this.items.slice()}toArray(){return this.items.slice(0)}toJSON(){return this.toArray().map(r=>typeof r.toJSON=="function"?r.toJSON():r)}clone(r){let c;return r?(c=new Ke,c.push(...this.items)):c=new Ke(...this.map(u=>u[f]?u.clone():u)),c}};Ke[Ji]=Hi,Ke[Ki]=Ya;let it=Ke;nt("array",{constructor:it});var Yi,Xi;const mt=class mt{static[(Yi=a,Xi=l,d)](r,c,u){return!u||typeof r[h]=="string"||u.isChangeTreeVisible((r[p](c)??r.deletedItems[c])[f])}static is(r){return r.map!==void 0}constructor(r){if(this.$items=new Map,this.$indexes=new Map,this.deletedItems={},this[f]=new Nt(this),this[f].indexes={},r)if(r instanceof Map||r instanceof mt)r.forEach((c,u)=>this.set(u,c));else for(const c in r)this.set(c,r[c]);Object.defineProperty(this,h,{value:void 0,enumerable:!1,writable:!0,configurable:!0})}[Symbol.iterator](){return this.$items[Symbol.iterator]()}get[Symbol.toStringTag](){return this.$items[Symbol.toStringTag]}static get[Symbol.species](){return mt}set(r,c){var O;if(c==null)throw new Error(`MapSchema#set('${r}', ${c}): trying to set ${c} value on '${r}'.`);typeof c=="object"&&this[h]&&Dn(c,this[h],this,r),r=r.toString();const u=this[f],y=c[f]!==void 0;let x,v;if(typeof u.indexes[r]<"u"){x=u.indexes[r],v=t.OPERATION.REPLACE;const R=this.$items.get(r);if(R===c)return;y&&(v=t.OPERATION.DELETE_AND_ADD,R!==void 0&&((O=R[f].root)==null||O.remove(R[f])))}else x=u.indexes[b]??0,v=t.OPERATION.ADD,this.$indexes.set(x,r),u.indexes[r]=x,u.indexes[b]=x+1;return this.$items.set(r,c),u.change(x,v),y&&c[f].setParent(this,u.root,x),this}get(r){return this.$items.get(r)}delete(r){const c=this[f].indexes[r];return this.deletedItems[c]=this[f].delete(c),this.$items.delete(r)}clear(){const r=this[f];r.discard(!0),r.indexes={},this.$indexes.clear(),this.$items.clear(),r.operation(t.OPERATION.CLEAR)}has(r){return this.$items.has(r)}forEach(r){this.$items.forEach(r)}entries(){return this.$items.entries()}keys(){return this.$items.keys()}values(){return this.$items.values()}get size(){return this.$items.size}setIndex(r,c){this.$indexes.set(r,c)}getIndex(r){return this.$indexes.get(r)}[p](r){return this.$items.get(this.$indexes.get(r))}[m](r){const c=this.$indexes.get(r);this.$items.delete(c),this.$indexes.delete(r)}[g](){this.deletedItems={}}toJSON(){const r={};return this.forEach((c,u)=>{r[u]=typeof c.toJSON=="function"?c.toJSON():c}),r}clone(r){let c;return r?c=Object.assign(new mt,this):(c=new mt,this.forEach((u,y)=>{u[f]?c.set(y,u.clone()):c.set(y,u)})),c}};mt[Yi]=Cn,mt[Xi]=Rn;let dt=mt;nt("map",{constructor:dt});const ct=-1;function Qa(w){return st.register(w),w}function Zi(w=ct){return function(r,c){var O;const u=r.constructor,x=Object.getPrototypeOf(u)[Symbol.metadata],v=u[O=Symbol.metadata]??(u[O]=Object.assign({},u[Symbol.metadata],x??Object.create(null)));Te.setTag(v,c,w)}}function Je(w,r){return function(c,u){const y=c.constructor;if(!w)throw new Error(`${y.name}: @type() reference provided for "${u}" is undefined. Make sure you don't have any circular dependencies.`);st.register(y);const v=Object.getPrototypeOf(y)[Symbol.metadata],O=Te.initialize(y);let R=O[u];if(O[R]!==void 0){if(O[R].deprecated)return;if(O[R].type!==void 0)try{throw new Error(`@colyseus/schema: Duplicate '${u}' definition on '${y.name}'.
Check @type() annotation`)}catch(V){const H=V.stack.split(`
`)[4].trim();throw new Error(`${V.message} ${H}`)}}else R=O[b]??(v&&v[b])??-1,R++;if(r&&r.manual)Te.addField(O,R,u,w,{enumerable:!0,configurable:!0,writable:!0});else{const V=Array.isArray(w)?an("array"):typeof Object.keys(w)[0]=="string"&&an(Object.keys(w)[0]),H=V?Object.values(w)[0]:w;Te.addField(O,R,u,w,Qi(`_${u}`,R,H,V))}}}function Qi(w,r,c,u){return{get:function(){return this[w]},set:function(y){var v,O;const x=this[w]??void 0;if(y!==x){if(y!=null){u?(u.constructor===it&&!(y instanceof it)&&(y=new it(...y)),u.constructor===dt&&!(y instanceof dt)&&(y=new dt(y)),y[h]=c):typeof c!="string"?Dn(y,c,this,w.substring(1)):Xa(y,c,this,w.substring(1));const R=this[f];x!==void 0&&x[f]?((v=R.root)==null||v.remove(x[f]),this.constructor[o](R,r,t.OPERATION.DELETE_AND_ADD)):this.constructor[o](R,r,t.OPERATION.ADD),(O=y[f])==null||O.setParent(this,R.root,r)}else x!==void 0&&this[f].delete(r);this[w]=y}},enumerable:!0,configurable:!0}}function ec(w=!0){return function(r,c){var R;const u=r.constructor,x=Object.getPrototypeOf(u)[Symbol.metadata],v=u[R=Symbol.metadata]??(u[R]=Object.assign({},u[Symbol.metadata],x??Object.create(null))),O=v[c];v[O].deprecated=!0,w&&(v[A]??(v[A]={}),v[A][c]={get:function(){throw new Error(`${c} is deprecated.`)},set:function(V){},enumerable:!1,configurable:!0}),Object.defineProperty(v,O,{value:v[O],enumerable:!1,configurable:!0})}}function tc(w,r,c){for(let u in r)Je(r[u],c)(w.prototype,u);return w}function er(w,r,c=be){const u={},y={};for(let v in w){const O=w[v];typeof O=="object"&&(O.default!==void 0&&(u[v]=O.default),O.view!==void 0&&(y[v]=typeof O.view=="boolean"?ct:O.view))}const x=Te.setFields(class extends c{constructor(...v){v[0]=Object.assign({},u,v[0]),super(...v)}},w);for(let v in y)Zi(y[v])(x.prototype,v);return r&&Object.defineProperty(x,"name",{value:r}),x.extends=(v,O)=>er(v,O,x),x}function Bn(w){return new Array(w).fill(0).map((r,c)=>c===w-1?" ":"   ").join("")}function nc(w){const r=w[f].root,c={ops:{},refs:[]};return r.changes.forEach(u=>{if(u===void 0)return;const y=u.indexedOperations;c.refs.push(`refId#${u.refId}`);for(const x in y){const v=y[x],O=t.OPERATION[v];c.ops[O]||(c.ops[O]=0),c.ops[t.OPERATION[v]]++}}),c}var tr,nr;const fn=class fn{static initialize(r){var c;Object.defineProperty(r,f,{value:new Nt(r),enumerable:!1,writable:!0}),Object.defineProperties(r,((c=r.constructor[Symbol.metadata])==null?void 0:c[A])||{})}static is(r){return typeof r[Symbol.metadata]=="object"}static[(tr=a,nr=l,o)](r,c,u=t.OPERATION.ADD){r.change(c,u)}static[d](r,c,u){var v,O;const x=(v=r.constructor[Symbol.metadata][c])==null?void 0:v.tag;if(u===void 0)return x===void 0;if(x===void 0)return!0;if(x===ct)return u.isChangeTreeVisible(r[f]);{const R=(O=u.tags)==null?void 0:O.get(r[f]);return R&&R.has(x)}}constructor(...r){fn.initialize(this),r[0]&&Object.assign(this,r[0])}assign(r){return Object.assign(this,r),this}setDirty(r,c){const u=this.constructor[Symbol.metadata];this[f].change(u[u[r]].index,c)}clone(){var u;const r=new this.constructor,c=this.constructor[Symbol.metadata];for(const y in c){const x=c[y].name;typeof this[x]=="object"&&typeof((u=this[x])==null?void 0:u.clone)=="function"?r[x]=this[x].clone():r[x]=this[x]}return r}toJSON(){const r={},c=this.constructor[Symbol.metadata];for(const u in c){const y=c[u],x=y.name;!y.deprecated&&this[x]!==null&&typeof this[x]<"u"&&(r[x]=typeof this[x].toJSON=="function"?this[x].toJSON():this[x])}return r}discardAllChanges(){this[f].discardAll()}[p](r){const c=this.constructor[Symbol.metadata];return this[c[r].name]}[m](r){const c=this.constructor[Symbol.metadata];this[c[r].name]=void 0}static debugRefIds(r,c=!1,u=0){const y=c?` - ${JSON.stringify(r.toJSON())}`:"",x=r[f],v=x.refId;let O="";return O+=`${Bn(u)}${r.constructor.name} (refId: ${v})${y}
`,x.forEachChild(R=>O+=this.debugRefIds(R.ref,c,u+1)),O}static debugChanges(r,c=!1){const u=r[f],y=c?u.allChanges:u.changes,x=c?"allChanges":"changes";let v=`${r.constructor.name} (${u.refId}) -> .${x}:
`;function O(R){R.operations.filter(V=>V).forEach(V=>{const H=u.indexedOperations[V];v+=`- [${V}]: ${t.OPERATION[H]} (${JSON.stringify(u.getValue(Number(V),c))})
`})}return O(y),!c&&u.filteredChanges&&u.filteredChanges.operations.filter(R=>R).length>0&&(v+=`${r.constructor.name} (${u.refId}) -> .filteredChanges:
`,O(u.filteredChanges)),c&&u.allFilteredChanges&&u.allFilteredChanges.operations.filter(R=>R).length>0&&(v+=`${r.constructor.name} (${u.refId}) -> .allFilteredChanges:
`,O(u.allFilteredChanges)),v}static debugChangesDeep(r,c="changes"){var H,K;let u="";const y=r[f],x=y.root,v=new Map,O=[];let R=0;for(const[q,ie]of Object.entries(x[c])){const ne=x.changeTrees[q];let Z=!1,G=[],se=(H=ne.parent)==null?void 0:H[f];if(ne===y)Z=!0;else for(;se!==void 0;){if(G.push(se),se.ref===r){Z=!0;break}se=(K=se.parent)==null?void 0:K[f]}Z&&(O.push(ne.refId),R+=Object.keys(ie).length,v.set(ne,G.reverse()))}u+=`---
`,u+=`root refId: ${y.refId}
`,u+=`Total instances: ${O.length} (refIds: ${O.join(", ")})
`,u+=`Total changes: ${R}
`,u+=`---
`;const V=new WeakSet;for(const[q,ie]of v.entries()){ie.forEach((ue,we)=>{V.has(ue)||(u+=`${Bn(we)}${ue.ref.constructor.name} (refId: ${ue.refId})
`,V.add(ue))});const ne=q.indexedOperations,Z=ie.length,G=Bn(Z),se=Z>0?`(${q.parentIndex}) `:"";u+=`${G}${se}${q.ref.constructor.name} (refId: ${q.refId}) - changes: ${Object.keys(ne).length}
`;for(const ue in ne){const we=ne[ue];u+=`${Bn(Z+1)}${t.OPERATION[we]}: ${ue}
`}}return`${u}`}};fn[tr]=zi,fn[nr]=Wi;let be=fn;var sr,ir;const Vt=class Vt{static[(sr=a,ir=l,d)](r,c,u){return!u||typeof r[h]=="string"||u.isChangeTreeVisible((r[p](c)??r.deletedItems[c])[f])}static is(r){return r.collection!==void 0}constructor(r){this.$items=new Map,this.$indexes=new Map,this.deletedItems={},this.$refId=0,this[f]=new Nt(this),this[f].indexes={},r&&r.forEach(c=>this.add(c)),Object.defineProperty(this,h,{value:void 0,enumerable:!1,writable:!0,configurable:!0})}add(r){const c=this.$refId++;return r[f]!==void 0&&r[f].setParent(this,this[f].root,c),this[f].indexes[c]=c,this.$indexes.set(c,c),this.$items.set(c,r),this[f].change(c),c}at(r){const c=Array.from(this.$items.keys())[r];return this.$items.get(c)}entries(){return this.$items.entries()}delete(r){const c=this.$items.entries();let u,y;for(;(y=c.next())&&!y.done;)if(r===y.value[1]){u=y.value[0];break}return u===void 0?!1:(this.deletedItems[u]=this[f].delete(u),this.$indexes.delete(u),this.$items.delete(u))}clear(){const r=this[f];r.discard(!0),r.indexes={},this.$indexes.clear(),this.$items.clear(),r.operation(t.OPERATION.CLEAR)}has(r){return Array.from(this.$items.values()).some(c=>c===r)}forEach(r){this.$items.forEach((c,u,y)=>r(c,u,this))}values(){return this.$items.values()}get size(){return this.$items.size}[Symbol.iterator](){return this.$items.values()}setIndex(r,c){this.$indexes.set(r,c)}getIndex(r){return this.$indexes.get(r)}[p](r){return this.$items.get(this.$indexes.get(r))}[m](r){const c=this.$indexes.get(r);this.$items.delete(c),this.$indexes.delete(r)}[g](){this.deletedItems={}}toArray(){return Array.from(this.$items.values())}toJSON(){const r=[];return this.forEach((c,u)=>{r.push(typeof c.toJSON=="function"?c.toJSON():c)}),r}clone(r){let c;return r?c=Object.assign(new Vt,this):(c=new Vt,this.forEach(u=>{u[f]?c.add(u.clone()):c.add(u)})),c}};Vt[sr]=Cn,Vt[ir]=Rn;let cn=Vt;nt("collection",{constructor:cn});var rr,or;const Ut=class Ut{static[(rr=a,or=l,d)](r,c,u){return!u||typeof r[h]=="string"||u.visible.has((r[p](c)??r.deletedItems[c])[f])}static is(r){return r.set!==void 0}constructor(r){this.$items=new Map,this.$indexes=new Map,this.deletedItems={},this.$refId=0,this[f]=new Nt(this),this[f].indexes={},r&&r.forEach(c=>this.add(c)),Object.defineProperty(this,h,{value:void 0,enumerable:!1,writable:!0,configurable:!0})}add(r){var y;if(this.has(r))return!1;const c=this.$refId++;r[f]!==void 0&&r[f].setParent(this,this[f].root,c);const u=((y=this[f].indexes[c])==null?void 0:y.op)??t.OPERATION.ADD;return this[f].indexes[c]=c,this.$indexes.set(c,c),this.$items.set(c,r),this[f].change(c,u),c}entries(){return this.$items.entries()}delete(r){const c=this.$items.entries();let u,y;for(;(y=c.next())&&!y.done;)if(r===y.value[1]){u=y.value[0];break}return u===void 0?!1:(this.deletedItems[u]=this[f].delete(u),this.$indexes.delete(u),this.$items.delete(u))}clear(){const r=this[f];r.discard(!0),r.indexes={},this.$indexes.clear(),this.$items.clear(),r.operation(t.OPERATION.CLEAR)}has(r){const c=this.$items.values();let u=!1,y;for(;(y=c.next())&&!y.done;)if(r===y.value){u=!0;break}return u}forEach(r){this.$items.forEach((c,u,y)=>r(c,u,this))}values(){return this.$items.values()}get size(){return this.$items.size}[Symbol.iterator](){return this.$items.values()}setIndex(r,c){this.$indexes.set(r,c)}getIndex(r){return this.$indexes.get(r)}[p](r){return this.$items.get(this.$indexes.get(r))}[m](r){const c=this.$indexes.get(r);this.$items.delete(c),this.$indexes.delete(r)}[g](){this.deletedItems={}}toArray(){return Array.from(this.$items.values())}toJSON(){const r=[];return this.forEach((c,u)=>{r.push(typeof c.toJSON=="function"?c.toJSON():c)}),r}clone(r){let c;return r?c=Object.assign(new Ut,this):(c=new Ut,this.forEach(u=>{u[f]?c.add(u.clone()):c.add(u)})),c}};Ut[rr]=Cn,Ut[or]=Rn;let ln=Ut;nt("set",{constructor:ln});function pt(w,r,c,u){var y=arguments.length,x=y<3?r:u,v;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")x=Reflect.decorate(w,r,c,u);else for(var O=w.length-1;O>=0;O--)(v=w[O])&&(x=(y<3?v(x):y>3?v(r,c,x):v(r,c))||x);return y>3&&x&&Object.defineProperty(r,c,x),x}typeof SuppressedError=="function"&&SuppressedError;class sc{constructor(r){this.types=r,this.nextUniqueId=0,this.refCount={},this.changeTrees={},this.allChanges=[],this.allFilteredChanges=[],this.changes=[],this.filteredChanges=[]}getNextUniqueId(){return this.nextUniqueId++}add(r){r.ensureRefId();const c=this.changeTrees[r.refId]===void 0;c&&(this.changeTrees[r.refId]=r);const u=this.refCount[r.refId];if(u===0){const y=r.allChanges.operations;let x=y.length;for(;x--;)r.indexedOperations[y[x]]=t.OPERATION.ADD,Le(r.changes,x)}return this.refCount[r.refId]=(u||0)+1,c}remove(r){const c=this.refCount[r.refId]-1;return c<=0?(r.root=void 0,delete this.changeTrees[r.refId],this.removeChangeFromChangeSet("allChanges",r),this.removeChangeFromChangeSet("changes",r),r.filteredChanges&&(this.removeChangeFromChangeSet("allFilteredChanges",r),this.removeChangeFromChangeSet("filteredChanges",r)),this.refCount[r.refId]=0):(this.refCount[r.refId]=c,r.filteredChanges!==void 0?(this.removeChangeFromChangeSet("filteredChanges",r),Me(this,r,"filteredChanges")):(this.removeChangeFromChangeSet("changes",r),Me(this,r,"changes"))),r.forEachChild((u,y)=>this.remove(u)),c}removeChangeFromChangeSet(r,c){const u=this[r],y=u.indexOf(c);if(y!==-1)return c[r].queueRootIndex=-1,u[y]=void 0,!0}clear(){this.changes.length=0}}const Ln=class Ln{constructor(r){this.sharedBuffer=Buffer.allocUnsafe(Ln.BUFFER_SIZE),this.context=st.cache(r.constructor),this.root=new sc(this.context),this.setState(r)}setState(r){this.state=r,this.state[f].setRoot(this.root)}encode(r={offset:0},c,u=this.sharedBuffer,y="changes",x=y==="allChanges",v=r.offset){const O=c!==void 0,R=this.state[f],V=this.root[y];for(let H=0,K=V.length;H<K;H++){const q=V[H];if(!q)continue;if(O){if(!c.isChangeTreeVisible(q)){c.invisible.add(q);continue}c.invisible.delete(q)}const ie=q[y],ne=q.ref,Z=ie.operations.length;if(Z===0)continue;const G=ne.constructor,se=G[a],ue=G[d],we=G[Symbol.metadata];(O||r.offset>v||q!==R)&&(u[r.offset++]=255,Be.number(u,q.refId,r));for(let Ie=0;Ie<Z;Ie++){const Pe=ie.operations[Ie],gt=Pe<0?Math.abs(Pe):x?t.OPERATION.ADD:q.indexedOperations[Pe];Pe===void 0||gt===void 0||ue&&!ue(ne,Pe,c)||se(this,u,q,Pe,gt,r,x,O,we)}}if(r.offset>u.byteLength){const H=Math.ceil(r.offset/(Buffer.poolSize??8192))*(Buffer.poolSize??8192);return console.warn(`@colyseus/schema buffer overflow. Encoded state is higher than default BUFFER_SIZE. Use the following to increase default BUFFER_SIZE:

    import { Encoder } from "@colyseus/schema";
    Encoder.BUFFER_SIZE = ${Math.round(H/1024)} * 1024; // ${Math.round(H/1024)} KB
`),u=Buffer.alloc(H,u),u===this.sharedBuffer&&(this.sharedBuffer=u),this.encode({offset:v},c,u,y,x)}else return u.subarray(0,r.offset)}encodeAll(r={offset:0},c=this.sharedBuffer){return this.encode(r,void 0,c,"allChanges",!0)}encodeAllView(r,c,u,y=this.sharedBuffer){const x=u.offset;return this.encode(u,r,y,"allFilteredChanges",!0,x),Buffer.concat([y.subarray(0,c),y.subarray(x,u.offset)])}debugChanges(r){(typeof r=="string"?this.root[r]:r).forEach(u=>{const y=u[r],x=u.ref.constructor[Symbol.metadata];u.ref.constructor.name,u.refId,Object.keys(y).length;for(const v in y){const O=y[v];x==null||x[v],t.OPERATION[O]}})}encodeView(r,c,u,y=this.sharedBuffer){const x=u.offset;for(const[v,O]of r.changes){const R=this.root.changeTrees[v];if(R===void 0){r.changes.delete(v);continue}const V=Object.keys(O);if(V.length===0)continue;const K=R.ref.constructor,q=K[a],ie=K[Symbol.metadata];y[u.offset++]=255,Be.number(y,R.refId,u);for(let ne=0,Z=V.length;ne<Z;ne++){const G=Number(V[ne]),ue=R.ref[p](G)!==void 0&&O[G]||t.OPERATION.DELETE;q(this,y,R,G,ue,u,!1,!0,ie)}}return r.changes.clear(),this.encode(u,r,y,"filteredChanges",!1,x),Buffer.concat([y.subarray(0,c),y.subarray(x,u.offset)])}discardChanges(){var c,u;let r=this.root.changes.length;if(r>0){for(;r--;)(c=this.root.changes[r])==null||c.endEncode("changes");this.root.changes.length=0}if(r=this.root.filteredChanges.length,r>0){for(;r--;)(u=this.root.filteredChanges[r])==null||u.endEncode("filteredChanges");this.root.filteredChanges.length=0}}tryEncodeTypeId(r,c,u,y){const x=this.context.getTypeId(c),v=this.context.getTypeId(u);if(v===void 0){console.warn(`@colyseus/schema WARNING: Class "${u.name}" is not registered on TypeRegistry - Please either tag the class with @entity or define a @type() field.`);return}x!==v&&(r[y.offset++]=213,Be.number(r,v,y))}get hasChanges(){return this.root.changes.length>0||this.root.filteredChanges.length>0}};Ln.BUFFER_SIZE=typeof Buffer<"u"&&Buffer.poolSize||8*1024;let $n=Ln;function ar(w,r){if(r===-1||r>=w.length)return!1;const c=w.length-1;for(let u=r;u<c;u++)w[u]=w[u+1];return w.length=c,!0}class cr extends Error{constructor(r){super(r),this.name="DecodingWarning"}}class ic{constructor(){this.refs=new Map,this.refIds=new WeakMap,this.refCounts={},this.deletedRefs=new Set,this.callbacks={},this.nextUniqueId=0}getNextUniqueId(){return this.nextUniqueId++}addRef(r,c,u=!0){this.refs.set(r,c),this.refIds.set(c,r),u&&(this.refCounts[r]=(this.refCounts[r]||0)+1),this.deletedRefs.has(r)&&this.deletedRefs.delete(r)}removeRef(r){const c=this.refCounts[r];if(c===void 0){try{throw new cr("trying to remove refId that doesn't exist: "+r)}catch(u){console.warn(u)}return}if(c===0){try{const u=this.refs.get(r);throw new cr(`trying to remove refId '${r}' with 0 refCount (${u.constructor.name}: ${JSON.stringify(u)})`)}catch(u){console.warn(u)}return}(this.refCounts[r]=c-1)<=0&&this.deletedRefs.add(r)}clearRefs(){this.refs.clear(),this.deletedRefs.clear(),this.callbacks={},this.refCounts={}}garbageCollectDeletedRefs(){this.deletedRefs.forEach(r=>{if(this.refCounts[r]>0)return;const c=this.refs.get(r);if(c.constructor[Symbol.metadata]!==void 0){const u=c.constructor[Symbol.metadata];for(const y in u){const x=u[y].name,v=typeof c[x]=="object"&&this.refIds.get(c[x]);v&&!this.deletedRefs.has(v)&&this.removeRef(v)}}else typeof c[h]=="function"&&Array.from(c.values()).forEach(u=>{const y=this.refIds.get(u);this.deletedRefs.has(y)||this.removeRef(y)});this.refs.delete(r),delete this.refCounts[r],delete this.callbacks[r]}),this.deletedRefs.clear()}addCallback(r,c,u){if(r===void 0){const y=typeof c=="number"?t.OPERATION[c]:c;throw new Error(`Can't addCallback on '${y}' (refId is undefined)`)}return this.callbacks[r]||(this.callbacks[r]={}),this.callbacks[r][c]||(this.callbacks[r][c]=[]),this.callbacks[r][c].push(u),()=>this.removeCallback(r,c,u)}removeCallback(r,c,u){var x,v,O;const y=(O=(v=(x=this.callbacks)==null?void 0:x[r])==null?void 0:v[c])==null?void 0:O.indexOf(u);y!==void 0&&y!==-1&&ar(this.callbacks[r][c],y)}}class Ps{constructor(r,c){this.currentRefId=0,this.setState(r),this.context=c||new st(r.constructor)}setState(r){this.state=r,this.root=new ic,this.root.addRef(0,r)}decode(r,c={offset:0},u=this.state){var R,V,H;const y=[],x=this.root,v=r.byteLength;let O=u.constructor[l];for(this.currentRefId=0;c.offset<v;){if(r[c.offset]==255){c.offset++,this.currentRefId=$e.number(r,c);const q=x.refs.get(this.currentRefId);if(!q)throw new Error(`"refId" not found: ${this.currentRefId}`);(R=u[E])==null||R.call(u),u=q,O=u.constructor[l];continue}if(O(this,r,c,u,y)===qi){console.warn("@colyseus/schema: definition mismatch");const q={offset:c.offset};for(;c.offset<v&&!(r[c.offset]===255&&(q.offset=c.offset+1,x.refs.has($e.number(r,q))));)c.offset++;continue}}return(V=u[E])==null||V.call(u),(H=this.triggerChanges)==null||H.call(this,y),x.garbageCollectDeletedRefs(),y}getInstanceType(r,c,u){let y;if(r[c.offset]===213){c.offset++;const x=$e.number(r,c);y=this.context.get(x)}return y||u}createInstanceOfType(r){return new r}removeChildRefs(r,c){const u=typeof r[h]!="string",y=this.root.refIds.get(r);r.forEach((x,v)=>{c.push({ref:r,refId:y,op:t.OPERATION.DELETE,field:v,value:void 0,previousValue:x}),u&&this.root.removeRef(this.root.refIds.get(x))})}}class kt extends be{}pt([Je("string")],kt.prototype,"name",void 0),pt([Je("string")],kt.prototype,"type",void 0),pt([Je("number")],kt.prototype,"referencedType",void 0);class Ft extends be{constructor(){super(...arguments),this.fields=new it}}pt([Je("number")],Ft.prototype,"id",void 0),pt([Je("number")],Ft.prototype,"extendsId",void 0),pt([Je([kt])],Ft.prototype,"fields",void 0);class jt extends be{constructor(){super(...arguments),this.types=new it}static encode(r,c={offset:0}){const u=r.context,y=new jt,x=new $n(y),v=u.schemas.get(r.state.constructor);v>0&&(y.rootType=v);const O=new Set,R={},V=K=>{if(K.extendsId===void 0||O.has(K.extendsId)){O.add(K.id),y.types.push(K);const q=R[K.id];q!==void 0&&(delete R[K.id],q.forEach(ie=>V(ie)))}else R[K.extendsId]===void 0&&(R[K.extendsId]=[]),R[K.extendsId].push(K)};u.schemas.forEach((K,q)=>{const ie=new Ft;ie.id=Number(K);const ne=Object.getPrototypeOf(q);ne!==be&&(ie.extendsId=u.schemas.get(ne));const Z=q[Symbol.metadata];if(Z!==ne[Symbol.metadata])for(const G in Z){const se=Number(G),ue=Z[se].name;if(!Object.prototype.hasOwnProperty.call(Z,ue))continue;const we=new kt;we.name=ue;let Ie;const Pe=Z[se];if(typeof Pe.type=="string")Ie=Pe.type;else{let gt;be.is(Pe.type)?(Ie="ref",gt=Pe.type):(Ie=Object.keys(Pe.type)[0],typeof Pe.type[Ie]=="string"?Ie+=":"+Pe.type[Ie]:gt=Pe.type[Ie]),we.referencedType=gt?u.getTypeId(gt):-1}we.type=Ie,ie.fields.push(we)}V(ie)});for(const K in R)R[K].forEach(q=>y.types.push(q));const H=x.encodeAll(c);return Buffer.from(H,0,c.offset)}static decode(r,c){const u=new jt;new Ps(u).decode(r,c);const x=new st;u.types.forEach(R=>{const V=x.get(R.extendsId)??be,H=class extends V{};st.register(H),x.add(H,R.id)},{});const v=(R,V,H)=>{V.fields.forEach((K,q)=>{const ie=H+q;if(K.referencedType!==void 0){let ne=K.type,Z=x.get(K.referencedType);if(!Z){const G=K.type.split(":");ne=G[0],Z=G[1]}ne==="ref"?Te.addField(R,ie,K.name,Z):Te.addField(R,ie,K.name,{[ne]:Z})}else Te.addField(R,ie,K.name,K.type)})};u.types.forEach(R=>{const V=x.get(R.id),H=Te.initialize(V),K=[];let q=R;do K.push(q),q=u.types.find(ne=>ne.id===q.extendsId);while(q);let ie=0;K.reverse().forEach(ne=>{v(H,ne,ie),ie+=ne.fields.length})});const O=new(x.get(u.rootType||0));return new Ps(O,x)}}pt([Je([Ft])],jt.prototype,"types",void 0),pt([Je("number")],jt.prototype,"rootType",void 0);function rc(w){const r=w.root,c=r.callbacks,u=new WeakMap;let y;w.triggerChanges=function(O){var V;const R=new Set;for(let H=0,K=O.length;H<K;H++){const q=O[H],ie=q.refId,ne=q.ref,Z=c[ie];if(Z){if((q.op&t.OPERATION.DELETE)===t.OPERATION.DELETE&&q.previousValue instanceof be){const G=(V=c[r.refIds.get(q.previousValue)])==null?void 0:V[t.OPERATION.DELETE];for(let se=(G==null?void 0:G.length)-1;se>=0;se--)G[se]()}if(ne instanceof be){if(!R.has(ie)){const G=Z==null?void 0:Z[t.OPERATION.REPLACE];for(let se=(G==null?void 0:G.length)-1;se>=0;se--)G[se]()}if(Z.hasOwnProperty(q.field)){const G=Z[q.field];for(let se=(G==null?void 0:G.length)-1;se>=0;se--)G[se](q.value,q.previousValue)}}else{if((q.op&t.OPERATION.DELETE)===t.OPERATION.DELETE){if(q.previousValue!==void 0){const G=Z[t.OPERATION.DELETE];for(let se=(G==null?void 0:G.length)-1;se>=0;se--)G[se](q.previousValue,q.dynamicIndex??q.field)}if((q.op&t.OPERATION.ADD)===t.OPERATION.ADD){const G=Z[t.OPERATION.ADD];for(let se=(G==null?void 0:G.length)-1;se>=0;se--)G[se](q.value,q.dynamicIndex??q.field)}}else if((q.op&t.OPERATION.ADD)===t.OPERATION.ADD&&q.previousValue!==q.value){const G=Z[t.OPERATION.ADD];for(let se=(G==null?void 0:G.length)-1;se>=0;se--)G[se](q.value,q.dynamicIndex??q.field)}if(q.value!==q.previousValue&&(q.value!==void 0||q.previousValue!==void 0)){const G=Z[t.OPERATION.REPLACE];for(let se=(G==null?void 0:G.length)-1;se>=0;se--)G[se](q.value,q.dynamicIndex??q.field)}}R.add(ie)}}};function x(O,R){var K;let V=((K=R.instance)==null?void 0:K.constructor[Symbol.metadata])||O,H=R.instance&&typeof R.instance.forEach=="function"||O&&typeof O[Symbol.metadata]>"u";if(V&&!H){const q=function(ie,ne,Z,G){return G&&R.instance[ne]!==void 0&&!u.has(y)&&Z(R.instance[ne],void 0),r.addCallback(r.refIds.get(ie),ne,Z)};return new Proxy({listen:function(ne,Z,G=!0){if(R.instance)return q(R.instance,ne,Z,G);{let se=()=>{};return R.onInstanceAvailable((ue,we)=>{se=q(ue,ne,Z,G&&we&&!u.has(y))}),()=>se()}},onChange:function(ne){return r.addCallback(r.refIds.get(R.instance),t.OPERATION.REPLACE,ne)},bindTo:function(ne,Z){return Z||(Z=Object.keys(V).map(G=>V[G].name)),r.addCallback(r.refIds.get(R.instance),t.OPERATION.REPLACE,()=>{Z.forEach(G=>ne[G]=R.instance[G])})}},{get(ie,ne){var G;const Z=V[V[ne]];if(Z){const se=(G=R.instance)==null?void 0:G[ne],ue=we=>{const Ie=v(R.instance).listen(ne,(Pe,gt)=>{we(Pe,!1),Ie==null||Ie()},!1);r.refIds.get(se)!==void 0&&we(se,!0)};return x(Z.type,{instance:r.refIds.get(se)&&se,parentInstance:R.instance,onInstanceAvailable:ue})}else return ie[ne]},has(ie,ne){return V[ne]!==void 0},set(ie,ne,Z){throw new Error("not allowed")},deleteProperty(ie,ne){throw new Error("not allowed")}})}else{const q=function(Z,G,se){return se&&Z.forEach((ue,we)=>G(ue,we)),r.addCallback(r.refIds.get(Z),t.OPERATION.ADD,(ue,we)=>{u.set(G,!0),y=G,G(ue,we),u.delete(G),y=void 0})},ie=function(Z,G){return r.addCallback(r.refIds.get(Z),t.OPERATION.DELETE,G)},ne=function(Z,G){return r.addCallback(r.refIds.get(Z),t.OPERATION.REPLACE,G)};return new Proxy({onAdd:function(Z,G=!0){if(R.instance)return q(R.instance,Z,G&&!u.has(y));if(R.onInstanceAvailable){let se=()=>{};return R.onInstanceAvailable((ue,we)=>{se=q(ue,Z,G&&we&&!u.has(y))}),()=>se()}},onRemove:function(Z){if(R.instance)return ie(R.instance,Z);if(R.onInstanceAvailable){let G=()=>{};return R.onInstanceAvailable(se=>{G=ie(se,Z)}),()=>G()}},onChange:function(Z){if(R.instance)return ne(R.instance,Z);if(R.onInstanceAvailable){let G=()=>{};return R.onInstanceAvailable(se=>{G=ne(se,Z)}),()=>G()}}},{get(Z,G){if(!Z[G])throw new Error(`Can't access '${G}' through callback proxy. access the instance directly.`);return Z[G]},has(Z,G){return Z[G]!==void 0},set(Z,G,se){throw new Error("not allowed")},deleteProperty(Z,G){throw new Error("not allowed")}})}}function v(O){return x(void 0,{instance:O})}return v}function oc(w,r){w.triggerChanges=r}class ac{constructor(r=!1){this.iterable=r,this.visible=new WeakSet,this.invisible=new WeakSet,this.changes=new Map,r&&(this.items=[])}add(r,c=ct,u=!0){var O,R;const y=r==null?void 0:r[f];if(y){if(!y.parent&&y.refId!==0)throw new Error(`Cannot add a detached instance to the StateView. Make sure to assign the "${y.ref.constructor.name}" instance to the state before calling view.add()`)}else return console.warn("StateView#add(), invalid object:",r),this;const x=r.constructor[Symbol.metadata];this.visible.add(y),this.iterable&&u&&this.items.push(r),u&&y.parent&&this.addParentOf(y,c);let v=this.changes.get(y.refId);if(v===void 0&&(v={},this.changes.set(y.refId,v)),c!==ct){this.tags||(this.tags=new WeakMap);let V;this.tags.has(y)?V=this.tags.get(y):(V=new Set,this.tags.set(y,V)),V.add(c),(R=(O=x==null?void 0:x[M])==null?void 0:O[c])==null||R.forEach(H=>{y.getChange(H)!==t.OPERATION.DELETE&&(v[H]=t.OPERATION.ADD)})}else{const V=this.invisible.has(y),H=y.filteredChanges!==void 0?y.allFilteredChanges:y.allChanges;for(let K=0,q=H.operations.length;K<q;K++){const ie=H.operations[K];if(ie===void 0)continue;const ne=y.indexedOperations[ie]??t.OPERATION.ADD,Z=x==null?void 0:x[ie].tag;!y.isNew&&(V||Z===void 0||Z===c)&&ne!==t.OPERATION.DELETE&&(v[ie]=ne)}}return y.forEachChild((V,H)=>{x&&x[H].tag!==void 0&&x[H].tag!==c||this.add(V.ref,c,!1)}),this}addParentOf(r,c){var x;const u=r.parent[f],y=r.parentIndex;if(!this.visible.has(u)){this.visible.add(u);const v=(x=u.parent)==null?void 0:x[f];v&&v.filteredChanges!==void 0&&this.addParentOf(u,c)}if(u.getChange(y)!==t.OPERATION.DELETE){let v=this.changes.get(u.refId);v===void 0&&(v={},this.changes.set(u.refId,v)),this.tags||(this.tags=new WeakMap);let O;this.tags.has(u)?O=this.tags.get(u):(O=new Set,this.tags.set(u,O)),O.add(c),v[y]=t.OPERATION.ADD}}remove(r,c=ct,u=!1){var R;const y=r[f];if(!y)return console.warn("StateView#remove(), invalid object:",r),this;this.visible.delete(y),this.iterable&&!u&&ar(this.items,this.items.indexOf(r));const v=y.ref.constructor[Symbol.metadata];let O=this.changes.get(y.refId);if(O===void 0&&(O={},this.changes.set(y.refId,O)),c===ct){const V=y.parent;if(!Te.isValidInstance(V)&&y.isFiltered){const H=V[f];let K=this.changes.get(H.refId);K===void 0&&(K={},this.changes.set(H.refId,K)),K[y.parentIndex]=t.OPERATION.DELETE}else(R=v==null?void 0:v[P])==null||R.forEach(H=>O[H]=t.OPERATION.DELETE)}else v==null||v[M][c].forEach(V=>O[V]=t.OPERATION.DELETE);if(this.tags&&this.tags.has(y)){const V=this.tags.get(y);c===void 0?this.tags.delete(y):(V.delete(c),V.size===0&&this.tags.delete(y))}return this}has(r){return this.visible.has(r[f])}hasTag(r,c=ct){var y;const u=(y=this.tags)==null?void 0:y.get(r[f]);return(u==null?void 0:u.has(c))??!1}clear(){if(!this.iterable)throw new Error("StateView#clear() is only available for iterable StateView's. Use StateView(iterable: true) constructor.");for(let r=0,c=this.items.length;r<c;r++)this.remove(this.items[r],ct,!0);this.items.length=0}isChangeTreeVisible(r){let c=this.visible.has(r);return!c&&r.isVisibilitySharedWithParent&&this.visible.has(r.parent[f])&&(this.visible.add(r),c=!0),c}}nt("map",{constructor:dt}),nt("array",{constructor:it}),nt("set",{constructor:ln}),nt("collection",{constructor:cn}),t.$changes=f,t.$childType=h,t.$decoder=l,t.$deleteByIndex=m,t.$encoder=a,t.$filter=d,t.$getByIndex=p,t.$track=o,t.ArraySchema=it,t.ChangeTree=Nt,t.CollectionSchema=cn,t.Decoder=Ps,t.Encoder=$n,t.MapSchema=dt,t.Metadata=Te,t.Reflection=jt,t.ReflectionField=kt,t.ReflectionType=Ft,t.Schema=be,t.SetSchema=ln,t.StateView=ac,t.TypeContext=st,t.decode=$e,t.decodeKeyValueOperation=Rn,t.decodeSchemaOperation=Wi,t.defineCustomTypes=Ka,t.defineTypes=tc,t.deprecated=ec,t.dumpChanges=nc,t.encode=Be,t.encodeArray=Hi,t.encodeKeyValueOperation=Cn,t.encodeSchemaOperation=zi,t.entity=Qa,t.getDecoderStateCallbacks=rc,t.getRawChangesCallback=oc,t.registerType=nt,t.schema=er,t.type=Je,t.view=Zi})}(bn,bn.exports)),bn.exports}var Rr;function fl(){if(Rr)return Ns;Rr=1;var i=gs,e=vi();class t{constructor(s){this.events=s,this.isOpen=!1,this.lengthPrefixBuffer=new Uint8Array(9)}connect(s,o={}){const a=o.fingerprint&&{serverCertificateHashes:[{algorithm:"sha-256",value:new Uint8Array(o.fingerprint).buffer}]}||void 0;this.wt=new WebTransport(s,a),this.wt.ready.then(l=>{this.isOpen=!0,this.unreliableReader=this.wt.datagrams.readable.getReader(),this.unreliableWriter=this.wt.datagrams.writable.getWriter(),this.wt.incomingBidirectionalStreams.getReader().read().then(p=>{this.reader=p.value.readable.getReader(),this.writer=p.value.writable.getWriter(),this.sendSeatReservation(o.room.roomId,o.sessionId,o.reconnectionToken),this.readIncomingData(),this.readIncomingUnreliableData()}).catch(p=>{console.error("failed to read incoming stream",p),console.error("TODO: close the connection")})}).catch(l=>{this._close()}),this.wt.closed.then(l=>{this.events.onclose({code:l.closeCode,reason:l.reason})}).catch(l=>{this.events.onerror(l),this.events.onclose({code:l.closeCode,reason:l.reason})}).finally(()=>{this._close()})}send(s){const o=e.encode.number(this.lengthPrefixBuffer,s.length,{offset:0}),a=new Uint8Array(o+s.length);a.set(this.lengthPrefixBuffer.subarray(0,o),0),a.set(s,o),this.writer.write(a)}sendUnreliable(s){const o=e.encode.number(this.lengthPrefixBuffer,s.length,{offset:0}),a=new Uint8Array(o+s.length);a.set(this.lengthPrefixBuffer.subarray(0,o),0),a.set(s,o),this.unreliableWriter.write(a)}close(s,o){try{this.wt.close({closeCode:s,reason:o})}catch(a){console.error(a)}}readIncomingData(){return i.__awaiter(this,void 0,void 0,function*(){let s;for(;this.isOpen;){try{s=yield this.reader.read();const o=s.value,a={offset:0};do{const l=e.decode.number(o,a);this.events.onmessage({data:o.subarray(a.offset,a.offset+l)}),a.offset+=l}while(a.offset<o.length)}catch(o){o.message.indexOf("session is closed")===-1&&console.error("H3Transport: failed to read incoming data",o);break}if(s.done)break}})}readIncomingUnreliableData(){return i.__awaiter(this,void 0,void 0,function*(){let s;for(;this.isOpen;){try{s=yield this.unreliableReader.read();const o=s.value,a={offset:0};do{const l=e.decode.number(o,a);this.events.onmessage({data:o.subarray(a.offset,a.offset+l)}),a.offset+=l}while(a.offset<o.length)}catch(o){o.message.indexOf("session is closed")===-1&&console.error("H3Transport: failed to read incoming data",o);break}if(s.done)break}})}sendSeatReservation(s,o,a){const l={offset:0},d=[];e.encode.string(d,s,l),e.encode.string(d,o,l),a&&e.encode.string(d,a,l),this.writer.write(new Uint8Array(d).buffer)}_close(){this.isOpen=!1}}return Ns.H3TransportTransport=t,Ns}var ks={},Fs,Dr;function ul(){return Dr||(Dr=1,Fs=function(){throw new Error("ws does not work in the browser. Browser clients must use the native WebSocket object")}),Fs}var Br;function hl(){if(Br)return ks;Br=1;var i=ul();const e=globalThis.WebSocket||i;let t=class{constructor(s){this.events=s}send(s){this.ws.send(s)}sendUnreliable(s){console.warn("colyseus.js: The WebSocket transport does not support unreliable messages")}connect(s,o){try{this.ws=new e(s,{headers:o,protocols:this.protocols})}catch{this.ws=new e(s,this.protocols)}this.ws.binaryType="arraybuffer",this.ws.onopen=this.events.onopen,this.ws.onmessage=this.events.onmessage,this.ws.onclose=this.events.onclose,this.ws.onerror=this.events.onerror}close(s,o){this.ws.close(s,o)}get isOpen(){return this.ws.readyState===e.OPEN}};return ks.WebSocketTransport=t,ks}var $r;function dl(){if($r)return Ls;$r=1;var i=fl(),e=hl();let t=class{constructor(s){switch(this.events={},s){case"h3":this.transport=new i.H3TransportTransport(this.events);break;default:this.transport=new e.WebSocketTransport(this.events);break}}connect(s,o){this.transport.connect.call(this.transport,s,o)}send(s){this.transport.send(s)}sendUnreliable(s){this.transport.sendUnreliable(s)}close(s,o){this.transport.close(s,o)}get isOpen(){return this.transport.isOpen}};return Ls.Connection=t,Ls}var js={},Lr;function ca(){return Lr||(Lr=1,function(i){i.Protocol=void 0,function(e){e[e.HANDSHAKE=9]="HANDSHAKE",e[e.JOIN_ROOM=10]="JOIN_ROOM",e[e.ERROR=11]="ERROR",e[e.LEAVE_ROOM=12]="LEAVE_ROOM",e[e.ROOM_DATA=13]="ROOM_DATA",e[e.ROOM_STATE=14]="ROOM_STATE",e[e.ROOM_STATE_PATCH=15]="ROOM_STATE_PATCH",e[e.ROOM_DATA_SCHEMA=16]="ROOM_DATA_SCHEMA",e[e.ROOM_DATA_BYTES=17]="ROOM_DATA_BYTES"}(i.Protocol||(i.Protocol={})),i.ErrorCode=void 0,function(e){e[e.MATCHMAKE_NO_HANDLER=4210]="MATCHMAKE_NO_HANDLER",e[e.MATCHMAKE_INVALID_CRITERIA=4211]="MATCHMAKE_INVALID_CRITERIA",e[e.MATCHMAKE_INVALID_ROOM_ID=4212]="MATCHMAKE_INVALID_ROOM_ID",e[e.MATCHMAKE_UNHANDLED=4213]="MATCHMAKE_UNHANDLED",e[e.MATCHMAKE_EXPIRED=4214]="MATCHMAKE_EXPIRED",e[e.AUTH_FAILED=4215]="AUTH_FAILED",e[e.APPLICATION_ERROR=4216]="APPLICATION_ERROR"}(i.ErrorCode||(i.ErrorCode={}))}(js)),js}var jn={},Nr;function la(){if(Nr)return jn;Nr=1;const i={};function e(n,s){i[n]=s}function t(n){const s=i[n];if(!s)throw new Error("missing serializer: "+n);return s}return jn.getSerializer=t,jn.registerSerializer=e,jn}var Vs={},kr;function fa(){if(kr)return Vs;kr=1;const i=()=>({emit(e,...t){let n=this.events[e]||[];for(let s=0,o=n.length;s<o;s++)n[s](...t)},events:{},on(e,t){var n;return!((n=this.events[e])===null||n===void 0)&&n.push(t)||(this.events[e]=[t]),()=>{var s;this.events[e]=(s=this.events[e])===null||s===void 0?void 0:s.filter(o=>t!==o)}}});return Vs.createNanoEvents=i,Vs}var Vn={},Fr;function pl(){if(Fr)return Vn;Fr=1;class i{constructor(){this.handlers=[]}register(n,s=!1){return this.handlers.push(n),this}invoke(...n){this.handlers.forEach(s=>s.apply(this,n))}invokeAsync(...n){return Promise.all(this.handlers.map(s=>s.apply(this,n)))}remove(n){const s=this.handlers.indexOf(n);this.handlers[s]=this.handlers[this.handlers.length-1],this.handlers.pop()}clear(){this.handlers=[]}}function e(){const t=new i;function n(s){return t.register(s,this===null)}return n.once=s=>{const o=function(...a){s.apply(this,a),t.remove(o)};t.register(o)},n.remove=s=>t.remove(s),n.invoke=(...s)=>t.invoke(...s),n.invokeAsync=(...s)=>t.invokeAsync(...s),n.clear=()=>t.clear(),n}return Vn.EventEmitter=i,Vn.createSignal=e,Vn}var Un={},jr;function ua(){if(jr)return Un;jr=1;var i=vi();function e(n){try{return i.getDecoderStateCallbacks(n.serializer.decoder)}catch{return}}let t=class{setState(s,o){this.decoder.decode(s,o)}getState(){return this.state}patch(s,o){return this.decoder.decode(s,o)}teardown(){this.decoder.root.clearRefs()}handshake(s,o){this.state?(i.Reflection.decode(s,o),this.decoder=new i.Decoder(this.state)):(this.decoder=i.Reflection.decode(s,o),this.state=this.decoder.state)}};return Un.SchemaSerializer=t,Un.getStateCallbacks=e,Un}var fi;try{fi=new TextDecoder}catch{}var Q,at,I=0,pe={},fe,Et,Ve=0,ot=0,ve,ft,Oe=[],le,Vr={useRecords:!1,mapsAsObjects:!0};class ha{}const Pi=new ha;Pi.name="MessagePack 0xC1";var Tt=!1,da=2,ml;try{new Function("")}catch{da=1/0}class vt{constructor(e){e&&(e.useRecords===!1&&e.mapsAsObjects===void 0&&(e.mapsAsObjects=!0),e.sequential&&e.trusted!==!1&&(e.trusted=!0,!e.structures&&e.useRecords!=!1&&(e.structures=[],e.maxSharedStructures||(e.maxSharedStructures=0))),e.structures?e.structures.sharedLength=e.structures.length:e.getStructures&&((e.structures=[]).uninitialized=!0,e.structures.sharedLength=0),e.int64AsNumber&&(e.int64AsType="number")),Object.assign(this,e)}unpack(e,t){if(Q)return xa(()=>(hs(),this?this.unpack(e,t):vt.prototype.unpack.call(Vr,e,t)));!e.buffer&&e.constructor===ArrayBuffer&&(e=typeof Buffer<"u"?Buffer.from(e):new Uint8Array(e)),typeof t=="object"?(at=t.end||e.length,I=t.start||0):(I=0,at=t>-1?t:e.length),ot=0,Et=null,ve=null,Q=e;try{le=e.dataView||(e.dataView=new DataView(e.buffer,e.byteOffset,e.byteLength))}catch(n){throw Q=null,e instanceof Uint8Array?n:new Error("Source must be a Uint8Array or Buffer but was a "+(e&&typeof e=="object"?e.constructor.name:typeof e))}if(this instanceof vt){if(pe=this,this.structures)return fe=this.structures,zn(t);(!fe||fe.length>0)&&(fe=[])}else pe=Vr,(!fe||fe.length>0)&&(fe=[]);return zn(t)}unpackMultiple(e,t){let n,s=0;try{Tt=!0;let o=e.length,a=this?this.unpack(e,o):xs.unpack(e,o);if(t){if(t(a,s,I)===!1)return;for(;I<o;)if(s=I,t(zn(),s,I)===!1)return}else{for(n=[a];I<o;)s=I,n.push(zn());return n}}catch(o){throw o.lastPosition=s,o.values=n,o}finally{Tt=!1,hs()}}_mergeStructures(e,t){e=e||[],Object.isFrozen(e)&&(e=e.map(n=>n.slice(0)));for(let n=0,s=e.length;n<s;n++){let o=e[n];o&&(o.isShared=!0,n>=32&&(o.highByte=n-32>>5))}e.sharedLength=e.length;for(let n in t||[])if(n>=0){let s=e[n],o=t[n];o&&(s&&((e.restoreStructures||(e.restoreStructures=[]))[n]=s),e[n]=o)}return this.structures=e}decode(e,t){return this.unpack(e,t)}}function zn(i){try{if(!pe.trusted&&!Tt){let t=fe.sharedLength||0;t<fe.length&&(fe.length=t)}let e;if(pe.randomAccessStructure&&Q[I]<64&&Q[I]>=32&&ml||(e=xe()),ve&&(I=ve.postBundlePosition,ve=null),Tt&&(fe.restoreStructures=null),I==at)fe&&fe.restoreStructures&&Ur(),fe=null,Q=null,ft&&(ft=null);else{if(I>at)throw new Error("Unexpected end of MessagePack data");if(!Tt){let t;try{t=JSON.stringify(e,(n,s)=>typeof s=="bigint"?`${s}n`:s).slice(0,100)}catch(n){t="(JSON view not available "+n+")"}throw new Error("Data read, but end of buffer not reached "+t)}}return e}catch(e){throw fe&&fe.restoreStructures&&Ur(),hs(),(e instanceof RangeError||e.message.startsWith("Unexpected end of buffer")||I>at)&&(e.incomplete=!0),e}}function Ur(){for(let i in fe.restoreStructures)fe[i]=fe.restoreStructures[i];fe.restoreStructures=null}function xe(){let i=Q[I++];if(i<160)if(i<128){if(i<64)return i;{let e=fe[i&63]||pe.getStructures&&pa()[i&63];return e?(e.read||(e.read=Ii(e,i&63)),e.read()):i}}else if(i<144)if(i-=128,pe.mapsAsObjects){let e={};for(let t=0;t<i;t++){let n=ga();n==="__proto__"&&(n="__proto_"),e[n]=xe()}return e}else{let e=new Map;for(let t=0;t<i;t++)e.set(xe(),xe());return e}else{i-=144;let e=new Array(i);for(let t=0;t<i;t++)e[t]=xe();return pe.freezeData?Object.freeze(e):e}else if(i<192){let e=i-160;if(ot>=I)return Et.slice(I-Ve,(I+=e)-Ve);if(ot==0&&at<140){let t=e<16?_i(e):ma(e);if(t!=null)return t}return ui(e)}else{let e;switch(i){case 192:return null;case 193:return ve?(e=xe(),e>0?ve[1].slice(ve.position1,ve.position1+=e):ve[0].slice(ve.position0,ve.position0-=e)):Pi;case 194:return!1;case 195:return!0;case 196:if(e=Q[I++],e===void 0)throw new Error("Unexpected end of buffer");return Us(e);case 197:return e=le.getUint16(I),I+=2,Us(e);case 198:return e=le.getUint32(I),I+=4,Us(e);case 199:return Ot(Q[I++]);case 200:return e=le.getUint16(I),I+=2,Ot(e);case 201:return e=le.getUint32(I),I+=4,Ot(e);case 202:if(e=le.getFloat32(I),pe.useFloat32>2){let t=ws[(Q[I]&127)<<1|Q[I+1]>>7];return I+=4,(t*e+(e>0?.5:-.5)>>0)/t}return I+=4,e;case 203:return e=le.getFloat64(I),I+=8,e;case 204:return Q[I++];case 205:return e=le.getUint16(I),I+=2,e;case 206:return e=le.getUint32(I),I+=4,e;case 207:return pe.int64AsType==="number"?(e=le.getUint32(I)*4294967296,e+=le.getUint32(I+4)):pe.int64AsType==="string"?e=le.getBigUint64(I).toString():pe.int64AsType==="auto"?(e=le.getBigUint64(I),e<=BigInt(2)<<BigInt(52)&&(e=Number(e))):e=le.getBigUint64(I),I+=8,e;case 208:return le.getInt8(I++);case 209:return e=le.getInt16(I),I+=2,e;case 210:return e=le.getInt32(I),I+=4,e;case 211:return pe.int64AsType==="number"?(e=le.getInt32(I)*4294967296,e+=le.getUint32(I+4)):pe.int64AsType==="string"?e=le.getBigInt64(I).toString():pe.int64AsType==="auto"?(e=le.getBigInt64(I),e>=BigInt(-2)<<BigInt(52)&&e<=BigInt(2)<<BigInt(52)&&(e=Number(e))):e=le.getBigInt64(I),I+=8,e;case 212:if(e=Q[I++],e==114)return Jr(Q[I++]&63);{let t=Oe[e];if(t)return t.read?(I++,t.read(xe())):t.noBuffer?(I++,t()):t(Q.subarray(I,++I));throw new Error("Unknown extension "+e)}case 213:return e=Q[I],e==114?(I++,Jr(Q[I++]&63,Q[I++])):Ot(2);case 214:return Ot(4);case 215:return Ot(8);case 216:return Ot(16);case 217:return e=Q[I++],ot>=I?Et.slice(I-Ve,(I+=e)-Ve):yl(e);case 218:return e=le.getUint16(I),I+=2,ot>=I?Et.slice(I-Ve,(I+=e)-Ve):wl(e);case 219:return e=le.getUint32(I),I+=4,ot>=I?Et.slice(I-Ve,(I+=e)-Ve):xl(e);case 220:return e=le.getUint16(I),I+=2,Hr(e);case 221:return e=le.getUint32(I),I+=4,Hr(e);case 222:return e=le.getUint16(I),I+=2,qr(e);case 223:return e=le.getUint32(I),I+=4,qr(e);default:if(i>=224)return i-256;if(i===void 0){let t=new Error("Unexpected end of MessagePack data");throw t.incomplete=!0,t}throw new Error("Unknown MessagePack token "+i)}}}const gl=/^[a-zA-Z_$][a-zA-Z\d_$]*$/;function Ii(i,e){function t(){if(t.count++>da){let s=i.read=new Function("r","return function(){return "+(pe.freezeData?"Object.freeze":"")+"({"+i.map(o=>o==="__proto__"?"__proto_:r()":gl.test(o)?o+":r()":"["+JSON.stringify(o)+"]:r()").join(",")+"})}")(xe);return i.highByte===0&&(i.read=zr(e,i.read)),s()}let n={};for(let s=0,o=i.length;s<o;s++){let a=i[s];a==="__proto__"&&(a="__proto_"),n[a]=xe()}return pe.freezeData?Object.freeze(n):n}return t.count=0,i.highByte===0?zr(e,t):t}const zr=(i,e)=>function(){let t=Q[I++];if(t===0)return e();let n=i<32?-(i+(t<<5)):i+(t<<5),s=fe[n]||pa()[n];if(!s)throw new Error("Record id is not defined for "+n);return s.read||(s.read=Ii(s,i)),s.read()};function pa(){let i=xa(()=>(Q=null,pe.getStructures()));return fe=pe._mergeStructures(i,fe)}var ui=In,yl=In,wl=In,xl=In;let bl=!1;function In(i){let e;if(i<16&&(e=_i(i)))return e;if(i>64&&fi)return fi.decode(Q.subarray(I,I+=i));const t=I+i,n=[];for(e="";I<t;){const s=Q[I++];if((s&128)===0)n.push(s);else if((s&224)===192){const o=Q[I++]&63;n.push((s&31)<<6|o)}else if((s&240)===224){const o=Q[I++]&63,a=Q[I++]&63;n.push((s&31)<<12|o<<6|a)}else if((s&248)===240){const o=Q[I++]&63,a=Q[I++]&63,l=Q[I++]&63;let d=(s&7)<<18|o<<12|a<<6|l;d>65535&&(d-=65536,n.push(d>>>10&1023|55296),d=56320|d&1023),n.push(d)}else n.push(s);n.length>=4096&&(e+=Se.apply(String,n),n.length=0)}return n.length>0&&(e+=Se.apply(String,n)),e}function Hr(i){let e=new Array(i);for(let t=0;t<i;t++)e[t]=xe();return pe.freezeData?Object.freeze(e):e}function qr(i){if(pe.mapsAsObjects){let e={};for(let t=0;t<i;t++){let n=ga();n==="__proto__"&&(n="__proto_"),e[n]=xe()}return e}else{let e=new Map;for(let t=0;t<i;t++)e.set(xe(),xe());return e}}var Se=String.fromCharCode;function ma(i){let e=I,t=new Array(i);for(let n=0;n<i;n++){const s=Q[I++];if((s&128)>0){I=e;return}t[n]=s}return Se.apply(String,t)}function _i(i){if(i<4)if(i<2){if(i===0)return"";{let e=Q[I++];if((e&128)>1){I-=1;return}return Se(e)}}else{let e=Q[I++],t=Q[I++];if((e&128)>0||(t&128)>0){I-=2;return}if(i<3)return Se(e,t);let n=Q[I++];if((n&128)>0){I-=3;return}return Se(e,t,n)}else{let e=Q[I++],t=Q[I++],n=Q[I++],s=Q[I++];if((e&128)>0||(t&128)>0||(n&128)>0||(s&128)>0){I-=4;return}if(i<6){if(i===4)return Se(e,t,n,s);{let o=Q[I++];if((o&128)>0){I-=5;return}return Se(e,t,n,s,o)}}else if(i<8){let o=Q[I++],a=Q[I++];if((o&128)>0||(a&128)>0){I-=6;return}if(i<7)return Se(e,t,n,s,o,a);let l=Q[I++];if((l&128)>0){I-=7;return}return Se(e,t,n,s,o,a,l)}else{let o=Q[I++],a=Q[I++],l=Q[I++],d=Q[I++];if((o&128)>0||(a&128)>0||(l&128)>0||(d&128)>0){I-=8;return}if(i<10){if(i===8)return Se(e,t,n,s,o,a,l,d);{let p=Q[I++];if((p&128)>0){I-=9;return}return Se(e,t,n,s,o,a,l,d,p)}}else if(i<12){let p=Q[I++],m=Q[I++];if((p&128)>0||(m&128)>0){I-=10;return}if(i<11)return Se(e,t,n,s,o,a,l,d,p,m);let f=Q[I++];if((f&128)>0){I-=11;return}return Se(e,t,n,s,o,a,l,d,p,m,f)}else{let p=Q[I++],m=Q[I++],f=Q[I++],h=Q[I++];if((p&128)>0||(m&128)>0||(f&128)>0||(h&128)>0){I-=12;return}if(i<14){if(i===12)return Se(e,t,n,s,o,a,l,d,p,m,f,h);{let g=Q[I++];if((g&128)>0){I-=13;return}return Se(e,t,n,s,o,a,l,d,p,m,f,h,g)}}else{let g=Q[I++],E=Q[I++];if((g&128)>0||(E&128)>0){I-=14;return}if(i<15)return Se(e,t,n,s,o,a,l,d,p,m,f,h,g,E);let A=Q[I++];if((A&128)>0){I-=15;return}return Se(e,t,n,s,o,a,l,d,p,m,f,h,g,E,A)}}}}}function Wr(){let i=Q[I++],e;if(i<192)e=i-160;else switch(i){case 217:e=Q[I++];break;case 218:e=le.getUint16(I),I+=2;break;case 219:e=le.getUint32(I),I+=4;break;default:throw new Error("Expected string")}return In(e)}function Us(i){return pe.copyBuffers?Uint8Array.prototype.slice.call(Q,I,I+=i):Q.subarray(I,I+=i)}function Ot(i){let e=Q[I++];if(Oe[e]){let t;return Oe[e](Q.subarray(I,t=I+=i),n=>{I=n;try{return xe()}finally{I=t}})}else throw new Error("Unknown extension type "+e)}var Gr=new Array(4096);function ga(){let i=Q[I++];if(i>=160&&i<192){if(i=i-160,ot>=I)return Et.slice(I-Ve,(I+=i)-Ve);if(!(ot==0&&at<180))return ui(i)}else return I--,ya(xe());let e=(i<<5^(i>1?le.getUint16(I):i>0?Q[I]:0))&4095,t=Gr[e],n=I,s=I+i-3,o,a=0;if(t&&t.bytes==i){for(;n<s;){if(o=le.getUint32(n),o!=t[a++]){n=1879048192;break}n+=4}for(s+=3;n<s;)if(o=Q[n++],o!=t[a++]){n=1879048192;break}if(n===s)return I=n,t.string;s-=3,n=I}for(t=[],Gr[e]=t,t.bytes=i;n<s;)o=le.getUint32(n),t.push(o),n+=4;for(s+=3;n<s;)o=Q[n++],t.push(o);let l=i<16?_i(i):ma(i);return l!=null?t.string=l:t.string=ui(i)}function ya(i){if(typeof i=="string")return i;if(typeof i=="number"||typeof i=="boolean"||typeof i=="bigint")return i.toString();if(i==null)return i+"";if(pe.allowArraysInMapKeys&&Array.isArray(i)&&i.flat().every(e=>["string","number","boolean","bigint"].includes(typeof e)))return i.flat().toString();throw new Error(`Invalid property type for record: ${typeof i}`)}const Jr=(i,e)=>{let t=xe().map(ya),n=i;e!==void 0&&(i=i<32?-((e<<5)+i):(e<<5)+i,t.highByte=e);let s=fe[i];return s&&(s.isShared||Tt)&&((fe.restoreStructures||(fe.restoreStructures=[]))[i]=s),fe[i]=t,t.read=Ii(t,n),t.read()};Oe[0]=()=>{};Oe[0].noBuffer=!0;Oe[66]=i=>{let e=i.length,t=BigInt(i[0]&128?i[0]-256:i[0]);for(let n=1;n<e;n++)t<<=BigInt(8),t+=BigInt(i[n]);return t};let El={Error,TypeError,ReferenceError};Oe[101]=()=>{let i=xe();return(El[i[0]]||Error)(i[1],{cause:i[2]})};Oe[105]=i=>{if(pe.structuredClone===!1)throw new Error("Structured clone extension is disabled");let e=le.getUint32(I-4);ft||(ft=new Map);let t=Q[I],n;t>=144&&t<160||t==220||t==221?n=[]:n={};let s={target:n};ft.set(e,s);let o=xe();return s.used?Object.assign(n,o):(s.target=o,o)};Oe[112]=i=>{if(pe.structuredClone===!1)throw new Error("Structured clone extension is disabled");let e=le.getUint32(I-4),t=ft.get(e);return t.used=!0,t.target};Oe[115]=()=>new Set(xe());const wa=["Int8","Uint8","Uint8Clamped","Int16","Uint16","Int32","Uint32","Float32","Float64","BigInt64","BigUint64"].map(i=>i+"Array");let Al=typeof globalThis=="object"?globalThis:window;Oe[116]=i=>{let e=i[0],t=wa[e];if(!t){if(e===16){let n=new ArrayBuffer(i.length-1);return new Uint8Array(n).set(i.subarray(1)),n}throw new Error("Could not find typed array for code "+e)}return new Al[t](Uint8Array.prototype.slice.call(i,1).buffer)};Oe[120]=()=>{let i=xe();return new RegExp(i[0],i[1])};const Tl=[];Oe[98]=i=>{let e=(i[0]<<24)+(i[1]<<16)+(i[2]<<8)+i[3],t=I;return I+=e-i.length,ve=Tl,ve=[Wr(),Wr()],ve.position0=0,ve.position1=0,ve.postBundlePosition=I,I=t,xe()};Oe[255]=i=>i.length==4?new Date((i[0]*16777216+(i[1]<<16)+(i[2]<<8)+i[3])*1e3):i.length==8?new Date(((i[0]<<22)+(i[1]<<14)+(i[2]<<6)+(i[3]>>2))/1e6+((i[3]&3)*4294967296+i[4]*16777216+(i[5]<<16)+(i[6]<<8)+i[7])*1e3):i.length==12?new Date(((i[0]<<24)+(i[1]<<16)+(i[2]<<8)+i[3])/1e6+((i[4]&128?-281474976710656:0)+i[6]*1099511627776+i[7]*4294967296+i[8]*16777216+(i[9]<<16)+(i[10]<<8)+i[11])*1e3):new Date("invalid");function xa(i){let e=at,t=I,n=Ve,s=ot,o=Et,a=ft,l=ve,d=new Uint8Array(Q.slice(0,at)),p=fe,m=fe.slice(0,fe.length),f=pe,h=Tt,g=i();return at=e,I=t,Ve=n,ot=s,Et=o,ft=a,ve=l,Q=d,Tt=h,fe=p,fe.splice(0,fe.length,...m),pe=f,le=new DataView(Q.buffer,Q.byteOffset,Q.byteLength),g}function hs(){Q=null,ft=null,fe=null}function Sl(i){i.unpack?Oe[i.type]=i.unpack:Oe[i.type]=i}const ws=new Array(147);for(let i=0;i<256;i++)ws[i]=+("1e"+Math.floor(45.15-i*.30103));const vl=vt;var xs=new vt({useRecords:!1});const Pl=xs.unpack,Il=xs.unpackMultiple,_l=xs.unpack,ba={NEVER:0,ALWAYS:1,DECIMAL_ROUND:3,DECIMAL_FIT:4};let Ea=new Float32Array(1),Kr=new Uint8Array(Ea.buffer,0,4);function Ol(i){Ea[0]=i;let e=ws[(Kr[3]&127)<<1|Kr[2]>>7];return(e*i+(i>0?.5:-.5)>>0)/e}let os;try{os=new TextEncoder}catch{}let ds,Oi;const bs=typeof Buffer<"u",Hn=bs?function(i){return Buffer.allocUnsafeSlow(i)}:Uint8Array,Aa=bs?Buffer:Uint8Array,Yr=bs?4294967296:2144337920;let D,un,de,_=0,Ce,ge=null,Ml;const Cl=21760,Rl=/[\u0080-\uFFFF]/,zt=Symbol("record-id");class _n extends vt{constructor(e){super(e),this.offset=0;let t,n,s,o,a=Aa.prototype.utf8Write?function(T,L){return D.utf8Write(T,L,D.byteLength-L)}:os&&os.encodeInto?function(T,L){return os.encodeInto(T,D.subarray(L)).written}:!1,l=this;e||(e={});let d=e&&e.sequential,p=e.structures||e.saveStructures,m=e.maxSharedStructures;if(m==null&&(m=p?32:0),m>8160)throw new Error("Maximum maxSharedStructure is 8160");e.structuredClone&&e.moreTypes==null&&(this.moreTypes=!0);let f=e.maxOwnStructures;f==null&&(f=p?32:64),!this.structures&&e.useRecords!=!1&&(this.structures=[]);let h=m>32||f+m>64,g=m+64,E=m+f+64;if(E>8256)throw new Error("Maximum maxSharedStructure + maxOwnStructure is 8192");let A=[],b=0,S=0;this.pack=this.encode=function(T,L){if(D||(D=new Hn(8192),de=D.dataView||(D.dataView=new DataView(D.buffer,0,8192)),_=0),Ce=D.length-10,Ce-_<2048?(D=new Hn(D.length),de=D.dataView||(D.dataView=new DataView(D.buffer,0,D.length)),Ce=D.length-10,_=0):_=_+7&2147483640,t=_,L&Pa&&(_+=L&255),o=l.structuredClone?new Map:null,l.bundleStrings&&typeof T!="string"?(ge=[],ge.size=1/0):ge=null,s=l.structures,s){s.uninitialized&&(s=l._mergeStructures(l.getStructures()));let k=s.sharedLength||0;if(k>m)throw new Error("Shared structures is larger than maximum shared structures, try increasing maxSharedStructures to "+s.sharedLength);if(!s.transitions){s.transitions=Object.create(null);for(let U=0;U<k;U++){let te=s[U];if(!te)continue;let oe,re=s.transitions;for(let ae=0,ce=te.length;ae<ce;ae++){let Ae=te[ae];oe=re[Ae],oe||(oe=re[Ae]=Object.create(null)),re=oe}re[zt]=U+64}this.lastNamedStructuresLength=k}d||(s.nextId=k+64)}n&&(n=!1);let j;try{l.randomAccessStructure&&T&&T.constructor&&T.constructor===Object?F(T):C(T);let k=ge;if(ge&&Qr(t,C,0),o&&o.idsToInsert){let U=o.idsToInsert.sort((ae,ce)=>ae.offset>ce.offset?1:-1),te=U.length,oe=-1;for(;k&&te>0;){let ae=U[--te].offset+t;ae<k.stringsPosition+t&&oe===-1&&(oe=0),ae>k.position+t?oe>=0&&(oe+=6):(oe>=0&&(de.setUint32(k.position+t,de.getUint32(k.position+t)+oe),oe=-1),k=k.previous,te++)}oe>=0&&k&&de.setUint32(k.position+t,de.getUint32(k.position+t)+oe),_+=U.length*6,_>Ce&&z(_),l.offset=_;let re=Bl(D.subarray(t,_),U);return o=null,re}return l.offset=_,L&Sa?(D.start=t,D.end=_,D):D.subarray(t,_)}catch(k){throw j=k,k}finally{if(s&&(P(),n&&l.saveStructures)){let k=s.sharedLength||0,U=D.subarray(t,_),te=Ll(s,l);if(!j)return l.saveStructures(te,te.isCompatible)===!1?l.pack(T,L):(l.lastNamedStructuresLength=k,D.length>1073741824&&(D=null),U)}D.length>1073741824&&(D=null),L&va&&(_=t)}};const P=()=>{S<10&&S++;let T=s.sharedLength||0;if(s.length>T&&!d&&(s.length=T),b>1e4)s.transitions=null,S=0,b=0,A.length>0&&(A=[]);else if(A.length>0&&!d){for(let L=0,j=A.length;L<j;L++)A[L][zt]=0;A=[]}},M=T=>{var L=T.length;L<16?D[_++]=144|L:L<65536?(D[_++]=220,D[_++]=L>>8,D[_++]=L&255):(D[_++]=221,de.setUint32(_,L),_+=4);for(let j=0;j<L;j++)C(T[j])},C=T=>{_>Ce&&(D=z(_));var L=typeof T,j;if(L==="string"){let k=T.length;if(ge&&k>=4&&k<4096){if((ge.size+=k)>Cl){let re,ae=(ge[0]?ge[0].length*3+ge[1].length:0)+10;_+ae>Ce&&(D=z(_+ae));let ce;ge.position?(ce=ge,D[_]=200,_+=3,D[_++]=98,re=_-t,_+=4,Qr(t,C,0),de.setUint16(re+t-3,_-t-re)):(D[_++]=214,D[_++]=98,re=_-t,_+=4),ge=["",""],ge.previous=ce,ge.size=0,ge.position=re}let oe=Rl.test(T);ge[oe?0:1]+=T,D[_++]=193,C(oe?-k:k);return}let U;k<32?U=1:k<256?U=2:k<65536?U=3:U=5;let te=k*3;if(_+te>Ce&&(D=z(_+te)),k<64||!a){let oe,re,ae,ce=_+U;for(oe=0;oe<k;oe++)re=T.charCodeAt(oe),re<128?D[ce++]=re:re<2048?(D[ce++]=re>>6|192,D[ce++]=re&63|128):(re&64512)===55296&&((ae=T.charCodeAt(oe+1))&64512)===56320?(re=65536+((re&1023)<<10)+(ae&1023),oe++,D[ce++]=re>>18|240,D[ce++]=re>>12&63|128,D[ce++]=re>>6&63|128,D[ce++]=re&63|128):(D[ce++]=re>>12|224,D[ce++]=re>>6&63|128,D[ce++]=re&63|128);j=ce-_-U}else j=a(T,_+U);j<32?D[_++]=160|j:j<256?(U<2&&D.copyWithin(_+2,_+1,_+1+j),D[_++]=217,D[_++]=j):j<65536?(U<3&&D.copyWithin(_+3,_+2,_+2+j),D[_++]=218,D[_++]=j>>8,D[_++]=j&255):(U<5&&D.copyWithin(_+5,_+3,_+3+j),D[_++]=219,de.setUint32(_,j),_+=4),_+=j}else if(L==="number")if(T>>>0===T)T<32||T<128&&this.useRecords===!1||T<64&&!this.randomAccessStructure?D[_++]=T:T<256?(D[_++]=204,D[_++]=T):T<65536?(D[_++]=205,D[_++]=T>>8,D[_++]=T&255):(D[_++]=206,de.setUint32(_,T),_+=4);else if(T>>0===T)T>=-32?D[_++]=256+T:T>=-128?(D[_++]=208,D[_++]=T+256):T>=-32768?(D[_++]=209,de.setInt16(_,T),_+=2):(D[_++]=210,de.setInt32(_,T),_+=4);else{let k;if((k=this.useFloat32)>0&&T<4294967296&&T>=-2147483648){D[_++]=202,de.setFloat32(_,T);let U;if(k<4||(U=T*ws[(D[_]&127)<<1|D[_+1]>>7])>>0===U){_+=4;return}else _--}D[_++]=203,de.setFloat64(_,T),_+=8}else if(L==="object"||L==="function")if(!T)D[_++]=192;else{if(o){let U=o.get(T);if(U){if(!U.id){let te=o.idsToInsert||(o.idsToInsert=[]);U.id=te.push(U)}D[_++]=214,D[_++]=112,de.setUint32(_,U.id),_+=4;return}else o.set(T,{offset:_-t})}let k=T.constructor;if(k===Object)W(T);else if(k===Array)M(T);else if(k===Map)if(this.mapAsEmptyObject)D[_++]=128;else{j=T.size,j<16?D[_++]=128|j:j<65536?(D[_++]=222,D[_++]=j>>8,D[_++]=j&255):(D[_++]=223,de.setUint32(_,j),_+=4);for(let[U,te]of T)C(U),C(te)}else{for(let U=0,te=ds.length;U<te;U++){let oe=Oi[U];if(T instanceof oe){let re=ds[U];if(re.write){re.type&&(D[_++]=212,D[_++]=re.type,D[_++]=0);let It=re.write.call(this,T);It===T?Array.isArray(T)?M(T):W(T):C(It);return}let ae=D,ce=de,Ae=_;D=null;let We;try{We=re.pack.call(this,T,It=>(D=ae,ae=null,_+=It,_>Ce&&z(_),{target:D,targetView:de,position:_-It}),C)}finally{ae&&(D=ae,de=ce,_=Ae,Ce=D.length-10)}We&&(We.length+_>Ce&&z(We.length+_),_=Dl(We,D,_,re.type));return}}if(Array.isArray(T))M(T);else{if(T.toJSON){const U=T.toJSON();if(U!==T)return C(U)}if(L==="function")return C(this.writeFunction&&this.writeFunction(T));W(T)}}}else if(L==="boolean")D[_++]=T?195:194;else if(L==="bigint"){if(T<BigInt(1)<<BigInt(63)&&T>=-(BigInt(1)<<BigInt(63)))D[_++]=211,de.setBigInt64(_,T);else if(T<BigInt(1)<<BigInt(64)&&T>0)D[_++]=207,de.setBigUint64(_,T);else if(this.largeBigIntToFloat)D[_++]=203,de.setFloat64(_,Number(T));else{if(this.largeBigIntToString)return C(T.toString());if(this.useBigIntExtension&&T<BigInt(2)**BigInt(1023)&&T>-(BigInt(2)**BigInt(1023))){D[_++]=199,_++,D[_++]=66;let k=[],U;do{let te=T&BigInt(255);U=(te&BigInt(128))===(T<BigInt(0)?BigInt(128):BigInt(0)),k.push(te),T>>=BigInt(8)}while(!((T===BigInt(0)||T===BigInt(-1))&&U));D[_-2]=k.length;for(let te=k.length;te>0;)D[_++]=Number(k[--te]);return}else throw new RangeError(T+" was too large to fit in MessagePack 64-bit integer format, use useBigIntExtension, or set largeBigIntToFloat to convert to float-64, or set largeBigIntToString to convert to string")}_+=8}else if(L==="undefined")this.encodeUndefinedAsNil?D[_++]=192:(D[_++]=212,D[_++]=0,D[_++]=0);else throw new Error("Unknown type: "+L)},B=this.variableMapSize||this.coercibleKeyAsNumber||this.skipValues?T=>{let L;if(this.skipValues){L=[];for(let U in T)(typeof T.hasOwnProperty!="function"||T.hasOwnProperty(U))&&!this.skipValues.includes(T[U])&&L.push(U)}else L=Object.keys(T);let j=L.length;j<16?D[_++]=128|j:j<65536?(D[_++]=222,D[_++]=j>>8,D[_++]=j&255):(D[_++]=223,de.setUint32(_,j),_+=4);let k;if(this.coercibleKeyAsNumber)for(let U=0;U<j;U++){k=L[U];let te=Number(k);C(isNaN(te)?k:te),C(T[k])}else for(let U=0;U<j;U++)C(k=L[U]),C(T[k])}:T=>{D[_++]=222;let L=_-t;_+=2;let j=0;for(let k in T)(typeof T.hasOwnProperty!="function"||T.hasOwnProperty(k))&&(C(k),C(T[k]),j++);if(j>65535)throw new Error('Object is too large to serialize with fast 16-bit map size, use the "variableMapSize" option to serialize this object');D[L+++t]=j>>8,D[L+t]=j&255},$=this.useRecords===!1?B:e.progressiveRecords&&!h?T=>{let L,j=s.transitions||(s.transitions=Object.create(null)),k=_++-t,U;for(let te in T)if(typeof T.hasOwnProperty!="function"||T.hasOwnProperty(te)){if(L=j[te],L)j=L;else{let oe=Object.keys(T),re=j;j=s.transitions;let ae=0;for(let ce=0,Ae=oe.length;ce<Ae;ce++){let We=oe[ce];L=j[We],L||(L=j[We]=Object.create(null),ae++),j=L}k+t+1==_?(_--,J(j,oe,ae)):ee(j,oe,k,ae),U=!0,j=re[te]}C(T[te])}if(!U){let te=j[zt];te?D[k+t]=te:ee(j,Object.keys(T),k,0)}}:T=>{let L,j=s.transitions||(s.transitions=Object.create(null)),k=0;for(let te in T)(typeof T.hasOwnProperty!="function"||T.hasOwnProperty(te))&&(L=j[te],L||(L=j[te]=Object.create(null),k++),j=L);let U=j[zt];U?U>=96&&h?(D[_++]=((U-=96)&31)+96,D[_++]=U>>5):D[_++]=U:J(j,j.__keys__||Object.keys(T),k);for(let te in T)(typeof T.hasOwnProperty!="function"||T.hasOwnProperty(te))&&C(T[te])},N=typeof this.useRecords=="function"&&this.useRecords,W=N?T=>{N(T)?$(T):B(T)}:$,z=T=>{let L;if(T>16777216){if(T-t>Yr)throw new Error("Packed buffer would be larger than maximum buffer size");L=Math.min(Yr,Math.round(Math.max((T-t)*(T>67108864?1.25:2),4194304)/4096)*4096)}else L=(Math.max(T-t<<2,D.length-1)>>12)+1<<12;let j=new Hn(L);return de=j.dataView||(j.dataView=new DataView(j.buffer,0,L)),T=Math.min(T,D.length),D.copy?D.copy(j,0,t,T):j.set(D.slice(t,T)),_-=t,t=0,Ce=j.length-10,D=j},J=(T,L,j)=>{let k=s.nextId;k||(k=64),k<g&&this.shouldShareStructure&&!this.shouldShareStructure(L)?(k=s.nextOwnId,k<E||(k=g),s.nextOwnId=k+1):(k>=E&&(k=g),s.nextId=k+1);let U=L.highByte=k>=96&&h?k-96>>5:-1;T[zt]=k,T.__keys__=L,s[k-64]=L,k<g?(L.isShared=!0,s.sharedLength=k-63,n=!0,U>=0?(D[_++]=(k&31)+96,D[_++]=U):D[_++]=k):(U>=0?(D[_++]=213,D[_++]=114,D[_++]=(k&31)+96,D[_++]=U):(D[_++]=212,D[_++]=114,D[_++]=k),j&&(b+=S*j),A.length>=f&&(A.shift()[zt]=0),A.push(T),C(L))},ee=(T,L,j,k)=>{let U=D,te=_,oe=Ce,re=t;D=un,_=0,t=0,D||(un=D=new Hn(8192)),Ce=D.length-10,J(T,L,k),un=D;let ae=_;if(D=U,_=te,Ce=oe,t=re,ae>1){let ce=_+ae-1;ce>Ce&&z(ce);let Ae=j+t;D.copyWithin(Ae+ae,Ae+1,_),D.set(un.slice(0,ae),Ae),_=ce}else D[j+t]=un[0]},F=T=>{let L=Ml(T,D,t,_,s,z,(j,k,U)=>{if(U)return n=!0;_=k;let te=D;return C(j),P(),te!==D?{position:_,targetView:de,target:D}:_},this);if(L===0)return W(T);_=L}}useBuffer(e){D=e,D.dataView||(D.dataView=new DataView(D.buffer,D.byteOffset,D.byteLength)),_=0}set position(e){_=e}get position(){return _}set buffer(e){D=e}get buffer(){return D}clearSharedData(){this.structures&&(this.structures=[]),this.typedStructs&&(this.typedStructs=[])}}Oi=[Date,Set,Error,RegExp,ArrayBuffer,Object.getPrototypeOf(Uint8Array.prototype).constructor,ha];ds=[{pack(i,e,t){let n=i.getTime()/1e3;if((this.useTimestamp32||i.getMilliseconds()===0)&&n>=0&&n<4294967296){let{target:s,targetView:o,position:a}=e(6);s[a++]=214,s[a++]=255,o.setUint32(a,n)}else if(n>0&&n<4294967296){let{target:s,targetView:o,position:a}=e(10);s[a++]=215,s[a++]=255,o.setUint32(a,i.getMilliseconds()*4e6+(n/1e3/4294967296>>0)),o.setUint32(a+4,n)}else if(isNaN(n)){if(this.onInvalidDate)return e(0),t(this.onInvalidDate());let{target:s,targetView:o,position:a}=e(3);s[a++]=212,s[a++]=255,s[a++]=255}else{let{target:s,targetView:o,position:a}=e(15);s[a++]=199,s[a++]=12,s[a++]=255,o.setUint32(a,i.getMilliseconds()*1e6),o.setBigInt64(a+4,BigInt(Math.floor(n)))}}},{pack(i,e,t){if(this.setAsEmptyObject)return e(0),t({});let n=Array.from(i),{target:s,position:o}=e(this.moreTypes?3:0);this.moreTypes&&(s[o++]=212,s[o++]=115,s[o++]=0),t(n)}},{pack(i,e,t){let{target:n,position:s}=e(this.moreTypes?3:0);this.moreTypes&&(n[s++]=212,n[s++]=101,n[s++]=0),t([i.name,i.message,i.cause])}},{pack(i,e,t){let{target:n,position:s}=e(this.moreTypes?3:0);this.moreTypes&&(n[s++]=212,n[s++]=120,n[s++]=0),t([i.source,i.flags])}},{pack(i,e){this.moreTypes?Xr(i,16,e):Zr(bs?Buffer.from(i):new Uint8Array(i),e)}},{pack(i,e){let t=i.constructor;t!==Aa&&this.moreTypes?Xr(i,wa.indexOf(t.name),e):Zr(i,e)}},{pack(i,e){let{target:t,position:n}=e(1);t[n]=193}}];function Xr(i,e,t,n){let s=i.byteLength;if(s+1<256){var{target:o,position:a}=t(4+s);o[a++]=199,o[a++]=s+1}else if(s+1<65536){var{target:o,position:a}=t(5+s);o[a++]=200,o[a++]=s+1>>8,o[a++]=s+1&255}else{var{target:o,position:a,targetView:l}=t(7+s);o[a++]=201,l.setUint32(a,s+1),a+=4}o[a++]=116,o[a++]=e,i.buffer||(i=new Uint8Array(i)),o.set(new Uint8Array(i.buffer,i.byteOffset,i.byteLength),a)}function Zr(i,e){let t=i.byteLength;var n,s;if(t<256){var{target:n,position:s}=e(t+2);n[s++]=196,n[s++]=t}else if(t<65536){var{target:n,position:s}=e(t+3);n[s++]=197,n[s++]=t>>8,n[s++]=t&255}else{var{target:n,position:s,targetView:o}=e(t+5);n[s++]=198,o.setUint32(s,t),s+=4}n.set(i,s)}function Dl(i,e,t,n){let s=i.length;switch(s){case 1:e[t++]=212;break;case 2:e[t++]=213;break;case 4:e[t++]=214;break;case 8:e[t++]=215;break;case 16:e[t++]=216;break;default:s<256?(e[t++]=199,e[t++]=s):s<65536?(e[t++]=200,e[t++]=s>>8,e[t++]=s&255):(e[t++]=201,e[t++]=s>>24,e[t++]=s>>16&255,e[t++]=s>>8&255,e[t++]=s&255)}return e[t++]=n,e.set(i,t),t+=s,t}function Bl(i,e){let t,n=e.length*6,s=i.length-n;for(;t=e.pop();){let o=t.offset,a=t.id;i.copyWithin(o+n,o,s),n-=6;let l=o+n;i[l++]=214,i[l++]=105,i[l++]=a>>24,i[l++]=a>>16&255,i[l++]=a>>8&255,i[l++]=a&255,s=o}return i}function Qr(i,e,t){if(ge.length>0){de.setUint32(ge.position+i,_+t-ge.position-i),ge.stringsPosition=_-i;let n=ge;ge=null,e(n[0]),e(n[1])}}function $l(i){if(i.Class){if(!i.pack&&!i.write)throw new Error("Extension has no pack or write function");if(i.pack&&!i.type)throw new Error("Extension has no type (numeric code to identify the extension)");Oi.unshift(i.Class),ds.unshift(i)}Sl(i)}function Ll(i,e){return i.isCompatible=t=>{let n=!t||(e.lastNamedStructuresLength||0)===t.length;return n||e._mergeStructures(t),n},i}let Ta=new _n({useRecords:!1});const Nl=Ta.pack,kl=Ta.pack,Fl=_n,{NEVER:jl,ALWAYS:Vl,DECIMAL_ROUND:Ul,DECIMAL_FIT:zl}=ba,Sa=512,va=1024,Pa=2048;function Hl(i,e={}){if(!i||typeof i!="object")throw new Error("first argument must be an Iterable, Async Iterable, or a Promise for an Async Iterable");if(typeof i[Symbol.iterator]=="function")return ql(i,e);if(typeof i.then=="function"||typeof i[Symbol.asyncIterator]=="function")return Wl(i,e);throw new Error("first argument must be an Iterable, Async Iterable, Iterator, Async Iterator, or a Promise")}function*ql(i,e){const t=new _n(e);for(const n of i)yield t.pack(n)}async function*Wl(i,e){const t=new _n(e);for await(const n of i)yield t.pack(n)}function Gl(i,e={}){if(!i||typeof i!="object")throw new Error("first argument must be an Iterable, Async Iterable, Iterator, Async Iterator, or a promise");const t=new vt(e);let n;const s=o=>{let a;n&&(o=Buffer.concat([n,o]),n=void 0);try{a=t.unpackMultiple(o)}catch(l){if(l.incomplete)n=o.slice(l.lastPosition),a=l.values;else throw l}return a};if(typeof i[Symbol.iterator]=="function")return function*(){for(const a of i)yield*s(a)}();if(typeof i[Symbol.asyncIterator]=="function")return async function*(){for await(const a of i)yield*s(a)}()}const Jl=Gl,Kl=Hl,Yl=!1,Xl=!0,Zl=Object.freeze(Object.defineProperty({__proto__:null,ALWAYS:Vl,C1:Pi,DECIMAL_FIT:zl,DECIMAL_ROUND:Ul,Decoder:vl,Encoder:Fl,FLOAT32_OPTIONS:ba,NEVER:jl,Packr:_n,RESERVE_START_SPACE:Pa,RESET_BUFFER_MODE:va,REUSE_BUFFER_MODE:Sa,Unpackr:vt,addExtension:$l,clearSource:hs,decode:_l,decodeIter:Jl,encode:kl,encodeIter:Kl,isNativeAccelerationEnabled:bl,mapsAsObjects:Xl,pack:Nl,roundFloat32:Ol,unpack:Pl,unpackMultiple:Il,useRecords:Yl},Symbol.toStringTag,{value:"Module"})),Ql=Ti(Zl);var eo;function _a(){if(eo)return $s;eo=1;var i=dl(),e=ca(),t=la(),n=fa(),s=pl(),o=vi(),a=ua(),l=ys(),d=Ql;let p=class Ia{constructor(f,h){this.onStateChange=s.createSignal(),this.onError=s.createSignal(),this.onLeave=s.createSignal(),this.onJoin=s.createSignal(),this.hasJoined=!1,this.onMessageHandlers=n.createNanoEvents(),this.roomId=null,this.name=f,this.packr=new d.Packr,this.packr.encode(void 0),h&&(this.serializer=new(t.getSerializer("schema")),this.rootSchema=h,this.serializer.state=new h),this.onError((g,E)=>{var A;return(A=console.warn)===null||A===void 0?void 0:A.call(console,`colyseus.js - onError => (${g}) ${E}`)}),this.onLeave(()=>this.removeAllListeners())}connect(f,h,g=this,E,A){const b=new i.Connection(E.protocol);if(g.connection=b,b.events.onmessage=Ia.prototype.onMessageCallback.bind(g),b.events.onclose=function(S){var P;if(!g.hasJoined){(P=console.warn)===null||P===void 0||P.call(console,`Room connection was closed unexpectedly (${S.code}): ${S.reason}`),g.onError.invoke(S.code,S.reason);return}S.code===l.CloseCode.DEVMODE_RESTART&&h?h():(g.onLeave.invoke(S.code,S.reason),g.destroy())},b.events.onerror=function(S){var P;(P=console.warn)===null||P===void 0||P.call(console,`Room, onError (${S.code}): ${S.reason}`),g.onError.invoke(S.code,S.reason)},E.protocol==="h3"){const S=new URL(f);b.connect(S.origin,E)}else b.connect(f,A)}leave(f=!0){return new Promise(h=>{this.onLeave(g=>h(g)),this.connection?f?(this.packr.buffer[0]=e.Protocol.LEAVE_ROOM,this.connection.send(this.packr.buffer.subarray(0,1))):this.connection.close():this.onLeave.invoke(l.CloseCode.CONSENTED)})}onMessage(f,h){return this.onMessageHandlers.on(this.getMessageHandlerKey(f),h)}send(f,h){const g={offset:1};this.packr.buffer[0]=e.Protocol.ROOM_DATA,typeof f=="string"?o.encode.string(this.packr.buffer,f,g):o.encode.number(this.packr.buffer,f,g),this.packr.position=0;const E=h!==void 0?this.packr.pack(h,2048+g.offset):this.packr.buffer.subarray(0,g.offset);this.connection.send(E)}sendUnreliable(f,h){const g={offset:1};this.packr.buffer[0]=e.Protocol.ROOM_DATA,typeof f=="string"?o.encode.string(this.packr.buffer,f,g):o.encode.number(this.packr.buffer,f,g),this.packr.position=0;const E=h!==void 0?this.packr.pack(h,2048+g.offset):this.packr.buffer.subarray(0,g.offset);this.connection.sendUnreliable(E)}sendBytes(f,h){const g={offset:1};if(this.packr.buffer[0]=e.Protocol.ROOM_DATA_BYTES,typeof f=="string"?o.encode.string(this.packr.buffer,f,g):o.encode.number(this.packr.buffer,f,g),h.byteLength+g.offset>this.packr.buffer.byteLength){const E=new Uint8Array(g.offset+h.byteLength);E.set(this.packr.buffer),this.packr.useBuffer(E)}this.packr.buffer.set(h,g.offset),this.connection.send(this.packr.buffer.subarray(0,g.offset+h.byteLength))}get state(){return this.serializer.getState()}removeAllListeners(){this.onJoin.clear(),this.onStateChange.clear(),this.onError.clear(),this.onLeave.clear(),this.onMessageHandlers.events={},this.serializer instanceof a.SchemaSerializer&&(this.serializer.decoder.root.callbacks={})}onMessageCallback(f){const h=new Uint8Array(f.data),g={offset:1},E=h[0];if(E===e.Protocol.JOIN_ROOM){const A=o.decode.utf8Read(h,g,h[g.offset++]);if(this.serializerId=o.decode.utf8Read(h,g,h[g.offset++]),!this.serializer){const b=t.getSerializer(this.serializerId);this.serializer=new b}h.byteLength>g.offset&&this.serializer.handshake&&this.serializer.handshake(h,g),this.reconnectionToken=`${this.roomId}:${A}`,this.hasJoined=!0,this.onJoin.invoke(),this.packr.buffer[0]=e.Protocol.JOIN_ROOM,this.connection.send(this.packr.buffer.subarray(0,1))}else if(E===e.Protocol.ERROR){const A=o.decode.number(h,g),b=o.decode.string(h,g);this.onError.invoke(A,b)}else if(E===e.Protocol.LEAVE_ROOM)this.leave();else if(E===e.Protocol.ROOM_STATE)this.serializer.setState(h,g),this.onStateChange.invoke(this.serializer.getState());else if(E===e.Protocol.ROOM_STATE_PATCH)this.serializer.patch(h,g),this.onStateChange.invoke(this.serializer.getState());else if(E===e.Protocol.ROOM_DATA){const A=o.decode.stringCheck(h,g)?o.decode.string(h,g):o.decode.number(h,g),b=h.byteLength>g.offset?d.unpack(h,{start:g.offset}):void 0;this.dispatchMessage(A,b)}else if(E===e.Protocol.ROOM_DATA_BYTES){const A=o.decode.stringCheck(h,g)?o.decode.string(h,g):o.decode.number(h,g);this.dispatchMessage(A,h.subarray(g.offset))}}dispatchMessage(f,h){var g;const E=this.getMessageHandlerKey(f);this.onMessageHandlers.events[E]?this.onMessageHandlers.emit(E,h):this.onMessageHandlers.events["*"]?this.onMessageHandlers.emit("*",f,h):(g=console.warn)===null||g===void 0||g.call(console,`colyseus.js: onMessage() not registered for type '${f}'.`)}destroy(){this.serializer&&this.serializer.teardown()}getMessageHandlerKey(f){switch(typeof f){case"string":return f;case"number":return`i${f}`;default:throw new Error("invalid message type.")}}};return $s.Room=p,$s}var zs={};function to(i,e){e.headers=i.headers||{},e.statusMessage=i.statusText,e.statusCode=i.status,e.data=i.response}function et(i,e,t){return new Promise(function(n,s){t=t||{};var o=new XMLHttpRequest,a,l,d,p=t.body,m=t.headers||{};t.timeout&&(o.timeout=t.timeout),o.ontimeout=o.onerror=function(f){f.timeout=f.type=="timeout",s(f)},o.open(i,e.href||e),o.onload=function(){for(d=o.getAllResponseHeaders().trim().split(/[\r\n]+/),to(o,o);l=d.shift();)l=l.split(": "),o.headers[l.shift().toLowerCase()]=l.join(": ");if(l=o.headers["content-type"],l&&~l.indexOf("application/json"))try{o.data=JSON.parse(o.data,t.reviver)}catch(f){return to(o,f),s(f)}(o.status>=400?s:n)(o)},typeof FormData<"u"&&p instanceof FormData||p&&typeof p=="object"&&(m["content-type"]="application/json",p=JSON.stringify(p)),o.withCredentials=!!t.withCredentials;for(a in m)o.setRequestHeader(a,m[a]);o.send(p)})}var ef=et.bind(et,"GET"),tf=et.bind(et,"POST"),nf=et.bind(et,"PATCH"),sf=et.bind(et,"DELETE"),rf=et.bind(et,"PUT");const of=Object.freeze(Object.defineProperty({__proto__:null,del:sf,get:ef,patch:nf,post:tf,put:rf,send:et},Symbol.toStringTag,{value:"Module"})),af=Ti(of);var no;function cf(){if(no)return zs;no=1;var i=ys(),e=af;function t(o){var a=Object.create(null);return o&&Object.keys(o).forEach(function(l){if(l!=="default"){var d=Object.getOwnPropertyDescriptor(o,l);Object.defineProperty(a,l,d.get?d:{enumerable:!0,get:function(){return o[l]}})}}),a.default=o,Object.freeze(a)}var n=t(e);let s=class{constructor(a,l={}){this.client=a,this.headers=l}get(a,l={}){return this.request("get",a,l)}post(a,l={}){return this.request("post",a,l)}del(a,l={}){return this.request("del",a,l)}put(a,l={}){return this.request("put",a,l)}request(a,l,d={}){return n[a](this.client.getHttpEndpoint(l),this.getOptions(d)).catch(p=>{var m;const f=p.statusCode,h=((m=p.data)===null||m===void 0?void 0:m.error)||p.statusMessage||p.message;throw!f&&!h?p:new i.ServerError(f,h)})}getOptions(a){return a.headers=Object.assign({},this.headers,a.headers),this.authToken&&(a.headers.Authorization=`Bearer ${this.authToken}`),typeof cc<"u"&&cc.sys&&cc.sys.isNative||(a.withCredentials=!0),a}};return zs.HTTP=s,zs}var Hs={},hn={},so;function lf(){if(so)return hn;so=1;var i=gs;let e;function t(){if(!e)try{e=typeof cc<"u"&&cc.sys&&cc.sys.localStorage?cc.sys.localStorage:window.localStorage}catch{}return!e&&typeof globalThis.indexedDB<"u"&&(e=new a),e||(e={cache:{},setItem:function(l,d){this.cache[l]=d},getItem:function(l){this.cache[l]},removeItem:function(l){delete this.cache[l]}}),e}function n(l,d){t().setItem(l,d)}function s(l){t().removeItem(l)}function o(l,d){const p=t().getItem(l);typeof Promise>"u"||!(p instanceof Promise)?d(p):p.then(m=>d(m))}class a{constructor(){this.dbPromise=new Promise(d=>{const p=indexedDB.open("_colyseus_storage",1);p.onupgradeneeded=()=>p.result.createObjectStore("store"),p.onsuccess=()=>d(p.result)})}tx(d,p){return i.__awaiter(this,void 0,void 0,function*(){const f=(yield this.dbPromise).transaction("store",d).objectStore("store");return p(f)})}setItem(d,p){return this.tx("readwrite",m=>m.put(p,d)).then()}getItem(d){return i.__awaiter(this,void 0,void 0,function*(){const p=yield this.tx("readonly",m=>m.get(d));return new Promise(m=>{p.onsuccess=()=>m(p.result)})})}removeItem(d){return this.tx("readwrite",p=>p.delete(d)).then()}}return hn.getItem=o,hn.removeItem=s,hn.setItem=n,hn}var io;function Oa(){if(io)return Hs;io=1;var i=gs,e=lf(),t=fa(),n,s,o,a;let l=class{constructor(p){this.http=p,this.settings={path:"/auth",key:"colyseus-auth-token"},n.set(this,!1),s.set(this,void 0),o.set(this,void 0),a.set(this,t.createNanoEvents()),e.getItem(this.settings.key,m=>this.token=m)}set token(p){this.http.authToken=p}get token(){return this.http.authToken}onChange(p){const m=i.__classPrivateFieldGet(this,a,"f").on("change",p);return i.__classPrivateFieldGet(this,n,"f")||i.__classPrivateFieldSet(this,s,new Promise((f,h)=>{this.getUserData().then(g=>{this.emitChange(Object.assign(Object.assign({},g),{token:this.token}))}).catch(g=>{this.emitChange({user:null,token:void 0})}).finally(()=>{f()})}),"f"),i.__classPrivateFieldSet(this,n,!0,"f"),m}getUserData(){return i.__awaiter(this,void 0,void 0,function*(){if(this.token)return(yield this.http.get(`${this.settings.path}/userdata`)).data;throw new Error("missing auth.token")})}registerWithEmailAndPassword(p,m,f){return i.__awaiter(this,void 0,void 0,function*(){const h=(yield this.http.post(`${this.settings.path}/register`,{body:{email:p,password:m,options:f}})).data;return this.emitChange(h),h})}signInWithEmailAndPassword(p,m){return i.__awaiter(this,void 0,void 0,function*(){const f=(yield this.http.post(`${this.settings.path}/login`,{body:{email:p,password:m}})).data;return this.emitChange(f),f})}signInAnonymously(p){return i.__awaiter(this,void 0,void 0,function*(){const m=(yield this.http.post(`${this.settings.path}/anonymous`,{body:{options:p}})).data;return this.emitChange(m),m})}sendPasswordResetEmail(p){return i.__awaiter(this,void 0,void 0,function*(){return(yield this.http.post(`${this.settings.path}/forgot-password`,{body:{email:p}})).data})}signInWithProvider(p){return i.__awaiter(this,arguments,void 0,function*(m,f={}){return new Promise((h,g)=>{const E=f.width||480,A=f.height||768,b=this.token?`?token=${this.token}`:"",S=`Login with ${m[0].toUpperCase()+m.substring(1)}`,P=this.http.client.getHttpEndpoint(`${f.prefix||`${this.settings.path}/provider`}/${m}${b}`),M=screen.width/2-E/2,C=screen.height/2-A/2;i.__classPrivateFieldSet(this,o,window.open(P,S,"toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no, width="+E+", height="+A+", top="+C+", left="+M),"f");const B=N=>{N.data.user===void 0&&N.data.token===void 0||(clearInterval($),i.__classPrivateFieldGet(this,o,"f").close(),i.__classPrivateFieldSet(this,o,void 0,"f"),window.removeEventListener("message",B),N.data.error!==void 0?g(N.data.error):(h(N.data),this.emitChange(N.data)))},$=setInterval(()=>{(!i.__classPrivateFieldGet(this,o,"f")||i.__classPrivateFieldGet(this,o,"f").closed)&&(i.__classPrivateFieldSet(this,o,void 0,"f"),g("cancelled"),window.removeEventListener("message",B))},200);window.addEventListener("message",B)})})}signOut(){return i.__awaiter(this,void 0,void 0,function*(){this.emitChange({user:null,token:null})})}emitChange(p){p.token!==void 0&&(this.token=p.token,p.token===null?e.removeItem(this.settings.key):e.setItem(this.settings.key,p.token)),i.__classPrivateFieldGet(this,a,"f").emit("change",p)}};return n=new WeakMap,s=new WeakMap,o=new WeakMap,a=new WeakMap,Hs.Auth=l,Hs}var qs={},ro;function ff(){if(ro)return qs;ro=1;function i(e){var t;const n=((t=window==null?void 0:window.location)===null||t===void 0?void 0:t.hostname)||"localhost",s=e.hostname.split("."),o=!e.hostname.includes("trycloudflare.com")&&!e.hostname.includes("discordsays.com")&&s.length>2?`/${s[0]}`:"";return e.pathname.startsWith("/.proxy")?`${e.protocol}//${n}${o}${e.pathname}${e.search}`:`${e.protocol}//${n}/.proxy/colyseus${o}${e.pathname}${e.search}`}return qs.discordURLBuilder=i,qs}var oo;function uf(){if(oo)return Fn;oo=1;var i=gs,e=ys(),t=_a(),n=cf(),s=Oa(),o=ff(),a;class l extends Error{constructor(f,h){super(f),this.code=h,this.name="MatchMakeError",Object.setPrototypeOf(this,l.prototype)}}const d=typeof window<"u"&&typeof((a=window==null?void 0:window.location)===null||a===void 0?void 0:a.hostname)<"u"?`${window.location.protocol.replace("http","ws")}//${window.location.hostname}${window.location.port&&`:${window.location.port}`}`:"ws://127.0.0.1:2567";let p=class{constructor(f=d,h){var g,E;if(typeof f=="string"){const A=f.startsWith("/")?new URL(f,d):new URL(f),b=A.protocol==="https:"||A.protocol==="wss:",S=Number(A.port||(b?443:80));this.settings={hostname:A.hostname,pathname:A.pathname,port:S,secure:b}}else f.port===void 0&&(f.port=f.secure?443:80),f.pathname===void 0&&(f.pathname=""),this.settings=f;this.settings.pathname.endsWith("/")&&(this.settings.pathname=this.settings.pathname.slice(0,-1)),this.http=new n.HTTP(this,(h==null?void 0:h.headers)||{}),this.auth=new s.Auth(this.http),this.urlBuilder=h==null?void 0:h.urlBuilder,!this.urlBuilder&&typeof window<"u"&&(!((E=(g=window==null?void 0:window.location)===null||g===void 0?void 0:g.hostname)===null||E===void 0)&&E.includes("discordsays.com"))&&(this.urlBuilder=o.discordURLBuilder)}joinOrCreate(f){return i.__awaiter(this,arguments,void 0,function*(h,g={},E){return yield this.createMatchMakeRequest("joinOrCreate",h,g,E)})}create(f){return i.__awaiter(this,arguments,void 0,function*(h,g={},E){return yield this.createMatchMakeRequest("create",h,g,E)})}join(f){return i.__awaiter(this,arguments,void 0,function*(h,g={},E){return yield this.createMatchMakeRequest("join",h,g,E)})}joinById(f){return i.__awaiter(this,arguments,void 0,function*(h,g={},E){return yield this.createMatchMakeRequest("joinById",h,g,E)})}reconnect(f,h){return i.__awaiter(this,void 0,void 0,function*(){if(typeof f=="string"&&typeof h=="string")throw new Error("DEPRECATED: .reconnect() now only accepts 'reconnectionToken' as argument.\nYou can get this token from previously connected `room.reconnectionToken`");const[g,E]=f.split(":");if(!g||!E)throw new Error(`Invalid reconnection token format.
The format should be roomId:reconnectionToken`);return yield this.createMatchMakeRequest("reconnect",g,{reconnectionToken:E},h)})}consumeSeatReservation(f,h,g){return i.__awaiter(this,void 0,void 0,function*(){const E=this.createRoom(f.room.name,h);E.roomId=f.room.roomId,E.sessionId=f.sessionId;const A={sessionId:E.sessionId};f.reconnectionToken&&(A.reconnectionToken=f.reconnectionToken);const b=g||E;return E.connect(this.buildEndpoint(f.room,A,f.protocol),f.devMode&&(()=>i.__awaiter(this,void 0,void 0,function*(){console.info(`[Colyseus devMode]: ${String.fromCodePoint(128260)} Re-establishing connection with room id '${E.roomId}'...`);let S=0,P=8;const M=()=>i.__awaiter(this,void 0,void 0,function*(){S++;try{yield this.consumeSeatReservation(f,h,b),console.info(`[Colyseus devMode]: ${String.fromCodePoint(9989)} Successfully re-established connection with room '${E.roomId}'`)}catch{S<P?(console.info(`[Colyseus devMode]: ${String.fromCodePoint(128260)} retrying... (${S} out of ${P})`),setTimeout(M,2e3)):console.info(`[Colyseus devMode]: ${String.fromCodePoint(10060)} Failed to reconnect. Is your server running? Please check server logs.`)}});setTimeout(M,2e3)})),b,f,this.http.headers),new Promise((S,P)=>{const M=(C,B)=>P(new e.ServerError(C,B));b.onError.once(M),b.onJoin.once(()=>{b.onError.remove(M),S(b)})})})}createMatchMakeRequest(f,h){return i.__awaiter(this,arguments,void 0,function*(g,E,A={},b,S){const P=(yield this.http.post(`matchmake/${g}/${E}`,{headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(A)})).data;if(P.error)throw new l(P.error,P.code);return g==="reconnect"&&(P.reconnectionToken=A.reconnectionToken),yield this.consumeSeatReservation(P,b,S)})}createRoom(f,h){return new t.Room(f,h)}buildEndpoint(f,h={},g="ws"){const E=[];this.http.authToken&&(h._authToken=this.http.authToken);for(const S in h)h.hasOwnProperty(S)&&E.push(`${S}=${h[S]}`);g==="h3"&&(g="http");let A=this.settings.secure?`${g}s://`:`${g}://`;f.publicAddress?A+=`${f.publicAddress}`:A+=`${this.settings.hostname}${this.getEndpointPort()}${this.settings.pathname}`;const b=`${A}/${f.processId}/${f.roomId}?${E.join("&")}`;return this.urlBuilder?this.urlBuilder(new URL(b)):b}getHttpEndpoint(f=""){const h=f.startsWith("/")?f:`/${f}`,g=`${this.settings.secure?"https":"http"}://${this.settings.hostname}${this.getEndpointPort()}${this.settings.pathname}${h}`;return this.urlBuilder?this.urlBuilder(new URL(g)):g}getEndpointPort(){return this.settings.port!==80&&this.settings.port!==443?`:${this.settings.port}`:""}};return p.VERSION="0.16.16",Fn.Client=p,Fn.MatchMakeError=l,Fn}var Ws={},ao;function hf(){if(ao)return Ws;ao=1;let i=class{setState(t){}getState(){return null}patch(t){}teardown(){}handshake(t){}};return Ws.NoneSerializer=i,Ws}var co;function df(){return co||(co=1,function(i){il();var e=uf(),t=ca(),n=_a(),s=Oa(),o=ys(),a=ua(),l=hf(),d=la();d.registerSerializer("schema",a.SchemaSerializer),d.registerSerializer("none",l.NoneSerializer),i.Client=e.Client,i.MatchMakeError=e.MatchMakeError,Object.defineProperty(i,"ErrorCode",{enumerable:!0,get:function(){return t.ErrorCode}}),Object.defineProperty(i,"Protocol",{enumerable:!0,get:function(){return t.Protocol}}),i.Room=n.Room,i.Auth=s.Auth,i.ServerError=o.ServerError,i.SchemaSerializer=a.SchemaSerializer,i.getStateCallbacks=a.getStateCallbacks,i.registerSerializer=d.registerSerializer}(Ds)),Ds}var lo=df();const as=0,pf=1,mf=new X,fo=new Qe,Gs=new en,uo=new X,qn=new $t;class gf{constructor(){this.tolerance=-1,this.faces=[],this.newFaces=[],this.assigned=new ho,this.unassigned=new ho,this.vertices=[]}setFromPoints(e){if(e.length>=4){this.makeEmpty();for(let t=0,n=e.length;t<n;t++)this.vertices.push(new yf(e[t]));this._compute()}return this}setFromObject(e){const t=[];return e.updateMatrixWorld(!0),e.traverse(function(n){const s=n.geometry;if(s!==void 0){const o=s.attributes.position;if(o!==void 0)for(let a=0,l=o.count;a<l;a++){const d=new X;d.fromBufferAttribute(o,a).applyMatrix4(n.matrixWorld),t.push(d)}}}),this.setFromPoints(t)}containsPoint(e){const t=this.faces;for(let n=0,s=t.length;n<s;n++)if(t[n].distanceToPoint(e)>this.tolerance)return!1;return!0}intersectRay(e,t){const n=this.faces;let s=-1/0,o=1/0;for(let a=0,l=n.length;a<l;a++){const d=n[a],p=d.distanceToPoint(e.origin),m=d.normal.dot(e.direction);if(p>0&&m>=0)return null;const f=m!==0?-p/m:0;if(!(f<=0)&&(m>0?o=Math.min(f,o):s=Math.max(f,s),s>o))return null}return s!==-1/0?e.at(s,t):e.at(o,t),t}intersectsRay(e){return this.intersectRay(e,mf)!==null}makeEmpty(){return this.faces=[],this.vertices=[],this}_addVertexToFace(e,t){return e.face=t,t.outside===null?this.assigned.append(e):this.assigned.insertBefore(t.outside,e),t.outside=e,this}_removeVertexFromFace(e,t){return e===t.outside&&(e.next!==null&&e.next.face===t?t.outside=e.next:t.outside=null),this.assigned.remove(e),this}_removeAllVerticesFromFace(e){if(e.outside!==null){const t=e.outside;let n=e.outside;for(;n.next!==null&&n.next.face===e;)n=n.next;return this.assigned.removeSubList(t,n),t.prev=n.next=null,e.outside=null,t}}_deleteFaceVertices(e,t){const n=this._removeAllVerticesFromFace(e);if(n!==void 0)if(t===void 0)this.unassigned.appendChain(n);else{let s=n;do{const o=s.next;t.distanceToPoint(s.point)>this.tolerance?this._addVertexToFace(s,t):this.unassigned.append(s),s=o}while(s!==null)}return this}_resolveUnassignedPoints(e){if(this.unassigned.isEmpty()===!1){let t=this.unassigned.first();do{const n=t.next;let s=this.tolerance,o=null;for(let a=0;a<e.length;a++){const l=e[a];if(l.mark===as){const d=l.distanceToPoint(t.point);if(d>s&&(s=d,o=l),s>1e3*this.tolerance)break}}o!==null&&this._addVertexToFace(t,o),t=n}while(t!==null)}return this}_computeExtremes(){const e=new X,t=new X,n=[],s=[];for(let o=0;o<3;o++)n[o]=s[o]=this.vertices[0];e.copy(this.vertices[0].point),t.copy(this.vertices[0].point);for(let o=0,a=this.vertices.length;o<a;o++){const l=this.vertices[o],d=l.point;for(let p=0;p<3;p++)d.getComponent(p)<e.getComponent(p)&&(e.setComponent(p,d.getComponent(p)),n[p]=l);for(let p=0;p<3;p++)d.getComponent(p)>t.getComponent(p)&&(t.setComponent(p,d.getComponent(p)),s[p]=l)}return this.tolerance=3*Number.EPSILON*(Math.max(Math.abs(e.x),Math.abs(t.x))+Math.max(Math.abs(e.y),Math.abs(t.y))+Math.max(Math.abs(e.z),Math.abs(t.z))),{min:n,max:s}}_computeInitialHull(){const e=this.vertices,t=this._computeExtremes(),n=t.min,s=t.max;let o=0,a=0;for(let h=0;h<3;h++){const g=s[h].point.getComponent(h)-n[h].point.getComponent(h);g>o&&(o=g,a=h)}const l=n[a],d=s[a];let p,m;o=0,fo.set(l.point,d.point);for(let h=0,g=this.vertices.length;h<g;h++){const E=e[h];if(E!==l&&E!==d){fo.closestPointToPoint(E.point,!0,uo);const A=uo.distanceToSquared(E.point);A>o&&(o=A,p=E)}}o=-1,Gs.setFromCoplanarPoints(l.point,d.point,p.point);for(let h=0,g=this.vertices.length;h<g;h++){const E=e[h];if(E!==l&&E!==d&&E!==p){const A=Math.abs(Gs.distanceToPoint(E.point));A>o&&(o=A,m=E)}}const f=[];if(Gs.distanceToPoint(m.point)<0){f.push(Ze.create(l,d,p),Ze.create(m,d,l),Ze.create(m,p,d),Ze.create(m,l,p));for(let h=0;h<3;h++){const g=(h+1)%3;f[h+1].getEdge(2).setTwin(f[0].getEdge(g)),f[h+1].getEdge(1).setTwin(f[g+1].getEdge(0))}}else{f.push(Ze.create(l,p,d),Ze.create(m,l,d),Ze.create(m,d,p),Ze.create(m,p,l));for(let h=0;h<3;h++){const g=(h+1)%3;f[h+1].getEdge(2).setTwin(f[0].getEdge((3-h)%3)),f[h+1].getEdge(0).setTwin(f[g+1].getEdge(1))}}for(let h=0;h<4;h++)this.faces.push(f[h]);for(let h=0,g=e.length;h<g;h++){const E=e[h];if(E!==l&&E!==d&&E!==p&&E!==m){o=this.tolerance;let A=null;for(let b=0;b<4;b++){const S=this.faces[b].distanceToPoint(E.point);S>o&&(o=S,A=this.faces[b])}A!==null&&this._addVertexToFace(E,A)}}return this}_reindexFaces(){const e=[];for(let t=0;t<this.faces.length;t++){const n=this.faces[t];n.mark===as&&e.push(n)}return this.faces=e,this}_nextVertexToAdd(){if(this.assigned.isEmpty()===!1){let e,t=0;const n=this.assigned.first().face;let s=n.outside;do{const o=n.distanceToPoint(s.point);o>t&&(t=o,e=s),s=s.next}while(s!==null&&s.face===n);return e}}_computeHorizon(e,t,n,s){this._deleteFaceVertices(n),n.mark=pf;let o;t===null?o=t=n.getEdge(0):o=t.next;do{const a=o.twin,l=a.face;l.mark===as&&(l.distanceToPoint(e)>this.tolerance?this._computeHorizon(e,a,l,s):s.push(o)),o=o.next}while(o!==t);return this}_addAdjoiningFace(e,t){const n=Ze.create(e,t.tail(),t.head());return this.faces.push(n),n.getEdge(-1).setTwin(t.twin),n.getEdge(0)}_addNewFaces(e,t){this.newFaces=[];let n=null,s=null;for(let o=0;o<t.length;o++){const a=t[o],l=this._addAdjoiningFace(e,a);n===null?n=l:l.next.setTwin(s),this.newFaces.push(l.face),s=l}return n.next.setTwin(s),this}_addVertexToHull(e){const t=[];return this.unassigned.clear(),this._removeVertexFromFace(e,e.face),this._computeHorizon(e.point,null,e.face,t),this._addNewFaces(e,t),this._resolveUnassignedPoints(this.newFaces),this}_cleanup(){return this.assigned.clear(),this.unassigned.clear(),this.newFaces=[],this}_compute(){let e;for(this._computeInitialHull();(e=this._nextVertexToAdd())!==void 0;)this._addVertexToHull(e);return this._reindexFaces(),this._cleanup(),this}}class Ze{constructor(){this.normal=new X,this.midpoint=new X,this.area=0,this.constant=0,this.outside=null,this.mark=as,this.edge=null}static create(e,t,n){const s=new Ze,o=new Js(e,s),a=new Js(t,s),l=new Js(n,s);return o.next=l.prev=a,a.next=o.prev=l,l.next=a.prev=o,s.edge=o,s.compute()}getEdge(e){let t=this.edge;for(;e>0;)t=t.next,e--;for(;e<0;)t=t.prev,e++;return t}compute(){const e=this.edge.tail(),t=this.edge.head(),n=this.edge.next.head();return qn.set(e.point,t.point,n.point),qn.getNormal(this.normal),qn.getMidpoint(this.midpoint),this.area=qn.getArea(),this.constant=this.normal.dot(this.midpoint),this}distanceToPoint(e){return this.normal.dot(e)-this.constant}}class Js{constructor(e,t){this.vertex=e,this.prev=null,this.next=null,this.twin=null,this.face=t}head(){return this.vertex}tail(){return this.prev?this.prev.vertex:null}length(){const e=this.head(),t=this.tail();return t!==null?t.point.distanceTo(e.point):-1}lengthSquared(){const e=this.head(),t=this.tail();return t!==null?t.point.distanceToSquared(e.point):-1}setTwin(e){return this.twin=e,e.twin=this,this}}class yf{constructor(e){this.point=e,this.prev=null,this.next=null,this.face=null}}class ho{constructor(){this.head=null,this.tail=null}first(){return this.head}last(){return this.tail}clear(){return this.head=this.tail=null,this}insertBefore(e,t){return t.prev=e.prev,t.next=e,t.prev===null?this.head=t:t.prev.next=t,e.prev=t,this}insertAfter(e,t){return t.prev=e,t.next=e.next,t.next===null?this.tail=t:t.next.prev=t,e.next=t,this}append(e){return this.head===null?this.head=e:this.tail.next=e,e.prev=this.tail,e.next=null,this.tail=e,this}appendChain(e){for(this.head===null?this.head=e:this.tail.next=e,e.prev=this.tail;e.next!==null;)e=e.next;return this.tail=e,this}remove(e){return e.prev===null?this.head=e.next:e.prev.next=e.next,e.next===null?this.tail=e.prev:e.next.prev=e.prev,this}removeSubList(e,t){return e.prev===null?this.head=t.next:e.prev.next=t.next,t.next===null?this.tail=e.prev:t.next.prev=e.prev,this}isEmpty(){return this.head===null}}class po extends ai{constructor(e=[]){super();const t=[],n=[],o=new gf().setFromPoints(e).faces;for(let a=0;a<o.length;a++){const l=o[a];let d=l.edge;do{const p=d.head().point;t.push(p.x,p.y,p.z),n.push(l.normal.x,l.normal.y,l.normal.z),d=d.next}while(d!==l.edge)}this.setAttribute("position",new xt(t,3)),this.setAttribute("normal",new xt(n,3))}}const wf=new X;class Tn{constructor(e=1.4,t=1e-4){this.minSizeForBreak=e,this.smallDelta=t,this.tempLine1=new Qe,this.tempPlane1=new en,this.tempPlane2=new en,this.tempPlane_Cut=new en,this.tempCM1=new X,this.tempCM2=new X,this.tempVector3=new X,this.tempVector3_2=new X,this.tempVector3_3=new X,this.tempVector3_P0=new X,this.tempVector3_P1=new X,this.tempVector3_P2=new X,this.tempVector3_N0=new X,this.tempVector3_N1=new X,this.tempVector3_AB=new X,this.tempVector3_CB=new X,this.tempResultObjects={object1:null,object2:null},this.segments=[];const n=30*30;for(let s=0;s<n;s++)this.segments[s]=!1}prepareBreakableObject(e,t,n,s,o){const a=e.userData;a.mass=t,a.velocity=n.clone(),a.angularVelocity=s.clone(),a.breakable=o}subdivideByImpact(e,t,n,s,o){const a=[],l=this.tempPlane1,d=this.tempPlane2;this.tempVector3.addVectors(t,n),l.setFromCoplanarPoints(t,e.position,this.tempVector3);const p=o+s,m=this;function f(h,g,E,A){if(Math.random()<A*.05||A>p){a.push(h);return}let b=Math.PI;A===0?(d.normal.copy(l.normal),d.constant=l.constant):A<=s?(b=(E-g)*(.2+.6*Math.random())+g,m.tempVector3_2.copy(e.position).sub(t).applyAxisAngle(n,b).add(t),d.setFromCoplanarPoints(t,m.tempVector3,m.tempVector3_2)):(b=(.5*(A&1)+.2*(2-Math.random()))*Math.PI,m.tempVector3_2.copy(t).sub(h.position).applyAxisAngle(n,b).add(h.position),m.tempVector3_3.copy(n).add(h.position),d.setFromCoplanarPoints(h.position,m.tempVector3_3,m.tempVector3_2)),m.cutByPlane(h,d,m.tempResultObjects);const S=m.tempResultObjects.object1,P=m.tempResultObjects.object2;S&&f(S,g,b,A+1),P&&f(P,b,E,A+1)}return f(e,0,2*Math.PI,0),a}cutByPlane(e,t,n){const s=e.geometry,o=s.attributes.position.array,a=s.attributes.normal.array,l=o.length/3;let d=l/3,p=s.getIndex();p&&(p=p.array,d=p.length/3);function m(F,T){const L=F*3+T;return p?p[L]:L}const f=[],h=[],g=this.smallDelta,E=l*l;for(let F=0;F<E;F++)this.segments[F]=!1;const A=this.tempVector3_P0,b=this.tempVector3_P1,S=this.tempVector3_N0,P=this.tempVector3_N1;for(let F=0;F<d-1;F++){const T=m(F,0),L=m(F,1),j=m(F,2);S.set(a[T],a[T]+1,a[T]+2);for(let k=F+1;k<d;k++){const U=m(k,0),te=m(k,1),oe=m(k,2);P.set(a[U],a[U]+1,a[U]+2),1-S.dot(P)<g&&(T===U||T===te||T===oe?L===U||L===te||L===oe?(this.segments[T*l+L]=!0,this.segments[L*l+T]=!0):(this.segments[j*l+T]=!0,this.segments[T*l+j]=!0):(L===U||L===te||L===oe)&&(this.segments[j*l+L]=!0,this.segments[L*l+j]=!0))}}const M=this.tempPlane_Cut;e.updateMatrix(),Tn.transformPlaneToLocalSpace(t,e.matrix,M);for(let F=0;F<d;F++){const T=m(F,0),L=m(F,1),j=m(F,2);for(let k=0;k<3;k++){const U=k===0?T:k===1?L:j,te=k===0?L:k===1?j:T;if(this.segments[U*l+te])continue;this.segments[U*l+te]=!0,this.segments[te*l+U]=!0,A.set(o[3*U],o[3*U+1],o[3*U+2]),b.set(o[3*te],o[3*te+1],o[3*te+2]);let re=0,ae=M.distanceToPoint(A);ae>g?(re=2,h.push(A.clone())):ae<-g?(re=1,f.push(A.clone())):(re=3,f.push(A.clone()),h.push(A.clone()));let ce=0;if(ae=M.distanceToPoint(b),ae>g?(ce=2,h.push(b.clone())):ae<-g?(ce=1,f.push(b.clone())):(ce=3,f.push(b.clone()),h.push(b.clone())),re===1&&ce===2||re===2&&ce===1){this.tempLine1.start.copy(A),this.tempLine1.end.copy(b);let Ae=new X;if(Ae=M.intersectLine(this.tempLine1,Ae),Ae===null)return console.error("Internal error: segment does not intersect plane."),n.segmentedObject1=null,n.segmentedObject2=null,0;f.push(Ae),h.push(Ae.clone())}}}const C=e.userData.mass*.5;this.tempCM1.set(0,0,0);let B=0;const $=f.length;if($>0){for(let F=0;F<$;F++)this.tempCM1.add(f[F]);this.tempCM1.divideScalar($);for(let F=0;F<$;F++){const T=f[F];T.sub(this.tempCM1),B=Math.max(B,T.x,T.y,T.z)}this.tempCM1.add(e.position)}this.tempCM2.set(0,0,0);let N=0;const W=h.length;if(W>0){for(let F=0;F<W;F++)this.tempCM2.add(h[F]);this.tempCM2.divideScalar(W);for(let F=0;F<W;F++){const T=h[F];T.sub(this.tempCM2),N=Math.max(N,T.x,T.y,T.z)}this.tempCM2.add(e.position)}let z=null,J=null,ee=0;return $>4&&(z=new Ne(new po(f),e.material),z.position.copy(this.tempCM1),z.quaternion.copy(e.quaternion),this.prepareBreakableObject(z,C,e.userData.velocity,e.userData.angularVelocity,2*B>this.minSizeForBreak),ee++),W>4&&(J=new Ne(new po(h),e.material),J.position.copy(this.tempCM2),J.quaternion.copy(e.quaternion),this.prepareBreakableObject(J,C,e.userData.velocity,e.userData.angularVelocity,2*N>this.minSizeForBreak),ee++),n.object1=z,n.object2=J,ee}static transformFreeVector(e,t){const n=e.x,s=e.y,o=e.z,a=t.elements;return e.x=a[0]*n+a[4]*s+a[8]*o,e.y=a[1]*n+a[5]*s+a[9]*o,e.z=a[2]*n+a[6]*s+a[10]*o,e}static transformFreeVectorInverse(e,t){const n=e.x,s=e.y,o=e.z,a=t.elements;return e.x=a[0]*n+a[1]*s+a[2]*o,e.y=a[4]*n+a[5]*s+a[6]*o,e.z=a[8]*n+a[9]*s+a[10]*o,e}static transformTiedVectorInverse(e,t){const n=e.x,s=e.y,o=e.z,a=t.elements;return e.x=a[0]*n+a[1]*s+a[2]*o-a[12],e.y=a[4]*n+a[5]*s+a[6]*o-a[13],e.z=a[8]*n+a[9]*s+a[10]*o-a[14],e}static transformPlaneToLocalSpace(e,t,n){n.normal.copy(e.normal),n.constant=e.constant;const s=Tn.transformTiedVectorInverse(e.coplanarPoint(wf),t);Tn.transformFreeVectorInverse(n.normal,t),n.constant=-s.dot(n.normal)}}const xf=500;class mo{constructor(e,t){Y(this,"mesh");Y(this,"owner");this.mesh=e,this.owner=t}updateMovement(){this.mesh.translateZ(-2)}isOutOfBounds(e){return this.mesh.position.distanceTo(e)>xf}getBoundingBox(){return new Fe().setFromObject(this.mesh)}checkCollisionWith(e){if(this.owner===e)return!1;const t=new Fe().setFromObject(e);return this.getBoundingBox().intersectsBox(t)}removeFromScene(e){e.remove(this.mesh),Ai(this.mesh)}}const go=new Tn;class Ma{constructor(e,t){Y(this,"mesh");Y(this,"collider");Y(this,"assetManager");Y(this,"soundManager");Y(this,"ammo",Yc);Y(this,"lastWeaponFireTime",0);Y(this,"thrust",1e-4);Y(this,"vel",{global:he(0,0,0),local:he(0,0,0)});Y(this,"rot",{yaw:0,roll:0,pitch:0});Y(this,"rotVel",{yaw:0,roll:0,pitch:0});Y(this,"flying",!1);Y(this,"destroyed",!1);Y(this,"shards",[]);this.mesh=e.planeMesh.clone(),this.assetManager=e,this.soundManager=t,this.lastWeaponFireTime=0,this.collider=new Ne(new Oo(10,1,20),this.assetManager.planeMaterial),this.collider.visible=!1,go.prepareBreakableObject(this.collider,1,he(0,0,0),he(0,0,0),!0),this.mesh.add(this.collider)}getAmmo(){return this.ammo}setDestroyed(e){this.destroyed=e,e&&this.soundManager.playExplosionSound()}canFire(){return(performance.now()-this.lastWeaponFireTime>Kc||this.lastWeaponFireTime===0)&&this.ammo>0}fire(e,t){if(!this.canFire())return[];this.ammo--,this.lastWeaponFireTime=performance.now();const n=l=>{const d=he(tn(t.clone().multiplyScalar(-1),he(l,2,-10)));return this.mesh.localToWorld(d.clone())},s=[],o=this.assetManager.weaponModel.clone();o.position.set(...Rs(n(-10))),o.rotation.copy(this.mesh.rotation),e.add(o),s.push(new mo(o,this.mesh));const a=this.assetManager.weaponModel.clone();return a.position.set(...Rs(n(10))),a.rotation.copy(this.mesh.rotation),e.add(a),s.push(new mo(a,this.mesh)),s}updatePhysics(){this.mesh.position.add(this.vel.global),this.mesh.translateX(this.vel.local.x),this.mesh.translateY(this.vel.local.y),this.mesh.translateZ(this.vel.local.z);let e=this.vel.local.z-this.thrust;e>0&&(e=0),this.vel.local.z=e;const t=this.vel.local.z<0?1e-6/-this.vel.local.z:1e-5;this.vel.global.y-=t,this.rotVel.pitch*=Cs,this.rotVel.roll*=Cs,this.rotVel.yaw*=Cs,this.rot.pitch+=this.rotVel.pitch,this.rot.roll+=this.rotVel.roll,this.rot.yaw+=this.rotVel.yaw,this.mesh.rotateX(this.rotVel.pitch),this.mesh.rotateZ(this.rotVel.roll),this.mesh.rotateY(this.rotVel.yaw)}updateCollisions(e,t,n){const s=new Fe().setFromObject(this.mesh);!this.destroyed&&n.checkTerrainCollision(s)&&this.performCollision(e,t),this._updateShards(e)}performCollision(e,t){if(this.destroyed)return;const n=he(1,.5,1),s=he(0,100,0),o=go.subdivideByImpact(this.collider,n,s,1,5),a=()=>Math.random()*.1,l=()=>Math.random()*.5;this.clearShards();for(let d of o){const p=d;this.collider.updateWorldMatrix(!0,!1),p.position.set(...Rs(this.collider.localToWorld(this.collider.position.clone()))),e.add(p),p.cDir=he(a(),a(),a()),p.cVel=he(l(),l(),l()),p.gVel=.01,p.time=0,this.addShard(p)}this.shards.length>0&&(this.shards[0].cVel.y=.3),e.remove(this.mesh),Ai(this.mesh),this.setDestroyed(!0),this.shards.length>0&&(t.position.set(0,0,0),this.shards[0].add(t)),setTimeout(()=>{document.getElementById("blackout").classList.remove("left"),document.getElementById("blackout").classList.remove("right"),setTimeout(()=>window.location.replace("/flight_ended.html"),1500)},3e3)}_updateShards(e){for(let t=this.shards.length-1;t>=0;t--){const n=this.shards[t];n.rotateX(n.cDir.x),n.rotateY(n.cDir.y),n.rotateZ(n.cDir.z),n.cDir.multiplyScalar(.99),n.gVel-=.001,n.position.add(he(n.cVel.x,n.cVel.y+n.gVel,n.cVel.z)),n.time++,n.time>500&&(e.remove(n),this.shards.splice(t,1))}}getPosition(){return this.mesh.position.clone()}getRotation(){return this.mesh.rotation.clone()}setPosition(e){this.mesh.position.copy(e)}setRotation(e){this.mesh.rotation.copy(e)}addShard(e){this.shards.push(e)}clearShards(){this.shards=[]}}class bf{constructor(e,t,n){Y(this,"client");Y(this,"room",null);Y(this,"remotePlayers",new Map);Y(this,"assetManager");Y(this,"soundManager");Y(this,"scene");Y(this,"handlePlayerAdd",(e,t)=>{var s;if(t===((s=this.room)==null?void 0:s.sessionId))return;const n=new Ma(this.assetManager,this.soundManager);n.setPosition(he(e.x,e.y,e.z)),n.mesh.rotation.set(e.rotX,e.rotY,e.rotZ),n.flying=!0,this.scene.add(n.mesh),this.remotePlayers.set(t,n)});Y(this,"handlePlayerChange",(e,t)=>{var s;if(t===((s=this.room)==null?void 0:s.sessionId))return;const n=this.remotePlayers.get(t);n&&(n.setPosition(he(e.x,e.y,e.z)),n.mesh.rotation.set(e.rotX,e.rotY,e.rotZ))});Y(this,"handlePlayerRemove",(e,t)=>{const n=this.remotePlayers.get(t);n&&(this.remotePlayers.delete(t),this.scene.remove(n.mesh),Ai(n.mesh))});this.client=new lo.Client("ws://localhost:2567"),this.assetManager=e,this.soundManager=t,this.scene=n}async joinOrCreateRoom(e){try{this.room=await this.client.joinOrCreate(e),this.room.name,this.room.sessionId;const t=lo.getStateCallbacks(this.room);return t(this.room.state).players.onAdd(this.handlePlayerAdd),t(this.room.state).players.onChange(this.handlePlayerChange),t(this.room.state).players.onRemove(this.handlePlayerRemove),this.room.onLeave(n=>{}),this.room.onError((n,s)=>{console.error("Room error:",n,s)}),this.room}catch(t){return console.error("Error joining room:",t),null}}sendPlayerUpdate(e){this.room&&this.room.send("updatePlayer",e)}}class Ef{constructor(e){Y(this,"listener");Y(this,"audioLoader");Y(this,"sounds");Y(this,"positionalSounds");Y(this,"ENABLED",!0);this.listener=new bc,this.ENABLED||this.listener.setMasterVolume(0),e.add(this.listener),this.audioLoader=new Ec,this.sounds=new Map,this.positionalSounds=new Map}async loadAllSounds(){await Promise.all([this.loadSound("plane-flying","sounds/plane-flying.mp3"),this.loadSound("plane-shooting","sounds/plane-shooting.mp3"),this.loadSound("plane-exploding","sounds/plane-exploding.mp3")])}async loadSound(e,t){return new Promise((n,s)=>{this.audioLoader.load(t,o=>{this.sounds.set(e,o),n()},void 0,o=>{console.error(`Error loading sound ${e}:`,o),s(o)})})}createPositionalSound(e){const t=this.sounds.get(e);if(t){const n=new hr(this.listener);return n.setBuffer(t),this.positionalSounds.set(e,n),n}console.warn(`Audio buffer not found for sound: ${e}`)}updatePlaneSound(e,t){const n="plane-flying";let s=this.positionalSounds.get(n);s||(s=this.createPositionalSound(n),s&&(t.add(s),s.setVolume(2),s.setLoop(!0),s.play()));const l=1+e*.7;s==null||s.setPlaybackRate(l)}playShootingSound(e){const t="plane-shooting",n=this.sounds.get(t);if(n){const s=new hr(this.listener);s.setBuffer(n),s.setVolume(3),e.add(s),s.play()}else console.warn(`Audio buffer not found for sound: ${t}`)}playExplosionSound(){const e="plane-exploding",t=this.sounds.get(e);if(t){const n=new Ac(this.listener);n.setBuffer(t),n.play()}else console.warn(`Audio buffer not found for sound: ${e}`)}}const Ca=0,Af=1,Tf=2,yo=2,Ks=1.25,wo=1,Sn=6*4+4+4,Es=65535,Sf=Math.pow(2,-24),Ys=Symbol("SKIP_GENERATION");function vf(i){return i.index?i.index.count:i.attributes.position.count}function sn(i){return vf(i)/3}function Pf(i,e=ArrayBuffer){return i>65535?new Uint32Array(new e(4*i)):new Uint16Array(new e(2*i))}function If(i,e){if(!i.index){const t=i.attributes.position.count,n=e.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer,s=Pf(t,n);i.setIndex(new Mo(s,1));for(let o=0;o<t;o++)s[o]=o}}function Ra(i,e){const t=sn(i),n=e||i.drawRange,s=n.start/3,o=(n.start+n.count)/3,a=Math.max(0,s),l=Math.min(t,o)-a;return[{offset:Math.floor(a),count:Math.floor(l)}]}function Da(i,e){if(!i.groups||!i.groups.length)return Ra(i,e);const t=[],n=new Set,s=e||i.drawRange,o=s.start/3,a=(s.start+s.count)/3;for(const d of i.groups){const p=d.start/3,m=(d.start+d.count)/3;n.add(Math.max(o,p)),n.add(Math.min(a,m))}const l=Array.from(n.values()).sort((d,p)=>d-p);for(let d=0;d<l.length-1;d++){const p=l[d],m=l[d+1];t.push({offset:Math.floor(p),count:Math.floor(m-p)})}return t}function _f(i,e){const t=sn(i),n=Da(i,e).sort((a,l)=>a.offset-l.offset),s=n[n.length-1];s.count=Math.min(t-s.offset,s.count);let o=0;return n.forEach(({count:a})=>o+=a),t!==o}function Xs(i,e,t,n,s){let o=1/0,a=1/0,l=1/0,d=-1/0,p=-1/0,m=-1/0,f=1/0,h=1/0,g=1/0,E=-1/0,A=-1/0,b=-1/0;for(let S=e*6,P=(e+t)*6;S<P;S+=6){const M=i[S+0],C=i[S+1],B=M-C,$=M+C;B<o&&(o=B),$>d&&(d=$),M<f&&(f=M),M>E&&(E=M);const N=i[S+2],W=i[S+3],z=N-W,J=N+W;z<a&&(a=z),J>p&&(p=J),N<h&&(h=N),N>A&&(A=N);const ee=i[S+4],F=i[S+5],T=ee-F,L=ee+F;T<l&&(l=T),L>m&&(m=L),ee<g&&(g=ee),ee>b&&(b=ee)}n[0]=o,n[1]=a,n[2]=l,n[3]=d,n[4]=p,n[5]=m,s[0]=f,s[1]=h,s[2]=g,s[3]=E,s[4]=A,s[5]=b}function Of(i,e=null,t=null,n=null){const s=i.attributes.position,o=i.index?i.index.array:null,a=sn(i),l=s.normalized;let d;e===null?(d=new Float32Array(a*6),t=0,n=a):(d=e,t=t||0,n=n||a);const p=s.array,m=s.offset||0;let f=3;s.isInterleavedBufferAttribute&&(f=s.data.stride);const h=["getX","getY","getZ"];for(let g=t;g<t+n;g++){const E=g*3,A=g*6;let b=E+0,S=E+1,P=E+2;o&&(b=o[b],S=o[S],P=o[P]),l||(b=b*f+m,S=S*f+m,P=P*f+m);for(let M=0;M<3;M++){let C,B,$;l?(C=s[h[M]](b),B=s[h[M]](S),$=s[h[M]](P)):(C=p[b+M],B=p[S+M],$=p[P+M]);let N=C;B<N&&(N=B),$<N&&(N=$);let W=C;B>W&&(W=B),$>W&&(W=$);const z=(W-N)/2,J=M*2;d[A+J+0]=N+z,d[A+J+1]=z+(Math.abs(N)+z)*Sf}}return d}function ye(i,e,t){return t.min.x=e[i],t.min.y=e[i+1],t.min.z=e[i+2],t.max.x=e[i+3],t.max.y=e[i+4],t.max.z=e[i+5],t}function xo(i){let e=-1,t=-1/0;for(let n=0;n<3;n++){const s=i[n+3]-i[n];s>t&&(t=s,e=n)}return e}function bo(i,e){e.set(i)}function Eo(i,e,t){let n,s;for(let o=0;o<3;o++){const a=o+3;n=i[o],s=e[o],t[o]=n<s?n:s,n=i[a],s=e[a],t[a]=n>s?n:s}}function Wn(i,e,t){for(let n=0;n<3;n++){const s=e[i+2*n],o=e[i+2*n+1],a=s-o,l=s+o;a<t[n]&&(t[n]=a),l>t[n+3]&&(t[n+3]=l)}}function dn(i){const e=i[3]-i[0],t=i[4]-i[1],n=i[5]-i[2];return 2*(e*t+t*n+n*e)}const lt=32,Mf=(i,e)=>i.candidate-e.candidate,yt=new Array(lt).fill().map(()=>({count:0,bounds:new Float32Array(6),rightCacheBounds:new Float32Array(6),leftCacheBounds:new Float32Array(6),candidate:0})),Gn=new Float32Array(6);function Cf(i,e,t,n,s,o){let a=-1,l=0;if(o===Ca)a=xo(e),a!==-1&&(l=(e[a]+e[a+3])/2);else if(o===Af)a=xo(i),a!==-1&&(l=Rf(t,n,s,a));else if(o===Tf){const d=dn(i);let p=Ks*s;const m=n*6,f=(n+s)*6;for(let h=0;h<3;h++){const g=e[h],b=(e[h+3]-g)/lt;if(s<lt/4){const S=[...yt];S.length=s;let P=0;for(let C=m;C<f;C+=6,P++){const B=S[P];B.candidate=t[C+2*h],B.count=0;const{bounds:$,leftCacheBounds:N,rightCacheBounds:W}=B;for(let z=0;z<3;z++)W[z]=1/0,W[z+3]=-1/0,N[z]=1/0,N[z+3]=-1/0,$[z]=1/0,$[z+3]=-1/0;Wn(C,t,$)}S.sort(Mf);let M=s;for(let C=0;C<M;C++){const B=S[C];for(;C+1<M&&S[C+1].candidate===B.candidate;)S.splice(C+1,1),M--}for(let C=m;C<f;C+=6){const B=t[C+2*h];for(let $=0;$<M;$++){const N=S[$];B>=N.candidate?Wn(C,t,N.rightCacheBounds):(Wn(C,t,N.leftCacheBounds),N.count++)}}for(let C=0;C<M;C++){const B=S[C],$=B.count,N=s-B.count,W=B.leftCacheBounds,z=B.rightCacheBounds;let J=0;$!==0&&(J=dn(W)/d);let ee=0;N!==0&&(ee=dn(z)/d);const F=wo+Ks*(J*$+ee*N);F<p&&(a=h,p=F,l=B.candidate)}}else{for(let M=0;M<lt;M++){const C=yt[M];C.count=0,C.candidate=g+b+M*b;const B=C.bounds;for(let $=0;$<3;$++)B[$]=1/0,B[$+3]=-1/0}for(let M=m;M<f;M+=6){let $=~~((t[M+2*h]-g)/b);$>=lt&&($=lt-1);const N=yt[$];N.count++,Wn(M,t,N.bounds)}const S=yt[lt-1];bo(S.bounds,S.rightCacheBounds);for(let M=lt-2;M>=0;M--){const C=yt[M],B=yt[M+1];Eo(C.bounds,B.rightCacheBounds,C.rightCacheBounds)}let P=0;for(let M=0;M<lt-1;M++){const C=yt[M],B=C.count,$=C.bounds,W=yt[M+1].rightCacheBounds;B!==0&&(P===0?bo($,Gn):Eo($,Gn,Gn)),P+=B;let z=0,J=0;P!==0&&(z=dn(Gn)/d);const ee=s-P;ee!==0&&(J=dn(W)/d);const F=wo+Ks*(z*P+J*ee);F<p&&(a=h,p=F,l=C.candidate)}}}}else console.warn(`MeshBVH: Invalid build strategy value ${o} used.`);return{axis:a,pos:l}}function Rf(i,e,t,n){let s=0;for(let o=e,a=e+t;o<a;o++)s+=i[o*6+n*2];return s/t}class Zs{constructor(){this.boundingData=new Float32Array(6)}}function Df(i,e,t,n,s,o){let a=n,l=n+s-1;const d=o.pos,p=o.axis*2;for(;;){for(;a<=l&&t[a*6+p]<d;)a++;for(;a<=l&&t[l*6+p]>=d;)l--;if(a<l){for(let m=0;m<3;m++){let f=e[a*3+m];e[a*3+m]=e[l*3+m],e[l*3+m]=f}for(let m=0;m<6;m++){let f=t[a*6+m];t[a*6+m]=t[l*6+m],t[l*6+m]=f}a++,l--}else return a}}function Bf(i,e,t,n,s,o){let a=n,l=n+s-1;const d=o.pos,p=o.axis*2;for(;;){for(;a<=l&&t[a*6+p]<d;)a++;for(;a<=l&&t[l*6+p]>=d;)l--;if(a<l){let m=i[a];i[a]=i[l],i[l]=m;for(let f=0;f<6;f++){let h=t[a*6+f];t[a*6+f]=t[l*6+f],t[l*6+f]=h}a++,l--}else return a}}function De(i,e){return e[i+15]===65535}function ke(i,e){return e[i+6]}function Ue(i,e){return e[i+14]}function ze(i){return i+8}function He(i,e){return e[i+6]}function Ba(i,e){return e[i+7]}let $a,En,cs,La;const $f=Math.pow(2,32);function hi(i){return"count"in i?1:1+hi(i.left)+hi(i.right)}function Lf(i,e,t){return $a=new Float32Array(t),En=new Uint32Array(t),cs=new Uint16Array(t),La=new Uint8Array(t),di(i,e)}function di(i,e){const t=i/4,n=i/2,s="count"in e,o=e.boundingData;for(let a=0;a<6;a++)$a[t+a]=o[a];if(s)if(e.buffer){const a=e.buffer;La.set(new Uint8Array(a),i);for(let l=i,d=i+a.byteLength;l<d;l+=Sn){const p=l/2;De(p,cs)||(En[l/4+6]+=t)}return i+a.byteLength}else{const a=e.offset,l=e.count;return En[t+6]=a,cs[n+14]=l,cs[n+15]=Es,i+Sn}else{const a=e.left,l=e.right,d=e.splitAxis;let p;if(p=di(i+Sn,a),p/4>$f)throw new Error("MeshBVH: Cannot store child pointer greater than 32 bits.");return En[t+6]=p/4,p=di(p,l),En[t+7]=d,p}}function Nf(i,e){const t=(i.index?i.index.count:i.attributes.position.count)/3,n=t>2**16,s=n?4:2,o=e?new SharedArrayBuffer(t*s):new ArrayBuffer(t*s),a=n?new Uint32Array(o):new Uint16Array(o);for(let l=0,d=a.length;l<d;l++)a[l]=l;return a}function kf(i,e,t,n,s){const{maxDepth:o,verbose:a,maxLeafTris:l,strategy:d,onProgress:p,indirect:m}=s,f=i._indirectBuffer,h=i.geometry,g=h.index?h.index.array:null,E=m?Bf:Df,A=sn(h),b=new Float32Array(6);let S=!1;const P=new Zs;return Xs(e,t,n,P.boundingData,b),C(P,t,n,b),P;function M(B){p&&p(B/A)}function C(B,$,N,W=null,z=0){if(!S&&z>=o&&(S=!0,a&&(console.warn(`MeshBVH: Max depth of ${o} reached when generating BVH. Consider increasing maxDepth.`),console.warn(h))),N<=l||z>=o)return M($+N),B.offset=$,B.count=N,B;const J=Cf(B.boundingData,W,e,$,N,d);if(J.axis===-1)return M($+N),B.offset=$,B.count=N,B;const ee=E(f,g,e,$,N,J);if(ee===$||ee===$+N)M($+N),B.offset=$,B.count=N;else{B.splitAxis=J.axis;const F=new Zs,T=$,L=ee-$;B.left=F,Xs(e,T,L,F.boundingData,b),C(F,T,L,b,z+1);const j=new Zs,k=ee,U=N-L;B.right=j,Xs(e,k,U,j.boundingData,b),C(j,k,U,b,z+1)}return B}}function Ff(i,e){const t=i.geometry;e.indirect&&(i._indirectBuffer=Nf(t,e.useSharedArrayBuffer),_f(t,e.range)&&!e.verbose&&console.warn('MeshBVH: Provided geometry contains groups or a range that do not fully span the vertex contents while using the "indirect" option. BVH may incorrectly report intersections on unrendered portions of the geometry.')),i._indirectBuffer||If(t,e);const n=e.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer,s=Of(t),o=e.indirect?Ra(t,e.range):Da(t,e.range);i._roots=o.map(a=>{const l=kf(i,s,a.offset,a.count,e),d=hi(l),p=new n(Sn*d);return Lf(0,l,p),p})}class ht{constructor(){this.min=1/0,this.max=-1/0}setFromPointsField(e,t){let n=1/0,s=-1/0;for(let o=0,a=e.length;o<a;o++){const d=e[o][t];n=d<n?d:n,s=d>s?d:s}this.min=n,this.max=s}setFromPoints(e,t){let n=1/0,s=-1/0;for(let o=0,a=t.length;o<a;o++){const l=t[o],d=e.dot(l);n=d<n?d:n,s=d>s?d:s}this.min=n,this.max=s}isSeparated(e){return this.min>e.max||e.min>this.max}}ht.prototype.setFromBox=function(){const i=new X;return function(t,n){const s=n.min,o=n.max;let a=1/0,l=-1/0;for(let d=0;d<=1;d++)for(let p=0;p<=1;p++)for(let m=0;m<=1;m++){i.x=s.x*d+o.x*(1-d),i.y=s.y*p+o.y*(1-p),i.z=s.z*m+o.z*(1-m);const f=t.dot(i);a=Math.min(f,a),l=Math.max(f,l)}this.min=a,this.max=l}}();const jf=function(){const i=new X,e=new X,t=new X;return function(s,o,a){const l=s.start,d=i,p=o.start,m=e;t.subVectors(l,p),i.subVectors(s.end,s.start),e.subVectors(o.end,o.start);const f=t.dot(m),h=m.dot(d),g=m.dot(m),E=t.dot(d),b=d.dot(d)*g-h*h;let S,P;b!==0?S=(f*h-E*g)/b:S=0,P=(f+S*h)/g,a.x=S,a.y=P}}(),Mi=function(){const i=new St,e=new X,t=new X;return function(s,o,a,l){jf(s,o,i);let d=i.x,p=i.y;if(d>=0&&d<=1&&p>=0&&p<=1){s.at(d,a),o.at(p,l);return}else if(d>=0&&d<=1){p<0?o.at(0,l):o.at(1,l),s.closestPointToPoint(l,!0,a);return}else if(p>=0&&p<=1){d<0?s.at(0,a):s.at(1,a),o.closestPointToPoint(a,!0,l);return}else{let m;d<0?m=s.start:m=s.end;let f;p<0?f=o.start:f=o.end;const h=e,g=t;if(s.closestPointToPoint(f,!0,e),o.closestPointToPoint(m,!0,t),h.distanceToSquared(f)<=g.distanceToSquared(m)){a.copy(h),l.copy(f);return}else{a.copy(m),l.copy(g);return}}}}(),Vf=function(){const i=new X,e=new X,t=new en,n=new Qe;return function(o,a){const{radius:l,center:d}=o,{a:p,b:m,c:f}=a;if(n.start=p,n.end=m,n.closestPointToPoint(d,!0,i).distanceTo(d)<=l||(n.start=p,n.end=f,n.closestPointToPoint(d,!0,i).distanceTo(d)<=l)||(n.start=m,n.end=f,n.closestPointToPoint(d,!0,i).distanceTo(d)<=l))return!0;const A=a.getPlane(t);if(Math.abs(A.distanceToPoint(d))<=l){const S=A.projectPoint(d,e);if(a.containsPoint(S))return!0}return!1}}(),Uf=1e-15;function Qs(i){return Math.abs(i)<Uf}class tt extends $t{constructor(...e){super(...e),this.isExtendedTriangle=!0,this.satAxes=new Array(4).fill().map(()=>new X),this.satBounds=new Array(4).fill().map(()=>new ht),this.points=[this.a,this.b,this.c],this.sphere=new Tc,this.plane=new en,this.needsUpdate=!0}intersectsSphere(e){return Vf(e,this)}update(){const e=this.a,t=this.b,n=this.c,s=this.points,o=this.satAxes,a=this.satBounds,l=o[0],d=a[0];this.getNormal(l),d.setFromPoints(l,s);const p=o[1],m=a[1];p.subVectors(e,t),m.setFromPoints(p,s);const f=o[2],h=a[2];f.subVectors(t,n),h.setFromPoints(f,s);const g=o[3],E=a[3];g.subVectors(n,e),E.setFromPoints(g,s),this.sphere.setFromPoints(this.points),this.plane.setFromNormalAndCoplanarPoint(l,e),this.needsUpdate=!1}}tt.prototype.closestPointToSegment=function(){const i=new X,e=new X,t=new Qe;return function(s,o=null,a=null){const{start:l,end:d}=s,p=this.points;let m,f=1/0;for(let h=0;h<3;h++){const g=(h+1)%3;t.start.copy(p[h]),t.end.copy(p[g]),Mi(t,s,i,e),m=i.distanceToSquared(e),m<f&&(f=m,o&&o.copy(i),a&&a.copy(e))}return this.closestPointToPoint(l,i),m=l.distanceToSquared(i),m<f&&(f=m,o&&o.copy(i),a&&a.copy(l)),this.closestPointToPoint(d,i),m=d.distanceToSquared(i),m<f&&(f=m,o&&o.copy(i),a&&a.copy(d)),Math.sqrt(f)}}();tt.prototype.intersectsTriangle=function(){const i=new tt,e=new Array(3),t=new Array(3),n=new ht,s=new ht,o=new X,a=new X,l=new X,d=new X,p=new X,m=new Qe,f=new Qe,h=new Qe,g=new X;function E(A,b,S){const P=A.points;let M=0,C=-1;for(let B=0;B<3;B++){const{start:$,end:N}=m;$.copy(P[B]),N.copy(P[(B+1)%3]),m.delta(a);const W=Qs(b.distanceToPoint($));if(Qs(b.normal.dot(a))&&W){S.copy(m),M=2;break}const z=b.intersectLine(m,g);if(!z&&W&&g.copy($),(z||W)&&!Qs(g.distanceTo(N))){if(M<=1)(M===1?S.start:S.end).copy(g),W&&(C=M);else if(M>=2){(C===1?S.start:S.end).copy(g),M=2;break}if(M++,M===2&&C===-1)break}}return M}return function(b,S=null,P=!1){this.needsUpdate&&this.update(),b.isExtendedTriangle?b.needsUpdate&&b.update():(i.copy(b),i.update(),b=i);const M=this.plane,C=b.plane;if(Math.abs(M.normal.dot(C.normal))>1-1e-10){const B=this.satBounds,$=this.satAxes;t[0]=b.a,t[1]=b.b,t[2]=b.c;for(let z=0;z<4;z++){const J=B[z],ee=$[z];if(n.setFromPoints(ee,t),J.isSeparated(n))return!1}const N=b.satBounds,W=b.satAxes;e[0]=this.a,e[1]=this.b,e[2]=this.c;for(let z=0;z<4;z++){const J=N[z],ee=W[z];if(n.setFromPoints(ee,e),J.isSeparated(n))return!1}for(let z=0;z<4;z++){const J=$[z];for(let ee=0;ee<4;ee++){const F=W[ee];if(o.crossVectors(J,F),n.setFromPoints(o,e),s.setFromPoints(o,t),n.isSeparated(s))return!1}}return S&&(P||console.warn("ExtendedTriangle.intersectsTriangle: Triangles are coplanar which does not support an output edge. Setting edge to 0, 0, 0."),S.start.set(0,0,0),S.end.set(0,0,0)),!0}else{const B=E(this,C,f);if(B===1&&b.containsPoint(f.end))return S&&(S.start.copy(f.end),S.end.copy(f.end)),!0;if(B!==2)return!1;const $=E(b,M,h);if($===1&&this.containsPoint(h.end))return S&&(S.start.copy(h.end),S.end.copy(h.end)),!0;if($!==2)return!1;if(f.delta(l),h.delta(d),l.dot(d)<0){let T=h.start;h.start=h.end,h.end=T}const N=f.start.dot(l),W=f.end.dot(l),z=h.start.dot(l),J=h.end.dot(l),ee=W<z,F=N<J;return N!==J&&z!==W&&ee===F?!1:(S&&(p.subVectors(f.start,h.start),p.dot(l)>0?S.start.copy(f.start):S.start.copy(h.start),p.subVectors(f.end,h.end),p.dot(l)<0?S.end.copy(f.end):S.end.copy(h.end)),!0)}}}();tt.prototype.distanceToPoint=function(){const i=new X;return function(t){return this.closestPointToPoint(t,i),t.distanceTo(i)}}();tt.prototype.distanceToTriangle=function(){const i=new X,e=new X,t=["a","b","c"],n=new Qe,s=new Qe;return function(a,l=null,d=null){const p=l||d?n:null;if(this.intersectsTriangle(a,p))return(l||d)&&(l&&p.getCenter(l),d&&p.getCenter(d)),0;let m=1/0;for(let f=0;f<3;f++){let h;const g=t[f],E=a[g];this.closestPointToPoint(E,i),h=E.distanceToSquared(i),h<m&&(m=h,l&&l.copy(i),d&&d.copy(E));const A=this[g];a.closestPointToPoint(A,i),h=A.distanceToSquared(i),h<m&&(m=h,l&&l.copy(A),d&&d.copy(i))}for(let f=0;f<3;f++){const h=t[f],g=t[(f+1)%3];n.set(this[h],this[g]);for(let E=0;E<3;E++){const A=t[E],b=t[(E+1)%3];s.set(a[A],a[b]),Mi(n,s,i,e);const S=i.distanceToSquared(e);S<m&&(m=S,l&&l.copy(i),d&&d.copy(e))}}return Math.sqrt(m)}}();class Re{constructor(e,t,n){this.isOrientedBox=!0,this.min=new X,this.max=new X,this.matrix=new ut,this.invMatrix=new ut,this.points=new Array(8).fill().map(()=>new X),this.satAxes=new Array(3).fill().map(()=>new X),this.satBounds=new Array(3).fill().map(()=>new ht),this.alignedSatBounds=new Array(3).fill().map(()=>new ht),this.needsUpdate=!1,e&&this.min.copy(e),t&&this.max.copy(t),n&&this.matrix.copy(n)}set(e,t,n){this.min.copy(e),this.max.copy(t),this.matrix.copy(n),this.needsUpdate=!0}copy(e){this.min.copy(e.min),this.max.copy(e.max),this.matrix.copy(e.matrix),this.needsUpdate=!0}}Re.prototype.update=function(){return function(){const e=this.matrix,t=this.min,n=this.max,s=this.points;for(let p=0;p<=1;p++)for(let m=0;m<=1;m++)for(let f=0;f<=1;f++){const h=1*p|2*m|4*f,g=s[h];g.x=p?n.x:t.x,g.y=m?n.y:t.y,g.z=f?n.z:t.z,g.applyMatrix4(e)}const o=this.satBounds,a=this.satAxes,l=s[0];for(let p=0;p<3;p++){const m=a[p],f=o[p],h=1<<p,g=s[h];m.subVectors(l,g),f.setFromPoints(m,s)}const d=this.alignedSatBounds;d[0].setFromPointsField(s,"x"),d[1].setFromPointsField(s,"y"),d[2].setFromPointsField(s,"z"),this.invMatrix.copy(this.matrix).invert(),this.needsUpdate=!1}}();Re.prototype.intersectsBox=function(){const i=new ht;return function(t){this.needsUpdate&&this.update();const n=t.min,s=t.max,o=this.satBounds,a=this.satAxes,l=this.alignedSatBounds;if(i.min=n.x,i.max=s.x,l[0].isSeparated(i)||(i.min=n.y,i.max=s.y,l[1].isSeparated(i))||(i.min=n.z,i.max=s.z,l[2].isSeparated(i)))return!1;for(let d=0;d<3;d++){const p=a[d],m=o[d];if(i.setFromBox(p,t),m.isSeparated(i))return!1}return!0}}();Re.prototype.intersectsTriangle=function(){const i=new tt,e=new Array(3),t=new ht,n=new ht,s=new X;return function(a){this.needsUpdate&&this.update(),a.isExtendedTriangle?a.needsUpdate&&a.update():(i.copy(a),i.update(),a=i);const l=this.satBounds,d=this.satAxes;e[0]=a.a,e[1]=a.b,e[2]=a.c;for(let h=0;h<3;h++){const g=l[h],E=d[h];if(t.setFromPoints(E,e),g.isSeparated(t))return!1}const p=a.satBounds,m=a.satAxes,f=this.points;for(let h=0;h<3;h++){const g=p[h],E=m[h];if(t.setFromPoints(E,f),g.isSeparated(t))return!1}for(let h=0;h<3;h++){const g=d[h];for(let E=0;E<4;E++){const A=m[E];if(s.crossVectors(g,A),t.setFromPoints(s,e),n.setFromPoints(s,f),t.isSeparated(n))return!1}}return!0}}();Re.prototype.closestPointToPoint=function(){return function(e,t){return this.needsUpdate&&this.update(),t.copy(e).applyMatrix4(this.invMatrix).clamp(this.min,this.max).applyMatrix4(this.matrix),t}}();Re.prototype.distanceToPoint=function(){const i=new X;return function(t){return this.closestPointToPoint(t,i),t.distanceTo(i)}}();Re.prototype.distanceToBox=function(){const i=["x","y","z"],e=new Array(12).fill().map(()=>new Qe),t=new Array(12).fill().map(()=>new Qe),n=new X,s=new X;return function(a,l=0,d=null,p=null){if(this.needsUpdate&&this.update(),this.intersectsBox(a))return(d||p)&&(a.getCenter(s),this.closestPointToPoint(s,n),a.closestPointToPoint(n,s),d&&d.copy(n),p&&p.copy(s)),0;const m=l*l,f=a.min,h=a.max,g=this.points;let E=1/0;for(let b=0;b<8;b++){const S=g[b];s.copy(S).clamp(f,h);const P=S.distanceToSquared(s);if(P<E&&(E=P,d&&d.copy(S),p&&p.copy(s),P<m))return Math.sqrt(P)}let A=0;for(let b=0;b<3;b++)for(let S=0;S<=1;S++)for(let P=0;P<=1;P++){const M=(b+1)%3,C=(b+2)%3,B=S<<M|P<<C,$=1<<b|S<<M|P<<C,N=g[B],W=g[$];e[A].set(N,W);const J=i[b],ee=i[M],F=i[C],T=t[A],L=T.start,j=T.end;L[J]=f[J],L[ee]=S?f[ee]:h[ee],L[F]=P?f[F]:h[ee],j[J]=h[J],j[ee]=S?f[ee]:h[ee],j[F]=P?f[F]:h[ee],A++}for(let b=0;b<=1;b++)for(let S=0;S<=1;S++)for(let P=0;P<=1;P++){s.x=b?h.x:f.x,s.y=S?h.y:f.y,s.z=P?h.z:f.z,this.closestPointToPoint(s,n);const M=s.distanceToSquared(n);if(M<E&&(E=M,d&&d.copy(n),p&&p.copy(s),M<m))return Math.sqrt(M)}for(let b=0;b<12;b++){const S=e[b];for(let P=0;P<12;P++){const M=t[P];Mi(S,M,n,s);const C=n.distanceToSquared(s);if(C<E&&(E=C,d&&d.copy(n),p&&p.copy(s),C<m))return Math.sqrt(C)}}return Math.sqrt(E)}}();class Ci{constructor(e){this._getNewPrimitive=e,this._primitives=[]}getPrimitive(){const e=this._primitives;return e.length===0?this._getNewPrimitive():e.pop()}releasePrimitive(e){this._primitives.push(e)}}class zf extends Ci{constructor(){super(()=>new tt)}}const qe=new zf;class Hf{constructor(){this.float32Array=null,this.uint16Array=null,this.uint32Array=null;const e=[];let t=null;this.setBuffer=n=>{t&&e.push(t),t=n,this.float32Array=new Float32Array(n),this.uint16Array=new Uint16Array(n),this.uint32Array=new Uint32Array(n)},this.clearBuffer=()=>{t=null,this.float32Array=null,this.uint16Array=null,this.uint32Array=null,e.length!==0&&this.setBuffer(e.pop())}}}const me=new Hf;let At,Zt;const Ht=[],Jn=new Ci(()=>new Fe);function qf(i,e,t,n,s,o){At=Jn.getPrimitive(),Zt=Jn.getPrimitive(),Ht.push(At,Zt),me.setBuffer(i._roots[e]);const a=pi(0,i.geometry,t,n,s,o);me.clearBuffer(),Jn.releasePrimitive(At),Jn.releasePrimitive(Zt),Ht.pop(),Ht.pop();const l=Ht.length;return l>0&&(Zt=Ht[l-1],At=Ht[l-2]),a}function pi(i,e,t,n,s=null,o=0,a=0){const{float32Array:l,uint16Array:d,uint32Array:p}=me;let m=i*2;if(De(m,d)){const h=ke(i,p),g=Ue(m,d);return ye(i,l,At),n(h,g,!1,a,o+i,At)}else{let J=function(F){const{uint16Array:T,uint32Array:L}=me;let j=F*2;for(;!De(j,T);)F=ze(F),j=F*2;return ke(F,L)},ee=function(F){const{uint16Array:T,uint32Array:L}=me;let j=F*2;for(;!De(j,T);)F=He(F,L),j=F*2;return ke(F,L)+Ue(j,T)};const h=ze(i),g=He(i,p);let E=h,A=g,b,S,P,M;if(s&&(P=At,M=Zt,ye(E,l,P),ye(A,l,M),b=s(P),S=s(M),S<b)){E=g,A=h;const F=b;b=S,S=F,P=M}P||(P=At,ye(E,l,P));const C=De(E*2,d),B=t(P,C,b,a+1,o+E);let $;if(B===yo){const F=J(E),L=ee(E)-F;$=n(F,L,!0,a+1,o+E,P)}else $=B&&pi(E,e,t,n,s,o,a+1);if($)return!0;M=Zt,ye(A,l,M);const N=De(A*2,d),W=t(M,N,S,a+1,o+A);let z;if(W===yo){const F=J(A),L=ee(A)-F;z=n(F,L,!0,a+1,o+A,M)}else z=W&&pi(A,e,t,n,s,o,a+1);return!!z}}const pn=new X,ei=new X;function Wf(i,e,t={},n=0,s=1/0){const o=n*n,a=s*s;let l=1/0,d=null;if(i.shapecast({boundsTraverseOrder:m=>(pn.copy(e).clamp(m.min,m.max),pn.distanceToSquared(e)),intersectsBounds:(m,f,h)=>h<l&&h<a,intersectsTriangle:(m,f)=>{m.closestPointToPoint(e,pn);const h=e.distanceToSquared(pn);return h<l&&(ei.copy(pn),l=h,d=f),h<o}}),l===1/0)return null;const p=Math.sqrt(l);return t.point?t.point.copy(ei):t.point=ei.clone(),t.distance=p,t.faceIndex=d,t}const Gf=parseInt(vc)>=169,Mt=new X,Ct=new X,Rt=new X,Kn=new St,Yn=new St,Xn=new St,Ao=new X,To=new X,So=new X,mn=new X;function Jf(i,e,t,n,s,o,a,l){let d;if(o===Sc?d=i.intersectTriangle(n,t,e,!0,s):d=i.intersectTriangle(e,t,n,o!==Xt,s),d===null)return null;const p=i.origin.distanceTo(s);return p<a||p>l?null:{distance:p,point:s.clone()}}function Kf(i,e,t,n,s,o,a,l,d,p,m){Mt.fromBufferAttribute(e,o),Ct.fromBufferAttribute(e,a),Rt.fromBufferAttribute(e,l);const f=Jf(i,Mt,Ct,Rt,mn,d,p,m);if(f){const h=new X;$t.getBarycoord(mn,Mt,Ct,Rt,h),n&&(Kn.fromBufferAttribute(n,o),Yn.fromBufferAttribute(n,a),Xn.fromBufferAttribute(n,l),f.uv=$t.getInterpolation(mn,Mt,Ct,Rt,Kn,Yn,Xn,new St)),s&&(Kn.fromBufferAttribute(s,o),Yn.fromBufferAttribute(s,a),Xn.fromBufferAttribute(s,l),f.uv1=$t.getInterpolation(mn,Mt,Ct,Rt,Kn,Yn,Xn,new St)),t&&(Ao.fromBufferAttribute(t,o),To.fromBufferAttribute(t,a),So.fromBufferAttribute(t,l),f.normal=$t.getInterpolation(mn,Mt,Ct,Rt,Ao,To,So,new X),f.normal.dot(i.direction)>0&&f.normal.multiplyScalar(-1));const g={a:o,b:a,c:l,normal:new X,materialIndex:0};$t.getNormal(Mt,Ct,Rt,g.normal),f.face=g,f.faceIndex=o,Gf&&(f.barycoord=h)}return f}function As(i,e,t,n,s,o,a){const l=n*3;let d=l+0,p=l+1,m=l+2;const f=i.index;i.index&&(d=f.getX(d),p=f.getX(p),m=f.getX(m));const{position:h,normal:g,uv:E,uv1:A}=i.attributes,b=Kf(t,h,g,E,A,d,p,m,e,o,a);return b?(b.faceIndex=n,s&&s.push(b),b):null}function Ee(i,e,t,n){const s=i.a,o=i.b,a=i.c;let l=e,d=e+1,p=e+2;t&&(l=t.getX(l),d=t.getX(d),p=t.getX(p)),s.x=n.getX(l),s.y=n.getY(l),s.z=n.getZ(l),o.x=n.getX(d),o.y=n.getY(d),o.z=n.getZ(d),a.x=n.getX(p),a.y=n.getY(p),a.z=n.getZ(p)}function Yf(i,e,t,n,s,o,a,l){const{geometry:d,_indirectBuffer:p}=i;for(let m=n,f=n+s;m<f;m++)As(d,e,t,m,o,a,l)}function Xf(i,e,t,n,s,o,a){const{geometry:l,_indirectBuffer:d}=i;let p=1/0,m=null;for(let f=n,h=n+s;f<h;f++){let g;g=As(l,e,t,f,null,o,a),g&&g.distance<p&&(m=g,p=g.distance)}return m}function Zf(i,e,t,n,s,o,a){const{geometry:l}=t,{index:d}=l,p=l.attributes.position;for(let m=i,f=e+i;m<f;m++){let h;if(h=m,Ee(a,h*3,d,p),a.needsUpdate=!0,n(a,h,s,o))return!0}return!1}function Qf(i,e=null){e&&Array.isArray(e)&&(e=new Set(e));const t=i.geometry,n=t.index?t.index.array:null,s=t.attributes.position;let o,a,l,d,p=0;const m=i._roots;for(let h=0,g=m.length;h<g;h++)o=m[h],a=new Uint32Array(o),l=new Uint16Array(o),d=new Float32Array(o),f(0,p),p+=o.byteLength;function f(h,g,E=!1){const A=h*2;if(l[A+15]===Es){const S=a[h+6],P=l[A+14];let M=1/0,C=1/0,B=1/0,$=-1/0,N=-1/0,W=-1/0;for(let z=3*S,J=3*(S+P);z<J;z++){let ee=n[z];const F=s.getX(ee),T=s.getY(ee),L=s.getZ(ee);F<M&&(M=F),F>$&&($=F),T<C&&(C=T),T>N&&(N=T),L<B&&(B=L),L>W&&(W=L)}return d[h+0]!==M||d[h+1]!==C||d[h+2]!==B||d[h+3]!==$||d[h+4]!==N||d[h+5]!==W?(d[h+0]=M,d[h+1]=C,d[h+2]=B,d[h+3]=$,d[h+4]=N,d[h+5]=W,!0):!1}else{const S=h+8,P=a[h+6],M=S+g,C=P+g;let B=E,$=!1,N=!1;e?B||($=e.has(M),N=e.has(C),B=!$&&!N):($=!0,N=!0);const W=B||$,z=B||N;let J=!1;W&&(J=f(S,g,B));let ee=!1;z&&(ee=f(P,g,B));const F=J||ee;if(F)for(let T=0;T<3;T++){const L=S+T,j=P+T,k=d[L],U=d[L+3],te=d[j],oe=d[j+3];d[h+T]=k<te?k:te,d[h+T+3]=U>oe?U:oe}return F}}}function Pt(i,e,t,n,s){let o,a,l,d,p,m;const f=1/t.direction.x,h=1/t.direction.y,g=1/t.direction.z,E=t.origin.x,A=t.origin.y,b=t.origin.z;let S=e[i],P=e[i+3],M=e[i+1],C=e[i+3+1],B=e[i+2],$=e[i+3+2];return f>=0?(o=(S-E)*f,a=(P-E)*f):(o=(P-E)*f,a=(S-E)*f),h>=0?(l=(M-A)*h,d=(C-A)*h):(l=(C-A)*h,d=(M-A)*h),o>d||l>a||((l>o||isNaN(o))&&(o=l),(d<a||isNaN(a))&&(a=d),g>=0?(p=(B-b)*g,m=($-b)*g):(p=($-b)*g,m=(B-b)*g),o>m||p>a)?!1:((p>o||o!==o)&&(o=p),(m<a||a!==a)&&(a=m),o<=s&&a>=n)}function eu(i,e,t,n,s,o,a,l){const{geometry:d,_indirectBuffer:p}=i;for(let m=n,f=n+s;m<f;m++){let h=p?p[m]:m;As(d,e,t,h,o,a,l)}}function tu(i,e,t,n,s,o,a){const{geometry:l,_indirectBuffer:d}=i;let p=1/0,m=null;for(let f=n,h=n+s;f<h;f++){let g;g=As(l,e,t,d?d[f]:f,null,o,a),g&&g.distance<p&&(m=g,p=g.distance)}return m}function nu(i,e,t,n,s,o,a){const{geometry:l}=t,{index:d}=l,p=l.attributes.position;for(let m=i,f=e+i;m<f;m++){let h;if(h=t.resolveTriangleIndex(m),Ee(a,h*3,d,p),a.needsUpdate=!0,n(a,h,s,o))return!0}return!1}function su(i,e,t,n,s,o,a){me.setBuffer(i._roots[e]),mi(0,i,t,n,s,o,a),me.clearBuffer()}function mi(i,e,t,n,s,o,a){const{float32Array:l,uint16Array:d,uint32Array:p}=me,m=i*2;if(De(m,d)){const h=ke(i,p),g=Ue(m,d);Yf(e,t,n,h,g,s,o,a)}else{const h=ze(i);Pt(h,l,n,o,a)&&mi(h,e,t,n,s,o,a);const g=He(i,p);Pt(g,l,n,o,a)&&mi(g,e,t,n,s,o,a)}}const iu=["x","y","z"];function ru(i,e,t,n,s,o){me.setBuffer(i._roots[e]);const a=gi(0,i,t,n,s,o);return me.clearBuffer(),a}function gi(i,e,t,n,s,o){const{float32Array:a,uint16Array:l,uint32Array:d}=me;let p=i*2;if(De(p,l)){const f=ke(i,d),h=Ue(p,l);return Xf(e,t,n,f,h,s,o)}else{const f=Ba(i,d),h=iu[f],E=n.direction[h]>=0;let A,b;E?(A=ze(i),b=He(i,d)):(A=He(i,d),b=ze(i));const P=Pt(A,a,n,s,o)?gi(A,e,t,n,s,o):null;if(P){const B=P.point[h];if(E?B<=a[b+f]:B>=a[b+f+3])return P}const C=Pt(b,a,n,s,o)?gi(b,e,t,n,s,o):null;return P&&C?P.distance<=C.distance?P:C:P||C||null}}const Zn=new Fe,qt=new tt,Wt=new tt,gn=new ut,vo=new Re,Qn=new Re;function ou(i,e,t,n){me.setBuffer(i._roots[e]);const s=yi(0,i,t,n);return me.clearBuffer(),s}function yi(i,e,t,n,s=null){const{float32Array:o,uint16Array:a,uint32Array:l}=me;let d=i*2;if(s===null&&(t.boundingBox||t.computeBoundingBox(),vo.set(t.boundingBox.min,t.boundingBox.max,n),s=vo),De(d,a)){const m=e.geometry,f=m.index,h=m.attributes.position,g=t.index,E=t.attributes.position,A=ke(i,l),b=Ue(d,a);if(gn.copy(n).invert(),t.boundsTree)return ye(i,o,Qn),Qn.matrix.copy(gn),Qn.needsUpdate=!0,t.boundsTree.shapecast({intersectsBounds:P=>Qn.intersectsBox(P),intersectsTriangle:P=>{P.a.applyMatrix4(n),P.b.applyMatrix4(n),P.c.applyMatrix4(n),P.needsUpdate=!0;for(let M=A*3,C=(b+A)*3;M<C;M+=3)if(Ee(Wt,M,f,h),Wt.needsUpdate=!0,P.intersectsTriangle(Wt))return!0;return!1}});for(let S=A*3,P=(b+A)*3;S<P;S+=3){Ee(qt,S,f,h),qt.a.applyMatrix4(gn),qt.b.applyMatrix4(gn),qt.c.applyMatrix4(gn),qt.needsUpdate=!0;for(let M=0,C=g.count;M<C;M+=3)if(Ee(Wt,M,g,E),Wt.needsUpdate=!0,qt.intersectsTriangle(Wt))return!0}}else{const m=i+8,f=l[i+6];return ye(m,o,Zn),!!(s.intersectsBox(Zn)&&yi(m,e,t,n,s)||(ye(f,o,Zn),s.intersectsBox(Zn)&&yi(f,e,t,n,s)))}}const es=new ut,ti=new Re,yn=new Re,au=new X,cu=new X,lu=new X,fu=new X;function uu(i,e,t,n={},s={},o=0,a=1/0){e.boundingBox||e.computeBoundingBox(),ti.set(e.boundingBox.min,e.boundingBox.max,t),ti.needsUpdate=!0;const l=i.geometry,d=l.attributes.position,p=l.index,m=e.attributes.position,f=e.index,h=qe.getPrimitive(),g=qe.getPrimitive();let E=au,A=cu,b=null,S=null;s&&(b=lu,S=fu);let P=1/0,M=null,C=null;return es.copy(t).invert(),yn.matrix.copy(es),i.shapecast({boundsTraverseOrder:B=>ti.distanceToBox(B),intersectsBounds:(B,$,N)=>N<P&&N<a?($&&(yn.min.copy(B.min),yn.max.copy(B.max),yn.needsUpdate=!0),!0):!1,intersectsRange:(B,$)=>{if(e.boundsTree)return e.boundsTree.shapecast({boundsTraverseOrder:W=>yn.distanceToBox(W),intersectsBounds:(W,z,J)=>J<P&&J<a,intersectsRange:(W,z)=>{for(let J=W,ee=W+z;J<ee;J++){Ee(g,3*J,f,m),g.a.applyMatrix4(t),g.b.applyMatrix4(t),g.c.applyMatrix4(t),g.needsUpdate=!0;for(let F=B,T=B+$;F<T;F++){Ee(h,3*F,p,d),h.needsUpdate=!0;const L=h.distanceToTriangle(g,E,b);if(L<P&&(A.copy(E),S&&S.copy(b),P=L,M=F,C=J),L<o)return!0}}}});{const N=sn(e);for(let W=0,z=N;W<z;W++){Ee(g,3*W,f,m),g.a.applyMatrix4(t),g.b.applyMatrix4(t),g.c.applyMatrix4(t),g.needsUpdate=!0;for(let J=B,ee=B+$;J<ee;J++){Ee(h,3*J,p,d),h.needsUpdate=!0;const F=h.distanceToTriangle(g,E,b);if(F<P&&(A.copy(E),S&&S.copy(b),P=F,M=J,C=W),F<o)return!0}}}}}),qe.releasePrimitive(h),qe.releasePrimitive(g),P===1/0?null:(n.point?n.point.copy(A):n.point=A.clone(),n.distance=P,n.faceIndex=M,s&&(s.point?s.point.copy(S):s.point=S.clone(),s.point.applyMatrix4(es),A.applyMatrix4(es),s.distance=A.sub(s.point).length(),s.faceIndex=C),n)}function hu(i,e=null){e&&Array.isArray(e)&&(e=new Set(e));const t=i.geometry,n=t.index?t.index.array:null,s=t.attributes.position;let o,a,l,d,p=0;const m=i._roots;for(let h=0,g=m.length;h<g;h++)o=m[h],a=new Uint32Array(o),l=new Uint16Array(o),d=new Float32Array(o),f(0,p),p+=o.byteLength;function f(h,g,E=!1){const A=h*2;if(l[A+15]===Es){const S=a[h+6],P=l[A+14];let M=1/0,C=1/0,B=1/0,$=-1/0,N=-1/0,W=-1/0;for(let z=S,J=S+P;z<J;z++){const ee=3*i.resolveTriangleIndex(z);for(let F=0;F<3;F++){let T=ee+F;T=n?n[T]:T;const L=s.getX(T),j=s.getY(T),k=s.getZ(T);L<M&&(M=L),L>$&&($=L),j<C&&(C=j),j>N&&(N=j),k<B&&(B=k),k>W&&(W=k)}}return d[h+0]!==M||d[h+1]!==C||d[h+2]!==B||d[h+3]!==$||d[h+4]!==N||d[h+5]!==W?(d[h+0]=M,d[h+1]=C,d[h+2]=B,d[h+3]=$,d[h+4]=N,d[h+5]=W,!0):!1}else{const S=h+8,P=a[h+6],M=S+g,C=P+g;let B=E,$=!1,N=!1;e?B||($=e.has(M),N=e.has(C),B=!$&&!N):($=!0,N=!0);const W=B||$,z=B||N;let J=!1;W&&(J=f(S,g,B));let ee=!1;z&&(ee=f(P,g,B));const F=J||ee;if(F)for(let T=0;T<3;T++){const L=S+T,j=P+T,k=d[L],U=d[L+3],te=d[j],oe=d[j+3];d[h+T]=k<te?k:te,d[h+T+3]=U>oe?U:oe}return F}}}function du(i,e,t,n,s,o,a){me.setBuffer(i._roots[e]),wi(0,i,t,n,s,o,a),me.clearBuffer()}function wi(i,e,t,n,s,o,a){const{float32Array:l,uint16Array:d,uint32Array:p}=me,m=i*2;if(De(m,d)){const h=ke(i,p),g=Ue(m,d);eu(e,t,n,h,g,s,o,a)}else{const h=ze(i);Pt(h,l,n,o,a)&&wi(h,e,t,n,s,o,a);const g=He(i,p);Pt(g,l,n,o,a)&&wi(g,e,t,n,s,o,a)}}const pu=["x","y","z"];function mu(i,e,t,n,s,o){me.setBuffer(i._roots[e]);const a=xi(0,i,t,n,s,o);return me.clearBuffer(),a}function xi(i,e,t,n,s,o){const{float32Array:a,uint16Array:l,uint32Array:d}=me;let p=i*2;if(De(p,l)){const f=ke(i,d),h=Ue(p,l);return tu(e,t,n,f,h,s,o)}else{const f=Ba(i,d),h=pu[f],E=n.direction[h]>=0;let A,b;E?(A=ze(i),b=He(i,d)):(A=He(i,d),b=ze(i));const P=Pt(A,a,n,s,o)?xi(A,e,t,n,s,o):null;if(P){const B=P.point[h];if(E?B<=a[b+f]:B>=a[b+f+3])return P}const C=Pt(b,a,n,s,o)?xi(b,e,t,n,s,o):null;return P&&C?P.distance<=C.distance?P:C:P||C||null}}const ts=new Fe,Gt=new tt,Jt=new tt,wn=new ut,Po=new Re,ns=new Re;function gu(i,e,t,n){me.setBuffer(i._roots[e]);const s=bi(0,i,t,n);return me.clearBuffer(),s}function bi(i,e,t,n,s=null){const{float32Array:o,uint16Array:a,uint32Array:l}=me;let d=i*2;if(s===null&&(t.boundingBox||t.computeBoundingBox(),Po.set(t.boundingBox.min,t.boundingBox.max,n),s=Po),De(d,a)){const m=e.geometry,f=m.index,h=m.attributes.position,g=t.index,E=t.attributes.position,A=ke(i,l),b=Ue(d,a);if(wn.copy(n).invert(),t.boundsTree)return ye(i,o,ns),ns.matrix.copy(wn),ns.needsUpdate=!0,t.boundsTree.shapecast({intersectsBounds:P=>ns.intersectsBox(P),intersectsTriangle:P=>{P.a.applyMatrix4(n),P.b.applyMatrix4(n),P.c.applyMatrix4(n),P.needsUpdate=!0;for(let M=A,C=b+A;M<C;M++)if(Ee(Jt,3*e.resolveTriangleIndex(M),f,h),Jt.needsUpdate=!0,P.intersectsTriangle(Jt))return!0;return!1}});for(let S=A,P=b+A;S<P;S++){const M=e.resolveTriangleIndex(S);Ee(Gt,3*M,f,h),Gt.a.applyMatrix4(wn),Gt.b.applyMatrix4(wn),Gt.c.applyMatrix4(wn),Gt.needsUpdate=!0;for(let C=0,B=g.count;C<B;C+=3)if(Ee(Jt,C,g,E),Jt.needsUpdate=!0,Gt.intersectsTriangle(Jt))return!0}}else{const m=i+8,f=l[i+6];return ye(m,o,ts),!!(s.intersectsBox(ts)&&bi(m,e,t,n,s)||(ye(f,o,ts),s.intersectsBox(ts)&&bi(f,e,t,n,s)))}}const ss=new ut,ni=new Re,xn=new Re,yu=new X,wu=new X,xu=new X,bu=new X;function Eu(i,e,t,n={},s={},o=0,a=1/0){e.boundingBox||e.computeBoundingBox(),ni.set(e.boundingBox.min,e.boundingBox.max,t),ni.needsUpdate=!0;const l=i.geometry,d=l.attributes.position,p=l.index,m=e.attributes.position,f=e.index,h=qe.getPrimitive(),g=qe.getPrimitive();let E=yu,A=wu,b=null,S=null;s&&(b=xu,S=bu);let P=1/0,M=null,C=null;return ss.copy(t).invert(),xn.matrix.copy(ss),i.shapecast({boundsTraverseOrder:B=>ni.distanceToBox(B),intersectsBounds:(B,$,N)=>N<P&&N<a?($&&(xn.min.copy(B.min),xn.max.copy(B.max),xn.needsUpdate=!0),!0):!1,intersectsRange:(B,$)=>{if(e.boundsTree){const N=e.boundsTree;return N.shapecast({boundsTraverseOrder:W=>xn.distanceToBox(W),intersectsBounds:(W,z,J)=>J<P&&J<a,intersectsRange:(W,z)=>{for(let J=W,ee=W+z;J<ee;J++){const F=N.resolveTriangleIndex(J);Ee(g,3*F,f,m),g.a.applyMatrix4(t),g.b.applyMatrix4(t),g.c.applyMatrix4(t),g.needsUpdate=!0;for(let T=B,L=B+$;T<L;T++){const j=i.resolveTriangleIndex(T);Ee(h,3*j,p,d),h.needsUpdate=!0;const k=h.distanceToTriangle(g,E,b);if(k<P&&(A.copy(E),S&&S.copy(b),P=k,M=T,C=J),k<o)return!0}}}})}else{const N=sn(e);for(let W=0,z=N;W<z;W++){Ee(g,3*W,f,m),g.a.applyMatrix4(t),g.b.applyMatrix4(t),g.c.applyMatrix4(t),g.needsUpdate=!0;for(let J=B,ee=B+$;J<ee;J++){const F=i.resolveTriangleIndex(J);Ee(h,3*F,p,d),h.needsUpdate=!0;const T=h.distanceToTriangle(g,E,b);if(T<P&&(A.copy(E),S&&S.copy(b),P=T,M=J,C=W),T<o)return!0}}}}}),qe.releasePrimitive(h),qe.releasePrimitive(g),P===1/0?null:(n.point?n.point.copy(A):n.point=A.clone(),n.distance=P,n.faceIndex=M,s&&(s.point?s.point.copy(S):s.point=S.clone(),s.point.applyMatrix4(ss),A.applyMatrix4(ss),s.distance=A.sub(s.point).length(),s.faceIndex=C),n)}function Au(){return typeof SharedArrayBuffer<"u"}const vn=new me.constructor,ps=new me.constructor,bt=new Ci(()=>new Fe),Kt=new Fe,Yt=new Fe,si=new Fe,ii=new Fe;let ri=!1;function Tu(i,e,t,n){if(ri)throw new Error("MeshBVH: Recursive calls to bvhcast not supported.");ri=!0;const s=i._roots,o=e._roots;let a,l=0,d=0;const p=new ut().copy(t).invert();for(let m=0,f=s.length;m<f;m++){vn.setBuffer(s[m]),d=0;const h=bt.getPrimitive();ye(0,vn.float32Array,h),h.applyMatrix4(p);for(let g=0,E=o.length;g<E&&(ps.setBuffer(o[g]),a=Xe(0,0,t,p,n,l,d,0,0,h),ps.clearBuffer(),d+=o[g].length,!a);g++);if(bt.releasePrimitive(h),vn.clearBuffer(),l+=s[m].length,a)break}return ri=!1,a}function Xe(i,e,t,n,s,o=0,a=0,l=0,d=0,p=null,m=!1){let f,h;m?(f=ps,h=vn):(f=vn,h=ps);const g=f.float32Array,E=f.uint32Array,A=f.uint16Array,b=h.float32Array,S=h.uint32Array,P=h.uint16Array,M=i*2,C=e*2,B=De(M,A),$=De(C,P);let N=!1;if($&&B)m?N=s(ke(e,S),Ue(e*2,P),ke(i,E),Ue(i*2,A),d,a+e,l,o+i):N=s(ke(i,E),Ue(i*2,A),ke(e,S),Ue(e*2,P),l,o+i,d,a+e);else if($){const W=bt.getPrimitive();ye(e,b,W),W.applyMatrix4(t);const z=ze(i),J=He(i,E);ye(z,g,Kt),ye(J,g,Yt);const ee=W.intersectsBox(Kt),F=W.intersectsBox(Yt);N=ee&&Xe(e,z,n,t,s,a,o,d,l+1,W,!m)||F&&Xe(e,J,n,t,s,a,o,d,l+1,W,!m),bt.releasePrimitive(W)}else{const W=ze(e),z=He(e,S);ye(W,b,si),ye(z,b,ii);const J=p.intersectsBox(si),ee=p.intersectsBox(ii);if(J&&ee)N=Xe(i,W,t,n,s,o,a,l,d+1,p,m)||Xe(i,z,t,n,s,o,a,l,d+1,p,m);else if(J)if(B)N=Xe(i,W,t,n,s,o,a,l,d+1,p,m);else{const F=bt.getPrimitive();F.copy(si).applyMatrix4(t);const T=ze(i),L=He(i,E);ye(T,g,Kt),ye(L,g,Yt);const j=F.intersectsBox(Kt),k=F.intersectsBox(Yt);N=j&&Xe(W,T,n,t,s,a,o,d,l+1,F,!m)||k&&Xe(W,L,n,t,s,a,o,d,l+1,F,!m),bt.releasePrimitive(F)}else if(ee)if(B)N=Xe(i,z,t,n,s,o,a,l,d+1,p,m);else{const F=bt.getPrimitive();F.copy(ii).applyMatrix4(t);const T=ze(i),L=He(i,E);ye(T,g,Kt),ye(L,g,Yt);const j=F.intersectsBox(Kt),k=F.intersectsBox(Yt);N=j&&Xe(z,T,n,t,s,a,o,d,l+1,F,!m)||k&&Xe(z,L,n,t,s,a,o,d,l+1,F,!m),bt.releasePrimitive(F)}}return N}const is=new Re,Io=new Fe,Su={strategy:Ca,maxDepth:40,maxLeafTris:10,useSharedArrayBuffer:!1,setBoundingBox:!0,onProgress:null,indirect:!1,verbose:!0,range:null};class Ri{static serialize(e,t={}){t={cloneBuffers:!0,...t};const n=e.geometry,s=e._roots,o=e._indirectBuffer,a=n.getIndex();let l;return t.cloneBuffers?l={roots:s.map(d=>d.slice()),index:a?a.array.slice():null,indirectBuffer:o?o.slice():null}:l={roots:s,index:a?a.array:null,indirectBuffer:o},l}static deserialize(e,t,n={}){n={setIndex:!0,indirect:!!e.indirectBuffer,...n};const{index:s,roots:o,indirectBuffer:a}=e,l=new Ri(t,{...n,[Ys]:!0});if(l._roots=o,l._indirectBuffer=a||null,n.setIndex){const d=t.getIndex();if(d===null){const p=new Mo(e.index,1,!1);t.setIndex(p)}else d.array!==s&&(d.array.set(s),d.needsUpdate=!0)}return l}get indirect(){return!!this._indirectBuffer}constructor(e,t={}){if(e.isBufferGeometry){if(e.index&&e.index.isInterleavedBufferAttribute)throw new Error("MeshBVH: InterleavedBufferAttribute is not supported for the index attribute.")}else throw new Error("MeshBVH: Only BufferGeometries are supported.");if(t=Object.assign({...Su,[Ys]:!1},t),t.useSharedArrayBuffer&&!Au())throw new Error("MeshBVH: SharedArrayBuffer is not available.");this.geometry=e,this._roots=null,this._indirectBuffer=null,t[Ys]||(Ff(this,t),!e.boundingBox&&t.setBoundingBox&&(e.boundingBox=this.getBoundingBox(new Fe))),this.resolveTriangleIndex=t.indirect?n=>this._indirectBuffer[n]:n=>n}refit(e=null){return(this.indirect?hu:Qf)(this,e)}traverse(e,t=0){const n=this._roots[t],s=new Uint32Array(n),o=new Uint16Array(n);a(0);function a(l,d=0){const p=l*2,m=o[p+15]===Es;if(m){const f=s[l+6],h=o[p+14];e(d,m,new Float32Array(n,l*4,6),f,h)}else{const f=l+Sn/4,h=s[l+6],g=s[l+7];e(d,m,new Float32Array(n,l*4,6),g)||(a(f,d+1),a(h,d+1))}}}raycast(e,t=dr,n=0,s=1/0){const o=this._roots,a=this.geometry,l=[],d=t.isMaterial,p=Array.isArray(t),m=a.groups,f=d?t.side:t,h=this.indirect?du:su;for(let g=0,E=o.length;g<E;g++){const A=p?t[m[g].materialIndex].side:f,b=l.length;if(h(this,g,A,e,l,n,s),p){const S=m[g].materialIndex;for(let P=b,M=l.length;P<M;P++)l[P].face.materialIndex=S}}return l}raycastFirst(e,t=dr,n=0,s=1/0){const o=this._roots,a=this.geometry,l=t.isMaterial,d=Array.isArray(t);let p=null;const m=a.groups,f=l?t.side:t,h=this.indirect?mu:ru;for(let g=0,E=o.length;g<E;g++){const A=d?t[m[g].materialIndex].side:f,b=h(this,g,A,e,n,s);b!=null&&(p==null||b.distance<p.distance)&&(p=b,d&&(b.face.materialIndex=m[g].materialIndex))}return p}intersectsGeometry(e,t){let n=!1;const s=this._roots,o=this.indirect?gu:ou;for(let a=0,l=s.length;a<l&&(n=o(this,a,e,t),!n);a++);return n}shapecast(e){const t=qe.getPrimitive(),n=this.indirect?nu:Zf;let{boundsTraverseOrder:s,intersectsBounds:o,intersectsRange:a,intersectsTriangle:l}=e;if(a&&l){const f=a;a=(h,g,E,A,b)=>f(h,g,E,A,b)?!0:n(h,g,this,l,E,A,t)}else a||(l?a=(f,h,g,E)=>n(f,h,this,l,g,E,t):a=(f,h,g)=>g);let d=!1,p=0;const m=this._roots;for(let f=0,h=m.length;f<h;f++){const g=m[f];if(d=qf(this,f,o,a,s,p),d)break;p+=g.byteLength}return qe.releasePrimitive(t),d}bvhcast(e,t,n){let{intersectsRanges:s,intersectsTriangles:o}=n;const a=qe.getPrimitive(),l=this.geometry.index,d=this.geometry.attributes.position,p=this.indirect?E=>{const A=this.resolveTriangleIndex(E);Ee(a,A*3,l,d)}:E=>{Ee(a,E*3,l,d)},m=qe.getPrimitive(),f=e.geometry.index,h=e.geometry.attributes.position,g=e.indirect?E=>{const A=e.resolveTriangleIndex(E);Ee(m,A*3,f,h)}:E=>{Ee(m,E*3,f,h)};if(o){const E=(A,b,S,P,M,C,B,$)=>{for(let N=S,W=S+P;N<W;N++){g(N),m.a.applyMatrix4(t),m.b.applyMatrix4(t),m.c.applyMatrix4(t),m.needsUpdate=!0;for(let z=A,J=A+b;z<J;z++)if(p(z),a.needsUpdate=!0,o(a,m,z,N,M,C,B,$))return!0}return!1};if(s){const A=s;s=function(b,S,P,M,C,B,$,N){return A(b,S,P,M,C,B,$,N)?!0:E(b,S,P,M,C,B,$,N)}}else s=E}return Tu(this,e,t,s)}intersectsBox(e,t){return is.set(e.min,e.max,t),is.needsUpdate=!0,this.shapecast({intersectsBounds:n=>is.intersectsBox(n),intersectsTriangle:n=>is.intersectsTriangle(n)})}intersectsSphere(e){return this.shapecast({intersectsBounds:t=>e.intersectsBox(t),intersectsTriangle:t=>t.intersectsSphere(e)})}closestPointToGeometry(e,t,n={},s={},o=0,a=1/0){return(this.indirect?Eu:uu)(this,e,t,n,s,o,a)}closestPointToPoint(e,t={},n=0,s=1/0){return Wf(this,e,t,n,s)}getBoundingBox(e){return e.makeEmpty(),this._roots.forEach(n=>{ye(0,new Float32Array(n),Io),e.union(Io)}),e}}const{lerp:Dt}=Pc,_e=[151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180];for(let i=0;i<256;i++)_e[256+i]=_e[i];function oi(i){return i*i*i*(i*(i*6-15)+10)}function wt(i,e,t,n){const s=i&15,o=s<8?e:t,a=s<4?t:s==12||s==14?e:n;return((s&1)==0?o:-o)+((s&2)==0?a:-a)}class vu{noise(e,t,n){const s=Math.floor(e),o=Math.floor(t),a=Math.floor(n),l=s&255,d=o&255,p=a&255;e-=s,t-=o,n-=a;const m=e-1,f=t-1,h=n-1,g=oi(e),E=oi(t),A=oi(n),b=_e[l]+d,S=_e[b]+p,P=_e[b+1]+p,M=_e[l+1]+d,C=_e[M]+p,B=_e[M+1]+p;return Dt(Dt(Dt(wt(_e[S],e,t,n),wt(_e[C],m,t,n),g),Dt(wt(_e[P],e,f,n),wt(_e[B],m,f,n),g),E),Dt(Dt(wt(_e[S+1],e,t,h),wt(_e[C+1],m,t,h),g),Dt(wt(_e[P+1],e,f,h),wt(_e[B+1],m,f,h),g),E),A)}}const Pn=class Pn{constructor(e){Y(this,"assetManager");Y(this,"terrainObject3D");Y(this,"terrainPatches",new Map);Y(this,"waterMesh");Y(this,"waterLevel",-10);Y(this,"populations",[]);Y(this,"planeStep",{x:0,z:0});Y(this,"prevPlaneStep",{x:Math.PI,z:Math.PI});this.assetManager=e,this.terrainObject3D=new Ic,this.terrainObject3D.position.y=-10,this.waterMesh=new Ne(new pr(ls/2,ls/2,1e3,1e3),this.assetManager.waterMaterial),this.waterMesh.rotation.x=Math.PI/2}getTerrainObject3D(){return this.terrainObject3D}getWaterMesh(){return this.waterMesh}initializeInternalPopulations(){this.populations=[{group:this.assetManager.groupTree,rarity:.02,min:10,max:150,seed:1e3,scale:.5,offset:3,randRot:()=>new Qt(Math.random()*.2,Math.random()*Math.PI*2,Math.random()*.2)},{group:this.assetManager.groupPalm,rarity:.01,min:0,max:40,seed:1e3,scale:.5,offset:0,randRot:()=>new Qt(Math.random()*.2,Math.random()*Math.PI*2,Math.random()*.2)}]}loadArchipelagoMap(){if(this.terrainObject3D.clear(),this.waterMesh.position.set(0,20,0),this.assetManager.archipelagoBaseGeometry){const e=new Ne(this.assetManager.archipelagoBaseGeometry,this.assetManager.terrainMaterial);e.scale.set(20,20,20),e.receiveShadow=!0,this.terrainObject3D.add(e),this.applyTerrainShader(e,{lim0:{value:1,color:Co},lim1:{value:2.5,color:Ro},lim2:{value:7,color:Do},lim3:{value:8,color:Bo}}),e.geometry.computeVertexNormals()}}handleTerrainGeneration(e){this.waterMesh.position.set(e.x,this.waterLevel,e.z),this.planeStep={x:Math.round(e.x/Ye),z:Math.round(e.z/Ye)};const t=-Math.floor(xr/Ye),n=Math.ceil(xr/Ye);if(this.planeStep.x!==this.prevPlaneStep.x||this.planeStep.z!==this.prevPlaneStep.z){const s=[t+this.planeStep.x,t+this.planeStep.z,n+this.planeStep.x,n+this.planeStep.z];this.removeTerrainBounds(...s),this.fillTerrainBounds(...s)}this.prevPlaneStep={...this.planeStep}}checkTerrainCollision(e){if(this.waterLevel>e.min.y)return!0;const t=`${this.planeStep.x},${this.planeStep.z}`,n=this.terrainPatches.get(t);return n?this.collisionCheckDetail(n,e):!1}noise(e,t){return Pn.perlin.noise(e.x,e.y,0)*t}terrainNoise(e,t,n){return this.noise(e.divideScalar(t),Vc*n)}noiseFunction(e){return this.terrainNoise(e,1,1)+this.terrainNoise(e,10,10)+this.terrainNoise(e,100,50)-5}applyTerrainNoise(e,t){const n=e.geometry.attributes.position,s=e.geometry.attributes.uv,o=new St;for(let a=0;a<n.count;a++){o.fromBufferAttribute(s,a).add(t).multiplyScalar(Uc);const l=this.noiseFunction(o);n.setZ(a,l)}n.needsUpdate=!0}applyTerrainShader(e,t){const n=l=>{const[d,p,m]=Zc(l);return`vec3(${d}, ${p}, ${m})`},s="varying vec3 vPos;",o=`
      uniform float lim0;
      uniform float lim1;
      uniform float lim2;
      uniform float lim3;
      ${s}
    `,a=`
      vec3 col = vPos.y >= lim3 ? ${n(t.lim3.color)} :
                  vPos.y >= lim2 ? ${n(t.lim2.color)} :
                  vPos.y >= lim1 ? ${n(t.lim1.color)} :
                                  ${n(t.lim0.color)};
      vec4 diffuseColor = vec4(col, opacity);
    `;e.material=new rs({side:Xt}),e.material.onBeforeCompile=l=>{Object.assign(l.uniforms,{lim0:t.lim0,lim1:t.lim1,lim2:t.lim2,lim3:t.lim3}),l.vertexShader=`
        ${s}
        ${l.vertexShader.replace("#include <begin_vertex>",`#include <begin_vertex>
vPos = vec3(position);`)}
      `,l.fragmentShader=`
        ${o}
        ${l.fragmentShader.replace("vec4 diffuseColor = vec4( diffuse, opacity );",a)}
      `}}addTerrain(e,t){const n=new pr(Ye,Ye,br,br),s=new Ne(n,this.assetManager.terrainMaterial);s.receiveShadow=!0,this.applyTerrainNoise(s,new St(e,t)),n.rotateX(Math.PI/2),s.position.set(e,0,t).multiplyScalar(Ye),n.computeVertexNormals(),n.boundsTree=new Ri(n),this.terrainObject3D.add(s),this.terrainPatches.set(`${e},${t}`,s),this.applyTerrainShader(s,Jc),this.populateTerrain(s)}populateTerrain(e){for(const t of this.populations)this.populateGroupMesh(e,t)}populateGroupMesh(e,t){const n=e.geometry.attributes.position,s=[];for(let o=0;o<n.count;o++)if(Math.random()>1-t.rarity){const a=new X;if(a.fromBufferAttribute(n,o),a.y+=t.offset,a.y-t.offset>t.min&&a.y<t.max&&Pn.perlin.noise(a.x/Ye+t.seed,a.z/Ye+t.seed,0)>=-.1){const l=t.randRot(),d=Math.random()/2+.5,p=he(d,d,d).multiplyScalar(t.scale);s.push(Qc(a,l,p))}}for(const o of t.group)e.add(el(o,s))}fillTerrainBounds(e,t,n,s){for(let o=e;o<=n;o++)for(let a=t;a<=s;a++)this.existsTerrain(o,a)||this.addTerrain(o,a)}existsTerrain(e,t){return this.terrainPatches.has(`${e},${t}`)}removeTerrainBounds(e,t,n,s){const o=[];for(const a of this.terrainPatches.keys()){const[l,d]=a.split(",").map(Number);(l<e||l>n||d<t||d>s)&&o.push(this.terrainPatches.get(a))}for(const a of o){this.terrainObject3D.remove(a);const l=a.position.x/Ye+","+a.position.z/Ye;this.terrainPatches.delete(l)}}collisionCheckDetail(e,t){const s=e.geometry.boundsTree,o=new ut().copy(e.matrixWorld).invert();return!!(s!=null&&s.intersectsBox(t,o))}};Y(Pn,"perlin",new vu);let Ei=Pn;var Bt=(i=>(i[i.DOGFIGHT=0]="DOGFIGHT",i[i.FREEFLIGHT=1]="FREEFLIGHT",i))(Bt||{});class Pu{constructor(){Y(this,"assetManager");Y(this,"networkManager");Y(this,"soundManager");Y(this,"inputManager");Y(this,"cameraManager");Y(this,"terrainManager");Y(this,"playerPlane");Y(this,"stand");Y(this,"activeProjectiles",[]);Y(this,"mode",Bt.DOGFIGHT);Y(this,"prev",-1);Y(this,"scene");Y(this,"renderer");Y(this,"dirLight");Y(this,"stats");Y(this,"ammoCountEl",document.getElementById("ammo-count"));Y(this,"menuEl",document.getElementById("menu"));Y(this,"blackoutEl",document.getElementById("blackout"));Y(this,"loadingEl",document.getElementById("loading"));Y(this,"waitingEl",document.getElementById("waiting"));Y(this,"ammoEl",document.getElementById("ammo"));Y(this,"freeButtonEl",document.getElementById("freeflight"));Y(this,"dogfightButtonEl",document.getElementById("dogfight"));Y(this,"headingEl",document.getElementsByClassName("heading")[0]);Y(this,"selectEl",document.getElementsByClassName("select")[0]);Y(this,"onWindowResize",()=>{const e=window.innerWidth,t=window.innerHeight;this.renderer.setSize(e,t),this.cameraManager.handleResize(e,t)});Y(this,"animate",()=>{if(this.stats.begin(),requestAnimationFrame(this.animate),this.playerPlane.flying){this.prev<0&&(this.prev=performance.now()-Ir);const e=Math.floor((performance.now()-this.prev)/Ir);if(this.mode===Bt.DOGFIGHT&&this.networkManager.sendPlayerUpdate({x:this.playerPlane.getPosition().x,y:this.playerPlane.getPosition().y,z:this.playerPlane.getPosition().z,rotX:this.playerPlane.mesh.rotation.x,rotY:this.playerPlane.mesh.rotation.y,rotZ:this.playerPlane.mesh.rotation.z}),e>1e3)this.prev=performance.now();else for(let t=0;t<e;t++){if(this.cameraManager.update(this.playerPlane,this.dirLight),this.inputManager.keyPressed(" ")){const s=this.cameraManager.getBaseLocalPosition(),o=this.playerPlane.fire(this.scene,s);this.activeProjectiles.push(...o),o.length>0&&this.ammoCountEl&&(this.soundManager.playShootingSound(this.playerPlane.mesh),this.ammoCountEl.innerText=this.playerPlane.getAmmo().toString())}this._updateActiveProjectiles(),this.playerPlane.updateCollisions(this.scene,this.cameraManager.getThreeCamera(),this.terrainManager),this.playerPlane.updatePhysics(),this.inputManager.handlePlaneKeys(this.playerPlane);const n=this.playerPlane.vel.local.length();this.soundManager.updatePlaneSound(n,this.playerPlane.mesh),this.mode===Bt.FREEFLIGHT&&this.terrainManager.handleTerrainGeneration(this.playerPlane.getPosition()),this.prev=performance.now()}}else this.staticUpdate();this.renderer.render(this.scene,this.cameraManager.getThreeCamera()),this.stats.end()});const e=window.innerWidth,t=window.innerHeight;this.assetManager=new Xc,this.inputManager=new nl,this.cameraManager=new tl(e,t),this.terrainManager=new Ei(this.assetManager),this.soundManager=new Ef(this.cameraManager.getThreeCamera()),this.scene=new _c,this.scene.background=new _o(Hc),this.scene.fog=new Oc(this.scene.background,ls*.5,ls),this.networkManager=new bf(this.assetManager,this.soundManager,this.scene),this.renderer=new Mc({logarithmicDepthBuffer:!0}),this.renderer.setSize(e,t),this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=Cc,document.body.appendChild(this.renderer.domElement),this.dirLight=new Rc(16777215,3),this.dirLight.position.set(1,1,1),this.dirLight.target.position.set(0,0,0),this.dirLight.castShadow=!0,this.dirLight.shadow.bias=-.01,this.dirLight.shadow.mapSize.width=2**13,this.dirLight.shadow.mapSize.height=2**13;const n=100;this.dirLight.shadow.camera.left=-100,this.dirLight.shadow.camera.right=n,this.dirLight.shadow.camera.top=n,this.dirLight.shadow.camera.bottom=-100,this.dirLight.shadow.camera.near=0,this.dirLight.shadow.camera.far=100;const s=new Dc(qc,3);this.scene.add(this.dirLight,this.dirLight.target,s,this.terrainManager.getTerrainObject3D(),this.terrainManager.getWaterMesh()),window.addEventListener("resize",this.onWindowResize),this.stand=new Ne(new Bc(1,1,2,32),this.assetManager.standMaterial)}async initializeApp(){this.stats=new An,this.stats.dom.style.visibility="hidden",document.body.appendChild(this.stats.dom);try{await this.assetManager.loadAllAssets(),await this.soundManager.loadAllSounds(),this.terrainManager.initializeInternalPopulations(),this.playerPlane=new Ma(this.assetManager,this.soundManager),this.scene.add(this.playerPlane.mesh),this.ammoCountEl&&(this.ammoCountEl.innerText=this.playerPlane.getAmmo().toString()),this.inputManager.setupGlobalInputListeners(),this.staticScene(),this.animate(),this.freeButtonEl&&(this.freeButtonEl.onclick=()=>this.enter(Bt.FREEFLIGHT)),this.dogfightButtonEl&&(this.dogfightButtonEl.onclick=()=>this.enter(Bt.DOGFIGHT))}catch(e){console.error("Failed to initialize the application:",e),this.loadingEl&&(this.loadingEl.innerText="Error loading assets. Please refresh.")}}initGame(){this.menuEl&&(this.menuEl.style.display="none"),this.blackoutEl&&this.blackoutEl.classList.add("right"),this.loadingEl&&this.loadingEl.classList.remove("active"),this.waitingEl&&this.waitingEl.classList.remove("active"),this.playerPlane.setPosition(he(0,5,0)),this.playerPlane.setRotation(new Qt(0,0,0)),this.playerPlane.vel.local.z=-.1,this.playerPlane.mesh.add(this.cameraManager.getThreeCamera()),this.playerPlane.flying=!0,this.ammoEl&&this.ammoEl.classList.add("active")}staticScene(){this.menuEl&&(this.menuEl.style.display="flex"),this.blackoutEl&&this.blackoutEl.classList.add("left");const e=he(145,-2,0),t=this.cameraManager.getThreeCamera();this.cameraManager.setPosition(he(-1,.5,2).add(e)),this.cameraManager.setRotation(new Qt(0,-.1,0)),this.playerPlane.setRotation(new Qt(...tn(he(t.rotation.x,t.rotation.y,t.rotation.z),he(-.1,Math.PI*.75,.1)))),this.playerPlane.mesh.remove(t),this.playerPlane.setPosition(he(0,0,0).add(e)),this.stand.position.set(...tn(this.playerPlane.getPosition(),he(0,-1.45,0))),this.stand.castShadow=!0,this.stand.receiveShadow=!0,this.scene.add(this.stand);const n=this.playerPlane.getPosition();this.dirLight.target.position.set(n.x,10,n.z),this.dirLight.position.set(...tn(this.dirLight.target.position,he(1,1,1))),this.terrainManager.handleTerrainGeneration(n),this.cameraManager.updateSavePosition()}staticUpdate(){const e=this.inputManager.getInputState(),t={x:e.mouse.x-window.innerWidth/2,y:e.mouse.y-window.innerHeight/2};this.cameraManager.updateStatic(t),this.headingEl&&(this.headingEl.style.transform=`translate(${t.x/100}px, ${t.y/100}px)`),this.selectEl&&(this.selectEl.style.transform=`translate(${t.x/200}px, ${t.y/200}px)`)}enter(e){this.blackoutEl&&(this.blackoutEl.classList.remove("left"),this.blackoutEl.classList.remove("right")),setTimeout(async()=>{this.scene.remove(this.stand),this.mode=e,this.initGame(),this.mode===Bt.DOGFIGHT&&(this.terrainManager.loadArchipelagoMap(),this.playerPlane.setPosition(he(0,100,0)),await this.networkManager.joinOrCreateRoom("my_room"))},1e3)}_updateActiveProjectiles(){const e=[],t=this.playerPlane.mesh,n=this.playerPlane.collider,s=this.playerPlane.getPosition();for(const o of this.activeProjectiles){o.updateMovement();let a=!1;o.owner!==t&&!this.playerPlane.destroyed&&o.checkCollisionWith(n)&&(this.playerPlane.performCollision(this.scene,this.cameraManager.getThreeCamera()),a=!0),!a&&o.isOutOfBounds(s)&&(a=!0),a?o.removeFromScene(this.scene):e.push(o)}this.activeProjectiles=e}}const Iu=new Pu;Iu.initializeApp();
