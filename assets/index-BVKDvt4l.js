var Je=Object.defineProperty;var Qe=(u,e,t)=>e in u?Je(u,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):u[e]=t;var p=(u,e,t)=>Qe(u,typeof e!="symbol"?e+"":e,t);import{L as et,F as tt,C as qe,S as st,G as it,B as ve,a as B,b as de,M as be,P as ne,c as nt,d as Ee,e as ue,f as F,V as w,T as ot,N as Le,g as pe,D as H,h as J,i as Xe,Q as at,j as rt,I as lt,E as $,k as ct,l as Pe,A as ht,m as dt,n as Se,o as ut,p as pt,O as mt,q as Te,r as _e,s as Ye,t as re,u as ft,v as gt,w as yt,W as wt,x as vt,y as Pt,z as Mt,H as xt}from"./three-BHkmP2Xi.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function t(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=t(i);fetch(i.href,n)}})();var ee=function(){var u=0,e=document.createElement("div");e.style.cssText="position:fixed;top:0;left:0;cursor:pointer;opacity:0.9;z-index:10000",e.addEventListener("click",function(d){d.preventDefault(),s(++u%e.children.length)},!1);function t(d){return e.appendChild(d.dom),d}function s(d){for(var h=0;h<e.children.length;h++)e.children[h].style.display=h===d?"block":"none";u=d}var i=(performance||Date).now(),n=i,o=0,a=t(new ee.Panel("FPS","#0ff","#002")),r=t(new ee.Panel("MS","#0f0","#020"));if(self.performance&&self.performance.memory)var c=t(new ee.Panel("MB","#f08","#201"));return s(0),{REVISION:16,dom:e,addPanel:t,showPanel:s,begin:function(){i=(performance||Date).now()},end:function(){o++;var d=(performance||Date).now();if(r.update(d-i,200),d>=n+1e3&&(a.update(o*1e3/(d-n),100),n=d,o=0,c)){var h=performance.memory;c.update(h.usedJSHeapSize/1048576,h.jsHeapSizeLimit/1048576)}return d},update:function(){i=this.end()},domElement:e,setMode:s}};ee.Panel=function(u,e,t){var s=1/0,i=0,n=Math.round,o=n(window.devicePixelRatio||1),a=80*o,r=48*o,c=3*o,d=2*o,h=3*o,l=15*o,f=74*o,y=30*o,g=document.createElement("canvas");g.width=a,g.height=r,g.style.cssText="width:80px;height:48px";var m=g.getContext("2d");return m.font="bold "+9*o+"px Helvetica,Arial,sans-serif",m.textBaseline="top",m.fillStyle=t,m.fillRect(0,0,a,r),m.fillStyle=e,m.fillText(u,c,d),m.fillRect(h,l,f,y),m.fillStyle=t,m.globalAlpha=.9,m.fillRect(h,l,f,y),{dom:g,update:function(P,x){s=Math.min(s,P),i=Math.max(i,P),m.fillStyle=t,m.globalAlpha=1,m.fillRect(0,0,a,l),m.fillStyle=e,m.fillText(n(P)+" "+u+" ("+n(s)+"-"+n(i)+")",c,d),m.drawImage(g,h+o,l,f-o,y,h,l,f-o,y),m.fillRect(h+f-o,l,o,y),m.fillStyle=t,m.globalAlpha=.9,m.fillRect(h+f-o,l,o,n((1-P/x)*y))}}};const bt=/^[og]\s*(.+)?/,Et=/^mtllib /,Lt=/^usemtl /,St=/^usemap /,Ve=/\s+/,Ce=new w,me=new w,Ae=new w,Fe=new w,A=new w,oe=new qe;function Tt(){const u={objects:[],object:{},vertices:[],normals:[],colors:[],uvs:[],materials:{},materialLibraries:[],startObject:function(e,t){if(this.object&&this.object.fromDeclaration===!1){this.object.name=e,this.object.fromDeclaration=t!==!1;return}const s=this.object&&typeof this.object.currentMaterial=="function"?this.object.currentMaterial():void 0;if(this.object&&typeof this.object._finalize=="function"&&this.object._finalize(!0),this.object={name:e||"",fromDeclaration:t!==!1,geometry:{vertices:[],normals:[],colors:[],uvs:[],hasUVIndices:!1},materials:[],smooth:!0,startMaterial:function(i,n){const o=this._finalize(!1);o&&(o.inherited||o.groupCount<=0)&&this.materials.splice(o.index,1);const a={index:this.materials.length,name:i||"",mtllib:Array.isArray(n)&&n.length>0?n[n.length-1]:"",smooth:o!==void 0?o.smooth:this.smooth,groupStart:o!==void 0?o.groupEnd:0,groupEnd:-1,groupCount:-1,inherited:!1,clone:function(r){const c={index:typeof r=="number"?r:this.index,name:this.name,mtllib:this.mtllib,smooth:this.smooth,groupStart:0,groupEnd:-1,groupCount:-1,inherited:!1};return c.clone=this.clone.bind(c),c}};return this.materials.push(a),a},currentMaterial:function(){if(this.materials.length>0)return this.materials[this.materials.length-1]},_finalize:function(i){const n=this.currentMaterial();if(n&&n.groupEnd===-1&&(n.groupEnd=this.geometry.vertices.length/3,n.groupCount=n.groupEnd-n.groupStart,n.inherited=!1),i&&this.materials.length>1)for(let o=this.materials.length-1;o>=0;o--)this.materials[o].groupCount<=0&&this.materials.splice(o,1);return i&&this.materials.length===0&&this.materials.push({name:"",smooth:this.smooth}),n}},s&&s.name&&typeof s.clone=="function"){const i=s.clone(0);i.inherited=!0,this.object.materials.push(i)}this.objects.push(this.object)},finalize:function(){this.object&&typeof this.object._finalize=="function"&&this.object._finalize(!0)},parseVertexIndex:function(e,t){const s=parseInt(e,10);return(s>=0?s-1:s+t/3)*3},parseNormalIndex:function(e,t){const s=parseInt(e,10);return(s>=0?s-1:s+t/3)*3},parseUVIndex:function(e,t){const s=parseInt(e,10);return(s>=0?s-1:s+t/2)*2},addVertex:function(e,t,s){const i=this.vertices,n=this.object.geometry.vertices;n.push(i[e+0],i[e+1],i[e+2]),n.push(i[t+0],i[t+1],i[t+2]),n.push(i[s+0],i[s+1],i[s+2])},addVertexPoint:function(e){const t=this.vertices;this.object.geometry.vertices.push(t[e+0],t[e+1],t[e+2])},addVertexLine:function(e){const t=this.vertices;this.object.geometry.vertices.push(t[e+0],t[e+1],t[e+2])},addNormal:function(e,t,s){const i=this.normals,n=this.object.geometry.normals;n.push(i[e+0],i[e+1],i[e+2]),n.push(i[t+0],i[t+1],i[t+2]),n.push(i[s+0],i[s+1],i[s+2])},addFaceNormal:function(e,t,s){const i=this.vertices,n=this.object.geometry.normals;Ce.fromArray(i,e),me.fromArray(i,t),Ae.fromArray(i,s),A.subVectors(Ae,me),Fe.subVectors(Ce,me),A.cross(Fe),A.normalize(),n.push(A.x,A.y,A.z),n.push(A.x,A.y,A.z),n.push(A.x,A.y,A.z)},addColor:function(e,t,s){const i=this.colors,n=this.object.geometry.colors;i[e]!==void 0&&n.push(i[e+0],i[e+1],i[e+2]),i[t]!==void 0&&n.push(i[t+0],i[t+1],i[t+2]),i[s]!==void 0&&n.push(i[s+0],i[s+1],i[s+2])},addUV:function(e,t,s){const i=this.uvs,n=this.object.geometry.uvs;n.push(i[e+0],i[e+1]),n.push(i[t+0],i[t+1]),n.push(i[s+0],i[s+1])},addDefaultUV:function(){const e=this.object.geometry.uvs;e.push(0,0),e.push(0,0),e.push(0,0)},addUVLine:function(e){const t=this.uvs;this.object.geometry.uvs.push(t[e+0],t[e+1])},addFace:function(e,t,s,i,n,o,a,r,c){const d=this.vertices.length;let h=this.parseVertexIndex(e,d),l=this.parseVertexIndex(t,d),f=this.parseVertexIndex(s,d);if(this.addVertex(h,l,f),this.addColor(h,l,f),a!==void 0&&a!==""){const y=this.normals.length;h=this.parseNormalIndex(a,y),l=this.parseNormalIndex(r,y),f=this.parseNormalIndex(c,y),this.addNormal(h,l,f)}else this.addFaceNormal(h,l,f);if(i!==void 0&&i!==""){const y=this.uvs.length;h=this.parseUVIndex(i,y),l=this.parseUVIndex(n,y),f=this.parseUVIndex(o,y),this.addUV(h,l,f),this.object.geometry.hasUVIndices=!0}else this.addDefaultUV()},addPointGeometry:function(e){this.object.geometry.type="Points";const t=this.vertices.length;for(let s=0,i=e.length;s<i;s++){const n=this.parseVertexIndex(e[s],t);this.addVertexPoint(n),this.addColor(n)}},addLineGeometry:function(e,t){this.object.geometry.type="Line";const s=this.vertices.length,i=this.uvs.length;for(let n=0,o=e.length;n<o;n++)this.addVertexLine(this.parseVertexIndex(e[n],s));for(let n=0,o=t.length;n<o;n++)this.addUVLine(this.parseUVIndex(t[n],i))}};return u.startObject("",!1),u}class _t extends et{constructor(e){super(e),this.materials=null}load(e,t,s,i){const n=this,o=new tt(this.manager);o.setPath(this.path),o.setRequestHeader(this.requestHeader),o.setWithCredentials(this.withCredentials),o.load(e,function(a){try{t(n.parse(a))}catch(r){i?i(r):console.error(r),n.manager.itemError(e)}},s,i)}setMaterials(e){return this.materials=e,this}parse(e){const t=new Tt;e.indexOf(`\r
`)!==-1&&(e=e.replace(/\r\n/g,`
`)),e.indexOf(`\\
`)!==-1&&(e=e.replace(/\\\n/g,""));const s=e.split(`
`);let i=[];for(let a=0,r=s.length;a<r;a++){const c=s[a].trimStart();if(c.length===0)continue;const d=c.charAt(0);if(d!=="#")if(d==="v"){const h=c.split(Ve);switch(h[0]){case"v":t.vertices.push(parseFloat(h[1]),parseFloat(h[2]),parseFloat(h[3])),h.length>=7?(oe.setRGB(parseFloat(h[4]),parseFloat(h[5]),parseFloat(h[6]),st),t.colors.push(oe.r,oe.g,oe.b)):t.colors.push(void 0,void 0,void 0);break;case"vn":t.normals.push(parseFloat(h[1]),parseFloat(h[2]),parseFloat(h[3]));break;case"vt":t.uvs.push(parseFloat(h[1]),parseFloat(h[2]));break}}else if(d==="f"){const l=c.slice(1).trim().split(Ve),f=[];for(let g=0,m=l.length;g<m;g++){const P=l[g];if(P.length>0){const x=P.split("/");f.push(x)}}const y=f[0];for(let g=1,m=f.length-1;g<m;g++){const P=f[g],x=f[g+1];t.addFace(y[0],P[0],x[0],y[1],P[1],x[1],y[2],P[2],x[2])}}else if(d==="l"){const h=c.substring(1).trim().split(" ");let l=[];const f=[];if(c.indexOf("/")===-1)l=h;else for(let y=0,g=h.length;y<g;y++){const m=h[y].split("/");m[0]!==""&&l.push(m[0]),m[1]!==""&&f.push(m[1])}t.addLineGeometry(l,f)}else if(d==="p"){const l=c.slice(1).trim().split(" ");t.addPointGeometry(l)}else if((i=bt.exec(c))!==null){const h=(" "+i[0].slice(1).trim()).slice(1);t.startObject(h)}else if(Lt.test(c))t.object.startMaterial(c.substring(7).trim(),t.materialLibraries);else if(Et.test(c))t.materialLibraries.push(c.substring(7).trim());else if(St.test(c))console.warn('THREE.OBJLoader: Rendering identifier "usemap" not supported. Textures must be defined in MTL files.');else if(d==="s"){if(i=c.split(" "),i.length>1){const l=i[1].trim().toLowerCase();t.object.smooth=l!=="0"&&l!=="off"}else t.object.smooth=!0;const h=t.object.currentMaterial();h&&(h.smooth=t.object.smooth)}else{if(c==="\0")continue;console.warn('THREE.OBJLoader: Unexpected line: "'+c+'"')}}t.finalize();const n=new it;if(n.materialLibraries=[].concat(t.materialLibraries),!(t.objects.length===1&&t.objects[0].geometry.vertices.length===0)===!0)for(let a=0,r=t.objects.length;a<r;a++){const c=t.objects[a],d=c.geometry,h=c.materials,l=d.type==="Line",f=d.type==="Points";let y=!1;if(d.vertices.length===0)continue;const g=new ve;g.setAttribute("position",new B(d.vertices,3)),d.normals.length>0&&g.setAttribute("normal",new B(d.normals,3)),d.colors.length>0&&(y=!0,g.setAttribute("color",new B(d.colors,3))),d.hasUVIndices===!0&&g.setAttribute("uv",new B(d.uvs,2));const m=[];for(let x=0,j=h.length;x<j;x++){const T=h[x],O=T.name+"_"+T.smooth+"_"+y;let M=t.materials[O];if(this.materials!==null){if(M=this.materials.create(T.name),l&&M&&!(M instanceof de)){const V=new de;be.prototype.copy.call(V,M),V.color.copy(M.color),M=V}else if(f&&M&&!(M instanceof ne)){const V=new ne({size:10,sizeAttenuation:!1});be.prototype.copy.call(V,M),V.color.copy(M.color),V.map=M.map,M=V}}M===void 0&&(l?M=new de:f?M=new ne({size:1,sizeAttenuation:!1}):M=new nt,M.name=T.name,M.flatShading=!T.smooth,M.vertexColors=y,t.materials[O]=M),m.push(M)}let P;if(m.length>1){for(let x=0,j=h.length;x<j;x++){const T=h[x];g.addGroup(T.groupStart,T.groupCount,x)}l?P=new Ee(g,m):f?P=new ue(g,m):P=new F(g,m)}else l?P=new Ee(g,m[0]):f?P=new ue(g,m[0]):P=new F(g,m[0]);P.name=c.name,n.add(P)}else if(t.vertices.length>0){const a=new ne({size:1,sizeAttenuation:!1}),r=new ve;r.setAttribute("position",new B(t.vertices,3)),t.colors.length>0&&t.colors[0]!==void 0&&(r.setAttribute("color",new B(t.colors,3)),a.vertexColors=!0);const c=new ue(r,a);n.add(c)}return n}}const je=1e3,Re=25,ce=1e4,R=100,Vt=10,Ct=2.5,Ie=1e-4,ze=1e-4,Oe=1e-4,fe=.99,At=1e-4,Ft=8900331,jt=7566195,Rt=6316128,It=3904470,zt=14534787,Ot=4749082,Dt=7773009,Bt=16777215,De=12892835,Be=8297810,kt=3947580,ke=16777184,Nt={lim0:{value:0,color:zt},lim1:{value:10,color:Ot},lim2:{value:100,color:Dt},lim3:{value:175,color:Bt}},Ne=5,Gt=100,Ht=200;class $t{constructor(){p(this,"objLoader");p(this,"threeTone");p(this,"planeMaterial");p(this,"terrainMaterial");p(this,"waterMaterial");p(this,"volcanoMaterial");p(this,"weaponMaterial");p(this,"standMaterial");p(this,"planeMesh");p(this,"volcanoBaseGeometry",null);p(this,"groupTree",[]);p(this,"groupPalm",[]);p(this,"weaponModel");this.objLoader=new _t,this.threeTone=new ot().load("/textures/fiveTone.jpg"),this.threeTone.minFilter=Le,this.threeTone.magFilter=Le,this.planeMaterial=new pe({color:Rt,side:H}),this.terrainMaterial=new J({vertexColors:!0,side:H,gradientMap:this.threeTone}),this.waterMaterial=new pe({color:It,side:H,transparent:!0,opacity:.8}),this.volcanoMaterial=new J({color:kt,side:H,gradientMap:this.threeTone}),this.weaponMaterial=new pe({color:ke,emissive:ke}),this.standMaterial=new J({color:12566463,gradientMap:this.threeTone}),this.weaponModel=new F(new Xe(.1,.1,2),this.weaponMaterial)}createPropMaterial(e){return new J({color:e,side:H,gradientMap:this.threeTone})}load(e,t,s){return new Promise((i,n)=>{this.objLoader.load(e,o=>{o.traverse(a=>{a instanceof F&&(a.material=t,a.geometry.computeVertexNormals(!0),a.castShadow=!0)}),o.scale.set(s,s,s),i(o)},o=>{`${e}`,o.loaded/o.total*100},o=>{console.error(`Error loading model from ${e}:`,o),n(new Error(`Failed to load OBJ model from ${e}`))})})}loadGeometry(e){return new Promise((t,s)=>{let i;this.objLoader.load(e,n=>{n.traverse(o=>{o instanceof F&&(o.geometry.computeVertexNormals(!0),i=o.geometry)}),i?t({path:e,geometry:i}):(console.error(`No geometry found in loaded mesh from ${e}`),s(new Error(`No geometry found in ${e}`)))},n=>{`${e}`,n.loaded/n.total*100},n=>{console.error(`Error loading geometry from ${e}:`,n),s(new Error(`Failed to load geometry from ${e}`))})})}async gLoad(e){const t=[],s=e.map(async n=>{try{const{geometry:o}=await this.loadGeometry(n.path),a=this.createPropMaterial(n.color);return new F(o,a)}catch(o){return console.error(`Failed to load geometry for gLoad: ${n.path}`,o),null}});return(await Promise.all(s)).forEach(n=>{n&&t.push(n)}),t}async loadAllAssets(){try{const e=await this.load("/models/vehicle/airplane.obj",this.planeMaterial,.1);this.planeMesh=e;const t=await this.loadGeometry("/models/maps/volcano_base.obj");this.volcanoBaseGeometry=t.geometry;const s=[this.gLoad([{path:"/models/tree/tree_trunk.obj",color:De},{path:"/models/tree/tree_leaves.obj",color:Be}]),this.gLoad([{path:"/models/palm_tree/trunk.obj",color:De},{path:"/models/palm_tree/leaves.obj",color:Be}])],[i,n]=await Promise.all(s);this.groupTree=i,this.groupPalm=n}catch(e){throw console.error("Error loading assets in AssetManager:",e),e}}}function E(...u){if(u.length===1){const e=u[0];if(Array.isArray(e))return new w(...e);if(e instanceof w)return e}return u.length===3?new w(u[0],u[1],u[2]):new w}function W(u,e){const t=u instanceof w?u:new w(...u),s=e instanceof w?e:new w(...e),i=t.clone().add(s);return[i.x,i.y,i.z]}function Me(u){return[u.x,u.y,u.z]}function Wt(u){let e=u.toString(16);for(;e.length<6;)e=`0${e}`;const t=(s,i)=>parseInt(e.substring(s,i),16)/255;return[t(0,2),t(2,4),t(4,6)]}function Ut(u,e,t){const s=new at;return s.setFromEuler(e),new rt().compose(u,s,t)}function qt(u,e){const t=new lt(u.geometry,u.material,e.length);t.castShadow=!0,t.receiveShadow=!0;for(let s=0;s<e.length;s++)t.setMatrixAt(s,e[s]);return t}function Xt(u,e,t,s,i,n){return u>=t&&u<=i&&e>=s&&e<=n}class Yt{constructor(e,t){p(this,"camera");p(this,"baseLocalPos",E(0,10,20));p(this,"baseLocalRot",new $(0,0,0));p(this,"save",E(0,10,20));p(this,"factor",500);this.camera=new ct(75,e/t,.1,1e4),this.camera.position.copy(this.baseLocalPos),this.camera.rotation.copy(this.baseLocalRot)}getThreeCamera(){return this.camera}handleResize(e,t){this.camera.aspect=e/t,this.camera.updateProjectionMatrix()}updateSavePosition(){this.save=this.camera.position.clone()}getBaseLocalPosition(){return this.baseLocalPos}setPosition(e){this.camera.position.copy(e)}setRotation(e){this.camera.rotation.copy(e)}update(e,t){const s=E(-e.rotVel.yaw*this.factor,e.rotVel.pitch*this.factor,-e.vel.local.z/10*this.factor);if(this.camera.position.set(...W(this.baseLocalPos,s)),this.camera.rotation.copy(this.baseLocalRot),t){const i=e.getPosition();t.target.position.copy(i),t.position.set(i.x+1,i.y+1,i.z+1)}}updateStatic(e){this.camera.position.set(...W(this.save,E(-e.x/4e3,e.y/4e3,0)))}}class Zt{constructor(){p(this,"_inputState");this._inputState={keys:{},mouse:{x:0,y:0}}}_updateKey(e,t){this._inputState.keys[e]=t}_updateMousePosition(e,t){this._inputState.mouse.x=e,this._inputState.mouse.y=t}keyPressed(e){return this._inputState.keys.hasOwnProperty(e)?this._inputState.keys[e]:!1}handlePlaneKeys(e){if(!e)return;let t=e.rotVel;this.keyPressed("ArrowUp")&&(t.pitch+=ze),this.keyPressed("ArrowDown")&&(t.pitch-=ze),this.keyPressed("ArrowLeft")&&(t.yaw+=Ie),this.keyPressed("ArrowRight")&&(t.yaw-=Ie),this.keyPressed("a")&&(t.roll+=Oe),this.keyPressed("d")&&(t.roll-=Oe),e.rotVel=t,this.keyPressed("w")?e.thrust=At:this.keyPressed("s")?e.thrust=-1e-4:e.thrust=0}setupGlobalInputListeners(){const e=s=>{this._updateKey(s.key,s.type==="keydown")};document.removeEventListener("keydown",e),document.removeEventListener("keyup",e),document.addEventListener("keydown",e),document.addEventListener("keyup",e);const t=s=>{this._updateMousePosition(s.clientX,s.clientY)};document.removeEventListener("mousemove",t),document.addEventListener("mousemove",t)}getInputState(){return this._inputState}}const Kt=500;class Ge{constructor(e,t){p(this,"mesh");p(this,"owner");this.mesh=e,this.owner=t}updateMovement(){this.mesh.translateZ(-2)}isOutOfBounds(e){return this.mesh.position.distanceTo(e)>Kt}getBoundingBox(){return new Pe().setFromObject(this.mesh)}checkCollisionWith(e){if(this.owner===e)return!1;const t=new Pe().setFromObject(e);return this.getBoundingBox().intersectsBox(t)}removeFromScene(e){e.remove(this.mesh)}}class Jt{constructor(e,t){p(this,"mesh");p(this,"collider");p(this,"assetManager");p(this,"ammo",Ht);p(this,"lastWeaponFireTime",0);p(this,"thrust",1e-4);p(this,"vel",{global:E(0,0,0),local:E(0,0,0)});p(this,"rot",{yaw:0,roll:0,pitch:0});p(this,"rotVel",{yaw:0,roll:0,pitch:0});this.mesh=e,this.assetManager=t,this.lastWeaponFireTime=0,this.collider=new F(new Xe(10,1,20),this.assetManager.planeMaterial),this.collider.visible=!1,this.mesh.add(this.collider)}getAmmo(){return this.ammo}canFire(){return(performance.now()-this.lastWeaponFireTime>Gt||this.lastWeaponFireTime===0)&&this.ammo>0}fire(e,t){if(!this.canFire())return[];this.ammo--,this.lastWeaponFireTime=performance.now();const s=a=>{const r=E(W(t.clone().multiplyScalar(-1),E(a,2,-10)));return this.mesh.localToWorld(r.clone())},i=[],n=this.assetManager.weaponModel.clone();n.position.set(...Me(s(-10))),n.rotation.copy(this.mesh.rotation),e.add(n),i.push(new Ge(n,this.mesh));const o=this.assetManager.weaponModel.clone();return o.position.set(...Me(s(10))),o.rotation.copy(this.mesh.rotation),e.add(o),i.push(new Ge(o,this.mesh)),i}updatePhysics(){this.mesh.position.add(this.vel.global),this.mesh.translateX(this.vel.local.x),this.mesh.translateY(this.vel.local.y),this.mesh.translateZ(this.vel.local.z);let e=this.vel.local.z-this.thrust;e>0&&(e=0),this.vel.local.z=e;const t=this.vel.local.z<0?1e-6/-this.vel.local.z:1e-5;this.vel.global.y-=t,this.rotVel.pitch*=fe,this.rotVel.roll*=fe,this.rotVel.yaw*=fe,this.rot.pitch+=this.rotVel.pitch,this.rot.roll+=this.rotVel.roll,this.rot.yaw+=this.rotVel.yaw,this.mesh.rotateX(this.rotVel.pitch),this.mesh.rotateZ(this.rotVel.roll),this.mesh.rotateY(this.rotVel.yaw)}updateCollisions(){}getPosition(){return this.mesh.position.clone()}getRotation(){return this.mesh.rotation.clone()}setPosition(e){this.mesh.position.copy(e)}setRotation(e){this.mesh.rotation.copy(e)}}class Qt{constructor(e){p(this,"listener");p(this,"audioLoader");p(this,"sounds");p(this,"positionalSounds");p(this,"ENABLED",!0);this.listener=new ht,this.ENABLED||this.listener.setMasterVolume(0),e.add(this.listener),this.audioLoader=new dt,this.sounds=new Map,this.positionalSounds=new Map}async loadAllSounds(){await Promise.all([this.loadSound("plane-flying","sounds/plane-flying.mp3"),this.loadSound("plane-shooting","sounds/plane-shooting.mp3"),this.loadSound("plane-exploding","sounds/plane-exploding.mp3")])}async loadSound(e,t){return new Promise((s,i)=>{this.audioLoader.load(t,n=>{this.sounds.set(e,n),s()},void 0,n=>{console.error(`Error loading sound ${e}:`,n),i(n)})})}createPositionalSound(e){const t=this.sounds.get(e);if(t){const s=new Se(this.listener);return s.setBuffer(t),this.positionalSounds.set(e,s),s}console.warn(`Audio buffer not found for sound: ${e}`)}updatePlaneSound(e,t){const s="plane-flying";let i=this.positionalSounds.get(s);i||(i=this.createPositionalSound(s),i&&(t.add(i),i.setVolume(2),i.setLoop(!0),i.play()));const a=1+e*1;i==null||i.setPlaybackRate(a)}playShootingSound(e){const t="plane-shooting",s=this.sounds.get(t);if(s){const i=new Se(this.listener);i.setBuffer(s),i.setVolume(3),e.add(i),i.play()}else console.warn(`Audio buffer not found for sound: ${t}`)}playExplosionSound(){const e="plane-exploding",t=this.sounds.get(e);if(t){const s=new ut(this.listener);s.setBuffer(t),s.play()}else console.warn(`Audio buffer not found for sound: ${e}`)}}const{lerp:N}=pt,S=[151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180];for(let u=0;u<256;u++)S[256+u]=S[u];function ge(u){return u*u*u*(u*(u*6-15)+10)}function D(u,e,t,s){const i=u&15,n=i<8?e:t,o=i<4?t:i==12||i==14?e:s;return((i&1)==0?n:-n)+((i&2)==0?o:-o)}class es{noise(e,t,s){const i=Math.floor(e),n=Math.floor(t),o=Math.floor(s),a=i&255,r=n&255,c=o&255;e-=i,t-=n,s-=o;const d=e-1,h=t-1,l=s-1,f=ge(e),y=ge(t),g=ge(s),m=S[a]+r,P=S[m]+c,x=S[m+1]+c,j=S[a+1]+r,T=S[j]+c,O=S[j+1]+c;return N(N(N(D(S[P],e,t,s),D(S[T],d,t,s),f),N(D(S[x],e,h,s),D(S[O],d,h,s),f),y),N(N(D(S[P+1],e,t,l),D(S[T+1],d,t,l),f),N(D(S[x+1],e,h,l),D(S[O+1],d,h,l),f),y),g)}}const se=class se{constructor(e){p(this,"assetManager");p(this,"terrainObject3D");p(this,"terrainPatches",new Map);p(this,"waterMesh");p(this,"waterLevel",-10);p(this,"populations",[]);p(this,"planeStep",{x:0,z:0});p(this,"prevPlaneStep",{x:Math.PI,z:Math.PI});this.assetManager=e,this.terrainObject3D=new mt,this.terrainObject3D.position.y=-10,this.waterMesh=new F(new Te(ce,ce,1e3,1e3),this.assetManager.waterMaterial),this.waterMesh.rotation.x=Math.PI/2}getTerrainObject3D(){return this.terrainObject3D}getWaterMesh(){return this.waterMesh}initializeInternalPopulations(){this.populations=[{group:this.assetManager.groupTree,rarity:.02,min:10,max:150,seed:1e3,scale:.5,offset:3,randRot:()=>new $(Math.random()*.2,Math.random()*Math.PI*2,Math.random()*.2)},{group:this.assetManager.groupPalm,rarity:.01,min:0,max:40,seed:1e3,scale:.5,offset:0,randRot:()=>new $(Math.random()*.2,Math.random()*Math.PI*2,Math.random()*.2)}]}handleTerrainGeneration(e){this.waterMesh.position.set(0,this.waterLevel,0),this.planeStep={x:Math.round(e.x/R),z:Math.round(e.z/R)};const t=-Math.floor(je/R),s=Math.ceil(je/R);if(this.planeStep.x!==this.prevPlaneStep.x||this.planeStep.z!==this.prevPlaneStep.z){const i=[t+this.planeStep.x,t+this.planeStep.z,s+this.planeStep.x,s+this.planeStep.z];this.removeTerrainBounds(...i),this.fillTerrainBounds(...i)}this.prevPlaneStep={...this.planeStep}}checkTerrainCollision(e){if(this.waterLevel>e.min.y)return!0;const t=`${this.planeStep.x},${this.planeStep.z}`,s=this.terrainPatches.get(t);return s?this.collisionCheckDetail(s,e,0):!1}noise(e,t){return se.perlin.noise(e.x,e.y,0)*t}terrainNoise(e,t,s){return this.noise(e.divideScalar(t),Vt*s)}noiseFunction(e){return this.terrainNoise(e,1,1)+this.terrainNoise(e,10,10)+this.terrainNoise(e,100,50)-5}applyTerrainNoise(e,t){const s=e.geometry.attributes.position,i=e.geometry.attributes.uv,n=new _e;for(let o=0;o<s.count;o++){n.fromBufferAttribute(i,o).add(t).multiplyScalar(Ct);const a=this.noiseFunction(n);s.setZ(o,a)}s.needsUpdate=!0}applyTerrainShader(e,t){const s=a=>{const[r,c,d]=Wt(a);return`vec3(${r}, ${c}, ${d})`},i="varying vec3 vPos;",n=`
      uniform float lim0;
      uniform float lim1;
      uniform float lim2;
      uniform float lim3;
      ${i}
    `,o=`
      vec3 col = vPos.y >= lim3 ? ${s(t.lim3.color)} :
                  vPos.y >= lim2 ? ${s(t.lim2.color)} :
                  vPos.y >= lim1 ? ${s(t.lim1.color)} :
                                  ${s(t.lim0.color)};
      vec4 diffuseColor = vec4(col, opacity);
    `;e.material=new J({side:H}),e.material.onBeforeCompile=a=>{Object.assign(a.uniforms,{lim0:t.lim0,lim1:t.lim1,lim2:t.lim2,lim3:t.lim3}),a.vertexShader=`
        ${i}
        ${a.vertexShader.replace("#include <begin_vertex>",`#include <begin_vertex>
vPos = vec3(position);`)}
      `,a.fragmentShader=`
        ${n}
        ${a.fragmentShader.replace("vec4 diffuseColor = vec4( diffuse, opacity );",o)}
      `}}addTerrain(e,t){const s=new Te(R,R,Re,Re),i=new F(s,this.assetManager.terrainMaterial);i.receiveShadow=!0,this.applyTerrainNoise(i,new _e(e,t)),s.rotateX(Math.PI/2),i.position.set(e,0,t).multiplyScalar(R),s.computeVertexNormals(),this.terrainObject3D.add(i),this.terrainPatches.set(`${e},${t}`,i),this.applyTerrainShader(i,Nt),this.populateTerrain(i)}populateTerrain(e){for(const t of this.populations)this.populateGroupMesh(e,t)}populateGroupMesh(e,t){const s=e.geometry.attributes.position,i=[];for(let n=0;n<s.count;n++)if(Math.random()>1-t.rarity){const o=new w;if(o.fromBufferAttribute(s,n),o.y+=t.offset,o.y-t.offset>t.min&&o.y<t.max&&se.perlin.noise(o.x/R+t.seed,o.z/R+t.seed,0)>=-.1){const a=t.randRot(),r=Math.random()/2+.5,c=E(r,r,r).multiplyScalar(t.scale);i.push(Ut(o,a,c))}}for(const n of t.group)e.add(qt(n,i))}fillTerrainBounds(e,t,s,i){for(let n=e;n<=s;n++)for(let o=t;o<=i;o++)this.existsTerrain(n,o)||this.addTerrain(n,o)}existsTerrain(e,t){return this.terrainPatches.has(`${e},${t}`)}removeTerrainBounds(e,t,s,i){const n=[];for(const o of this.terrainPatches.keys()){const[a,r]=o.split(",").map(Number);(a<e||a>s||r<t||r>i)&&n.push(this.terrainPatches.get(o))}for(const o of n){this.terrainObject3D.remove(o);const a=o.position.x/R+","+o.position.z/R;this.terrainPatches.delete(a)}}collisionCheckDetail(e,t,s){const i=e.geometry.attributes.position;for(let n=0;n<i.count;n++){const o=new w;if(o.fromBufferAttribute(i,n),e.localToWorld(o),o.y>t.min.y&&Xt(o.x,o.z,t.min.x-s,t.min.z-s,t.max.x+s,t.max.z+s))return!0}return!1}};p(se,"perlin",new es);let xe=se;const le=0,ts=1,ss=new w,He=new Ye,ye=new re,$e=new w,ae=new ft;class is{constructor(){this.tolerance=-1,this.faces=[],this.newFaces=[],this.assigned=new We,this.unassigned=new We,this.vertices=[]}setFromPoints(e){if(e.length>=4){this.makeEmpty();for(let t=0,s=e.length;t<s;t++)this.vertices.push(new ns(e[t]));this._compute()}return this}setFromObject(e){const t=[];return e.updateMatrixWorld(!0),e.traverse(function(s){const i=s.geometry;if(i!==void 0){const n=i.attributes.position;if(n!==void 0)for(let o=0,a=n.count;o<a;o++){const r=new w;r.fromBufferAttribute(n,o).applyMatrix4(s.matrixWorld),t.push(r)}}}),this.setFromPoints(t)}containsPoint(e){const t=this.faces;for(let s=0,i=t.length;s<i;s++)if(t[s].distanceToPoint(e)>this.tolerance)return!1;return!0}intersectRay(e,t){const s=this.faces;let i=-1/0,n=1/0;for(let o=0,a=s.length;o<a;o++){const r=s[o],c=r.distanceToPoint(e.origin),d=r.normal.dot(e.direction);if(c>0&&d>=0)return null;const h=d!==0?-c/d:0;if(!(h<=0)&&(d>0?n=Math.min(h,n):i=Math.max(h,i),i>n))return null}return i!==-1/0?e.at(i,t):e.at(n,t),t}intersectsRay(e){return this.intersectRay(e,ss)!==null}makeEmpty(){return this.faces=[],this.vertices=[],this}_addVertexToFace(e,t){return e.face=t,t.outside===null?this.assigned.append(e):this.assigned.insertBefore(t.outside,e),t.outside=e,this}_removeVertexFromFace(e,t){return e===t.outside&&(e.next!==null&&e.next.face===t?t.outside=e.next:t.outside=null),this.assigned.remove(e),this}_removeAllVerticesFromFace(e){if(e.outside!==null){const t=e.outside;let s=e.outside;for(;s.next!==null&&s.next.face===e;)s=s.next;return this.assigned.removeSubList(t,s),t.prev=s.next=null,e.outside=null,t}}_deleteFaceVertices(e,t){const s=this._removeAllVerticesFromFace(e);if(s!==void 0)if(t===void 0)this.unassigned.appendChain(s);else{let i=s;do{const n=i.next;t.distanceToPoint(i.point)>this.tolerance?this._addVertexToFace(i,t):this.unassigned.append(i),i=n}while(i!==null)}return this}_resolveUnassignedPoints(e){if(this.unassigned.isEmpty()===!1){let t=this.unassigned.first();do{const s=t.next;let i=this.tolerance,n=null;for(let o=0;o<e.length;o++){const a=e[o];if(a.mark===le){const r=a.distanceToPoint(t.point);if(r>i&&(i=r,n=a),i>1e3*this.tolerance)break}}n!==null&&this._addVertexToFace(t,n),t=s}while(t!==null)}return this}_computeExtremes(){const e=new w,t=new w,s=[],i=[];for(let n=0;n<3;n++)s[n]=i[n]=this.vertices[0];e.copy(this.vertices[0].point),t.copy(this.vertices[0].point);for(let n=0,o=this.vertices.length;n<o;n++){const a=this.vertices[n],r=a.point;for(let c=0;c<3;c++)r.getComponent(c)<e.getComponent(c)&&(e.setComponent(c,r.getComponent(c)),s[c]=a);for(let c=0;c<3;c++)r.getComponent(c)>t.getComponent(c)&&(t.setComponent(c,r.getComponent(c)),i[c]=a)}return this.tolerance=3*Number.EPSILON*(Math.max(Math.abs(e.x),Math.abs(t.x))+Math.max(Math.abs(e.y),Math.abs(t.y))+Math.max(Math.abs(e.z),Math.abs(t.z))),{min:s,max:i}}_computeInitialHull(){const e=this.vertices,t=this._computeExtremes(),s=t.min,i=t.max;let n=0,o=0;for(let l=0;l<3;l++){const f=i[l].point.getComponent(l)-s[l].point.getComponent(l);f>n&&(n=f,o=l)}const a=s[o],r=i[o];let c,d;n=0,He.set(a.point,r.point);for(let l=0,f=this.vertices.length;l<f;l++){const y=e[l];if(y!==a&&y!==r){He.closestPointToPoint(y.point,!0,$e);const g=$e.distanceToSquared(y.point);g>n&&(n=g,c=y)}}n=-1,ye.setFromCoplanarPoints(a.point,r.point,c.point);for(let l=0,f=this.vertices.length;l<f;l++){const y=e[l];if(y!==a&&y!==r&&y!==c){const g=Math.abs(ye.distanceToPoint(y.point));g>n&&(n=g,d=y)}}const h=[];if(ye.distanceToPoint(d.point)<0){h.push(I.create(a,r,c),I.create(d,r,a),I.create(d,c,r),I.create(d,a,c));for(let l=0;l<3;l++){const f=(l+1)%3;h[l+1].getEdge(2).setTwin(h[0].getEdge(f)),h[l+1].getEdge(1).setTwin(h[f+1].getEdge(0))}}else{h.push(I.create(a,c,r),I.create(d,a,r),I.create(d,r,c),I.create(d,c,a));for(let l=0;l<3;l++){const f=(l+1)%3;h[l+1].getEdge(2).setTwin(h[0].getEdge((3-l)%3)),h[l+1].getEdge(0).setTwin(h[f+1].getEdge(1))}}for(let l=0;l<4;l++)this.faces.push(h[l]);for(let l=0,f=e.length;l<f;l++){const y=e[l];if(y!==a&&y!==r&&y!==c&&y!==d){n=this.tolerance;let g=null;for(let m=0;m<4;m++){const P=this.faces[m].distanceToPoint(y.point);P>n&&(n=P,g=this.faces[m])}g!==null&&this._addVertexToFace(y,g)}}return this}_reindexFaces(){const e=[];for(let t=0;t<this.faces.length;t++){const s=this.faces[t];s.mark===le&&e.push(s)}return this.faces=e,this}_nextVertexToAdd(){if(this.assigned.isEmpty()===!1){let e,t=0;const s=this.assigned.first().face;let i=s.outside;do{const n=s.distanceToPoint(i.point);n>t&&(t=n,e=i),i=i.next}while(i!==null&&i.face===s);return e}}_computeHorizon(e,t,s,i){this._deleteFaceVertices(s),s.mark=ts;let n;t===null?n=t=s.getEdge(0):n=t.next;do{const o=n.twin,a=o.face;a.mark===le&&(a.distanceToPoint(e)>this.tolerance?this._computeHorizon(e,o,a,i):i.push(n)),n=n.next}while(n!==t);return this}_addAdjoiningFace(e,t){const s=I.create(e,t.tail(),t.head());return this.faces.push(s),s.getEdge(-1).setTwin(t.twin),s.getEdge(0)}_addNewFaces(e,t){this.newFaces=[];let s=null,i=null;for(let n=0;n<t.length;n++){const o=t[n],a=this._addAdjoiningFace(e,o);s===null?s=a:a.next.setTwin(i),this.newFaces.push(a.face),i=a}return s.next.setTwin(i),this}_addVertexToHull(e){const t=[];return this.unassigned.clear(),this._removeVertexFromFace(e,e.face),this._computeHorizon(e.point,null,e.face,t),this._addNewFaces(e,t),this._resolveUnassignedPoints(this.newFaces),this}_cleanup(){return this.assigned.clear(),this.unassigned.clear(),this.newFaces=[],this}_compute(){let e;for(this._computeInitialHull();(e=this._nextVertexToAdd())!==void 0;)this._addVertexToHull(e);return this._reindexFaces(),this._cleanup(),this}}class I{constructor(){this.normal=new w,this.midpoint=new w,this.area=0,this.constant=0,this.outside=null,this.mark=le,this.edge=null}static create(e,t,s){const i=new I,n=new we(e,i),o=new we(t,i),a=new we(s,i);return n.next=a.prev=o,o.next=n.prev=a,a.next=o.prev=n,i.edge=n,i.compute()}getEdge(e){let t=this.edge;for(;e>0;)t=t.next,e--;for(;e<0;)t=t.prev,e++;return t}compute(){const e=this.edge.tail(),t=this.edge.head(),s=this.edge.next.head();return ae.set(e.point,t.point,s.point),ae.getNormal(this.normal),ae.getMidpoint(this.midpoint),this.area=ae.getArea(),this.constant=this.normal.dot(this.midpoint),this}distanceToPoint(e){return this.normal.dot(e)-this.constant}}class we{constructor(e,t){this.vertex=e,this.prev=null,this.next=null,this.twin=null,this.face=t}head(){return this.vertex}tail(){return this.prev?this.prev.vertex:null}length(){const e=this.head(),t=this.tail();return t!==null?t.point.distanceTo(e.point):-1}lengthSquared(){const e=this.head(),t=this.tail();return t!==null?t.point.distanceToSquared(e.point):-1}setTwin(e){return this.twin=e,e.twin=this,this}}class ns{constructor(e){this.point=e,this.prev=null,this.next=null,this.face=null}}class We{constructor(){this.head=null,this.tail=null}first(){return this.head}last(){return this.tail}clear(){return this.head=this.tail=null,this}insertBefore(e,t){return t.prev=e.prev,t.next=e,t.prev===null?this.head=t:t.prev.next=t,e.prev=t,this}insertAfter(e,t){return t.prev=e,t.next=e.next,t.next===null?this.tail=t:t.next.prev=t,e.next=t,this}append(e){return this.head===null?this.head=e:this.tail.next=e,e.prev=this.tail,e.next=null,this.tail=e,this}appendChain(e){for(this.head===null?this.head=e:this.tail.next=e,e.prev=this.tail;e.next!==null;)e=e.next;return this.tail=e,this}remove(e){return e.prev===null?this.head=e.next:e.prev.next=e.next,e.next===null?this.tail=e.prev:e.next.prev=e.prev,this}removeSubList(e,t){return e.prev===null?this.head=t.next:e.prev.next=t.next,t.next===null?this.tail=e.prev:t.next.prev=e.prev,this}isEmpty(){return this.head===null}}class Ue extends ve{constructor(e=[]){super();const t=[],s=[],n=new is().setFromPoints(e).faces;for(let o=0;o<n.length;o++){const a=n[o];let r=a.edge;do{const c=r.head().point;t.push(c.x,c.y,c.z),s.push(a.normal.x,a.normal.y,a.normal.z),r=r.next}while(r!==a.edge)}this.setAttribute("position",new B(t,3)),this.setAttribute("normal",new B(s,3))}}const os=new w;class te{constructor(e=1.4,t=1e-4){this.minSizeForBreak=e,this.smallDelta=t,this.tempLine1=new Ye,this.tempPlane1=new re,this.tempPlane2=new re,this.tempPlane_Cut=new re,this.tempCM1=new w,this.tempCM2=new w,this.tempVector3=new w,this.tempVector3_2=new w,this.tempVector3_3=new w,this.tempVector3_P0=new w,this.tempVector3_P1=new w,this.tempVector3_P2=new w,this.tempVector3_N0=new w,this.tempVector3_N1=new w,this.tempVector3_AB=new w,this.tempVector3_CB=new w,this.tempResultObjects={object1:null,object2:null},this.segments=[];const s=30*30;for(let i=0;i<s;i++)this.segments[i]=!1}prepareBreakableObject(e,t,s,i,n){const o=e.userData;o.mass=t,o.velocity=s.clone(),o.angularVelocity=i.clone(),o.breakable=n}subdivideByImpact(e,t,s,i,n){const o=[],a=this.tempPlane1,r=this.tempPlane2;this.tempVector3.addVectors(t,s),a.setFromCoplanarPoints(t,e.position,this.tempVector3);const c=n+i,d=this;function h(l,f,y,g){if(Math.random()<g*.05||g>c){o.push(l);return}let m=Math.PI;g===0?(r.normal.copy(a.normal),r.constant=a.constant):g<=i?(m=(y-f)*(.2+.6*Math.random())+f,d.tempVector3_2.copy(e.position).sub(t).applyAxisAngle(s,m).add(t),r.setFromCoplanarPoints(t,d.tempVector3,d.tempVector3_2)):(m=(.5*(g&1)+.2*(2-Math.random()))*Math.PI,d.tempVector3_2.copy(t).sub(l.position).applyAxisAngle(s,m).add(l.position),d.tempVector3_3.copy(s).add(l.position),r.setFromCoplanarPoints(l.position,d.tempVector3_3,d.tempVector3_2)),d.cutByPlane(l,r,d.tempResultObjects);const P=d.tempResultObjects.object1,x=d.tempResultObjects.object2;P&&h(P,f,m,g+1),x&&h(x,m,y,g+1)}return h(e,0,2*Math.PI,0),o}cutByPlane(e,t,s){const i=e.geometry,n=i.attributes.position.array,o=i.attributes.normal.array,a=n.length/3;let r=a/3,c=i.getIndex();c&&(c=c.array,r=c.length/3);function d(v,b){const L=v*3+b;return c?c[L]:L}const h=[],l=[],f=this.smallDelta,y=a*a;for(let v=0;v<y;v++)this.segments[v]=!1;const g=this.tempVector3_P0,m=this.tempVector3_P1,P=this.tempVector3_N0,x=this.tempVector3_N1;for(let v=0;v<r-1;v++){const b=d(v,0),L=d(v,1),k=d(v,2);P.set(o[b],o[b]+1,o[b]+2);for(let C=v+1;C<r;C++){const _=d(C,0),z=d(C,1),ie=d(C,2);x.set(o[_],o[_]+1,o[_]+2),1-P.dot(x)<f&&(b===_||b===z||b===ie?L===_||L===z||L===ie?(this.segments[b*a+L]=!0,this.segments[L*a+b]=!0):(this.segments[k*a+b]=!0,this.segments[b*a+k]=!0):(L===_||L===z||L===ie)&&(this.segments[k*a+L]=!0,this.segments[L*a+k]=!0))}}const j=this.tempPlane_Cut;e.updateMatrix(),te.transformPlaneToLocalSpace(t,e.matrix,j);for(let v=0;v<r;v++){const b=d(v,0),L=d(v,1),k=d(v,2);for(let C=0;C<3;C++){const _=C===0?b:C===1?L:k,z=C===0?L:C===1?k:b;if(this.segments[_*a+z])continue;this.segments[_*a+z]=!0,this.segments[z*a+_]=!0,g.set(n[3*_],n[3*_+1],n[3*_+2]),m.set(n[3*z],n[3*z+1],n[3*z+2]);let G=0,Y=j.distanceToPoint(g);Y>f?(G=2,l.push(g.clone())):Y<-f?(G=1,h.push(g.clone())):(G=3,h.push(g.clone()),l.push(g.clone()));let Z=0;if(Y=j.distanceToPoint(m),Y>f?(Z=2,l.push(m.clone())):Y<-f?(Z=1,h.push(m.clone())):(Z=3,h.push(m.clone()),l.push(m.clone())),G===1&&Z===2||G===2&&Z===1){this.tempLine1.start.copy(g),this.tempLine1.end.copy(m);let K=new w;if(K=j.intersectLine(this.tempLine1,K),K===null)return console.error("Internal error: segment does not intersect plane."),s.segmentedObject1=null,s.segmentedObject2=null,0;h.push(K),l.push(K.clone())}}}const T=e.userData.mass*.5;this.tempCM1.set(0,0,0);let O=0;const M=h.length;if(M>0){for(let v=0;v<M;v++)this.tempCM1.add(h[v]);this.tempCM1.divideScalar(M);for(let v=0;v<M;v++){const b=h[v];b.sub(this.tempCM1),O=Math.max(O,b.x,b.y,b.z)}this.tempCM1.add(e.position)}this.tempCM2.set(0,0,0);let V=0;const U=l.length;if(U>0){for(let v=0;v<U;v++)this.tempCM2.add(l[v]);this.tempCM2.divideScalar(U);for(let v=0;v<U;v++){const b=l[v];b.sub(this.tempCM2),V=Math.max(V,b.x,b.y,b.z)}this.tempCM2.add(e.position)}let q=null,X=null,he=0;return M>4&&(q=new F(new Ue(h),e.material),q.position.copy(this.tempCM1),q.quaternion.copy(e.quaternion),this.prepareBreakableObject(q,T,e.userData.velocity,e.userData.angularVelocity,2*O>this.minSizeForBreak),he++),U>4&&(X=new F(new Ue(l),e.material),X.position.copy(this.tempCM2),X.quaternion.copy(e.quaternion),this.prepareBreakableObject(X,T,e.userData.velocity,e.userData.angularVelocity,2*V>this.minSizeForBreak),he++),s.object1=q,s.object2=X,he}static transformFreeVector(e,t){const s=e.x,i=e.y,n=e.z,o=t.elements;return e.x=o[0]*s+o[4]*i+o[8]*n,e.y=o[1]*s+o[5]*i+o[9]*n,e.z=o[2]*s+o[6]*i+o[10]*n,e}static transformFreeVectorInverse(e,t){const s=e.x,i=e.y,n=e.z,o=t.elements;return e.x=o[0]*s+o[1]*i+o[2]*n,e.y=o[4]*s+o[5]*i+o[6]*n,e.z=o[8]*s+o[9]*i+o[10]*n,e}static transformTiedVectorInverse(e,t){const s=e.x,i=e.y,n=e.z,o=t.elements;return e.x=o[0]*s+o[1]*i+o[2]*n-o[12],e.y=o[4]*s+o[5]*i+o[6]*n-o[13],e.z=o[8]*s+o[9]*i+o[10]*n-o[14],e}static transformPlaneToLocalSpace(e,t,s){s.normal.copy(e.normal),s.constant=e.constant;const i=te.transformTiedVectorInverse(e.coplanarPoint(os),t);te.transformFreeVectorInverse(s.normal,t),s.constant=-i.dot(s.normal)}}const Ze=new te;function as(u,e,t,s,i,n){const o=new Pe().setFromObject(u);!n.crashed&&i.checkTerrainCollision(o)&&Ke(u,e,t,s,!0,n);for(let a=n.shards.length-1;a>=0;a--){const r=n.shards[a];r.gVel-=.001,r.rotateX(r.cDir.x),r.rotateY(r.cDir.y),r.rotateZ(r.cDir.z),r.cDir.x*=.995,r.cDir.y*=.995,r.cDir.z*=.995,r.position.x+=r.cVel.x,r.position.y+=r.cVel.y+r.gVel,r.position.z+=r.cVel.z,r.time++,r.time>500&&(t.remove(r),n.shards.splice(a,1))}}function Ke(u,e,t,s,i,n){if(n.crashed)return;const o=E(1,.5,1),a=E(0,100,0),r=Ze.subdivideByImpact(e,o,a,1,5),c=()=>Math.random()*.1,d=()=>Math.random()*.5;n.clearShards();for(let h of r){const l=h;e.updateWorldMatrix(!0,!1),l.position.set(...Me(e.localToWorld(e.position.clone()))),t.add(l),l.cDir=E(c(),c(),c()),l.cVel=E(d(),d(),d()),l.gVel=.01,l.time=0,n.addShard(l)}n.shards.length>0&&(n.shards[0].cVel.y=.3),t.remove(u),n.setCrashed(!0),n.shards.length>0&&(s.position.set(0,0,0),n.shards[0].add(s)),setTimeout(()=>{document.getElementById("blackout").classList.remove("left"),document.getElementById("blackout").classList.remove("right"),setTimeout(()=>window.location.replace("/flight_ended.html"),1500)},3e3)}var Q=(u=>(u[u.DOGFIGHT=0]="DOGFIGHT",u[u.FREEFLIGHT=1]="FREEFLIGHT",u))(Q||{});class rs{constructor(){p(this,"assetManager");p(this,"soundManager");p(this,"inputManager");p(this,"cameraManager");p(this,"terrainManager");p(this,"playerPlane");p(this,"stand");p(this,"activeProjectiles",[]);p(this,"shards",[]);p(this,"flying",!1);p(this,"mode",Q.DOGFIGHT);p(this,"players",[]);p(this,"prev",-1);p(this,"crashed",!1);p(this,"scene");p(this,"renderer");p(this,"dirLight");p(this,"stats");p(this,"ammoCountEl",document.getElementById("ammo-count"));p(this,"menuEl",document.getElementById("menu"));p(this,"blackoutEl",document.getElementById("blackout"));p(this,"loadingEl",document.getElementById("loading"));p(this,"waitingEl",document.getElementById("waiting"));p(this,"ammoEl",document.getElementById("ammo"));p(this,"freeButtonEl",document.getElementById("freeflight"));p(this,"headingEl",document.getElementsByClassName("heading")[0]);p(this,"selectEl",document.getElementsByClassName("select")[0]);p(this,"onWindowResize",()=>{const e=window.innerWidth,t=window.innerHeight;this.renderer.setSize(e,t),this.cameraManager.handleResize(e,t)});p(this,"animate",()=>{if(this.stats.begin(),requestAnimationFrame(this.animate),this.flying){this.prev<0&&(this.prev=performance.now()-Ne);const e=Math.floor((performance.now()-this.prev)/Ne);if(e>1e3)this.prev=performance.now();else for(let t=0;t<e;t++){if(this.cameraManager.update(this.playerPlane,this.dirLight),this.inputManager.keyPressed(" ")){const i=this.cameraManager.getBaseLocalPosition(),n=this.playerPlane.fire(this.scene,i);this.activeProjectiles.push(...n),n.length>0&&this.ammoCountEl&&(this.soundManager.playShootingSound(this.playerPlane.mesh),this.ammoCountEl.innerText=this.playerPlane.getAmmo().toString())}this._updateActiveProjectiles(),as(this.playerPlane.mesh,this.playerPlane.collider,this.scene,this.cameraManager.getThreeCamera(),this.terrainManager,this),this.playerPlane.updatePhysics(),this.inputManager.handlePlaneKeys(this.playerPlane);const s=this.playerPlane.vel.local.length();this.soundManager.updatePlaneSound(s,this.playerPlane.mesh),this.mode===Q.FREEFLIGHT&&this.terrainManager.handleTerrainGeneration(this.playerPlane.getPosition()),this.prev=performance.now()}}else this.staticUpdate();this.renderer.render(this.scene,this.cameraManager.getThreeCamera()),this.stats.end()});const e=window.innerWidth,t=window.innerHeight;this.assetManager=new $t,this.inputManager=new Zt,this.cameraManager=new Yt(e,t),this.terrainManager=new xe(this.assetManager),this.soundManager=new Qt(this.cameraManager.getThreeCamera()),this.scene=new gt,this.scene.background=new qe(Ft),this.scene.fog=new yt(this.scene.background,ce*.5,ce),this.renderer=new wt({logarithmicDepthBuffer:!0}),this.renderer.setSize(e,t),this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=vt,document.body.appendChild(this.renderer.domElement),this.dirLight=new Pt(16777215,3),this.dirLight.position.set(1,1,1),this.dirLight.target.position.set(0,0,0),this.dirLight.castShadow=!0,this.dirLight.shadow.bias=-.01,this.dirLight.shadow.mapSize.width=2**13,this.dirLight.shadow.mapSize.height=2**13;const s=100;this.dirLight.shadow.camera.left=-100,this.dirLight.shadow.camera.right=s,this.dirLight.shadow.camera.top=s,this.dirLight.shadow.camera.bottom=-100,this.dirLight.shadow.camera.near=0,this.dirLight.shadow.camera.far=100;const i=new Mt(jt,3);this.scene.add(this.dirLight,this.dirLight.target,i,this.terrainManager.getTerrainObject3D(),this.terrainManager.getWaterMesh()),window.addEventListener("resize",this.onWindowResize),this.stand=new F(new xt(1,1,2,32),this.assetManager.standMaterial)}async initializeApp(){this.stats=new ee,this.stats.dom.style.visibility="hidden",document.body.appendChild(this.stats.dom);try{if(await this.assetManager.loadAllAssets(),await this.soundManager.loadAllSounds(),this.terrainManager.initializeInternalPopulations(),this.assetManager.planeMesh&&this.assetManager.planeMaterial){const e=this.assetManager.planeMesh.clone();this.playerPlane=new Jt(e,this.assetManager),this.scene.add(this.playerPlane.mesh),this.ammoCountEl&&(this.ammoCountEl.innerText=this.playerPlane.getAmmo().toString())}else throw new Error("CRITICAL: Player plane assets not loaded.");this.inputManager.setupGlobalInputListeners(),this.staticScene(),this.animate(),this.freeButtonEl&&(this.freeButtonEl.onclick=()=>this.enter(Q.FREEFLIGHT))}catch(e){console.error("Failed to initialize the application:",e),this.loadingEl&&(this.loadingEl.innerText="Error loading assets. Please refresh.")}}initGame(){this.menuEl&&(this.menuEl.style.display="none"),this.blackoutEl&&this.blackoutEl.classList.add("right"),this.loadingEl&&this.loadingEl.classList.remove("active"),this.waitingEl&&this.waitingEl.classList.remove("active"),this.playerPlane.setPosition(E(0,5,0)),this.playerPlane.setRotation(new $(0,0,0)),this.playerPlane.vel.local.z=-.1,this.playerPlane.mesh.add(this.cameraManager.getThreeCamera()),Ze.prepareBreakableObject(this.playerPlane.collider,1,E(0,0,0),E(0,0,0),!0),this.flying=!0,this.ammoEl&&this.ammoEl.classList.add("active")}staticScene(){this.menuEl&&(this.menuEl.style.display="flex"),this.blackoutEl&&this.blackoutEl.classList.add("left");const e=E(145,-2,0),t=this.cameraManager.getThreeCamera();this.cameraManager.setPosition(E(-1,.5,2).add(e)),this.cameraManager.setRotation(new $(0,-.1,0)),this.playerPlane.setRotation(new $(...W(E(t.rotation.x,t.rotation.y,t.rotation.z),E(-.1,Math.PI*.75,.1)))),this.playerPlane.mesh.remove(t),this.playerPlane.setPosition(E(0,0,0).add(e)),this.stand.position.set(...W(this.playerPlane.getPosition(),E(0,-1.45,0))),this.stand.castShadow=!0,this.stand.receiveShadow=!0,this.scene.add(this.stand);const s=this.playerPlane.getPosition();this.dirLight.target.position.set(s.x,10,s.z),this.dirLight.position.set(...W(this.dirLight.target.position,E(1,1,1))),this.terrainManager.handleTerrainGeneration(s),this.cameraManager.updateSavePosition()}staticUpdate(){const e=this.inputManager.getInputState(),t={x:e.mouse.x-window.innerWidth/2,y:e.mouse.y-window.innerHeight/2};this.cameraManager.updateStatic(t),this.headingEl&&(this.headingEl.style.transform=`translate(${t.x/100}px, ${t.y/100}px)`),this.selectEl&&(this.selectEl.style.transform=`translate(${t.x/200}px, ${t.y/200}px)`)}enter(e){this.blackoutEl&&(this.blackoutEl.classList.remove("left"),this.blackoutEl.classList.remove("right")),setTimeout(()=>{this.scene.remove(this.stand),this.mode=e,this.mode===Q.FREEFLIGHT&&this.initGame()},1e3)}_updateActiveProjectiles(){const e=[],t=this.playerPlane.mesh,s=this.playerPlane.collider,i=this.playerPlane.getPosition();for(const n of this.activeProjectiles){n.updateMovement();let o=!1;n.owner!==t&&!this.crashed&&n.checkCollisionWith(s)&&(Ke(t,s,this.scene,this.cameraManager.getThreeCamera(),!0,this),o=!0),!o&&n.isOutOfBounds(i)&&(o=!0),o?n.removeFromScene(this.scene):e.push(n)}this.activeProjectiles=e}setCrashed(e){this.crashed=e,e&&this.soundManager.playExplosionSound()}getPlayerBySid(e){return this.players.find(t=>t.sid===e)}addPlayer(e){this.players.push(e)}removePlayer(e){this.players=this.players.filter(t=>t.sid!==e)}addShard(e){this.shards.push(e)}clearShards(){this.shards=[]}}const ls=new rs;ls.initializeApp();
